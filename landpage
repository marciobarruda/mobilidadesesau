<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Portal do Servidor ‚Äî Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #004aad;
        --brand-secondary: #003579;
        --brand-highlight: #00a3ff;
        --surface: #ffffff;
        --surface-strong: #ffffff;
        --border-color: #d6deea;
        --text-strong: #1f2937;
        --text-muted: #4b5563;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", "Roboto", "Open Sans", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.9);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 500;
        margin-bottom: 2.5rem;
        padding: 1.2rem 1.6rem;
        border-radius: 18px;
        background: var(--surface-strong);
        color: var(--text-strong);
        border: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .user-greeting strong {
        color: var(--brand-secondary);
      }

      .card {
        border-radius: 16px;
        overflow: hidden;
        border: none;
      }

      .rounded-4 {
        border-radius: 16px !important;
      }

      .card-programa {
        border: 1px solid rgba(0, 74, 173, 0.08);
        border-radius: 16px;
        background: var(--surface-strong);
        box-shadow: 0 12px 32px rgba(15, 37, 78, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .card-programa:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(15, 37, 78, 0.12);
      }

      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 74, 173, 0.1);
        background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
        padding: 1.5rem 1.5rem 1.2rem;
      }

      .card-programa .card-body {
        padding: 1.5rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
        color: var(--brand-primary);
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 28px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .card-hero .card-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .card-hero .card-tag {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: #004aad;
        text-transform: uppercase;
      }

      .card-hero .card-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #004aad;
        margin: 0;
      }

      .card-hero .card-subtitle {
        font-size: 1rem;
        color: var(--text-muted);
        margin: 0;
      }

      .card-hero .card-list {
        padding-left: 1.1rem;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        color: var(--text-strong);
      }

      .card-hero .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .downloads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }

      .download-card {
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        border-radius: 4px;
        padding: 1.35rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 170px;
      }

      .collapsible-form {
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 16px;
        background: rgba(0, 83, 164, 0.06);
        padding: 1.25rem 1.5rem 0;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }

      .collapsible-form summary {
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        list-style: none;
        font-size: 1.05rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(0, 83, 164, 0.18);
        color: var(--brand-secondary);
      }

      .collapsible-form summary::marker,
      .collapsible-form summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-form summary::after {
        content: "";
        width: 12px;
        height: 12px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg);
        transition: transform 0.2s ease;
        margin-left: 1rem;
      }

      .collapsible-form[open] summary::after {
        transform: rotate(225deg);
      }

      .collapsible-form[open] {
        background: rgba(0, 83, 164, 0.08);
        padding-bottom: 1.5rem;
      }

      .collapsible-form[open] summary {
        margin-bottom: 1rem;
        border-bottom-color: rgba(0, 83, 164, 0.25);
      }

      .minhas-grid {
        margin-top: 1rem;
      }

      .minha-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 14px;
        background: #ffffff;
        box-shadow: 0 10px 24px rgba(0, 45, 98, 0.12);
        position: relative;
        padding: 1.1rem 1.25rem;
      }

      .minha-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        border: 2px solid transparent;
        transition: border-color 0.2s ease;
      }

      .minha-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 34px rgba(0, 45, 98, 0.16);
      }

      .minha-card:hover::after {
        border-color: rgba(0, 163, 255, 0.5);
      }

      .minhas-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .feedback-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(27, 38, 59, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1050;
      }
      .feedback-modal-backdrop.active { display: flex; }
      .feedback-modal {
        background: #ffffff;
        border-radius: 1.25rem;
        max-width: 980px;
        width: 100%;
        max-height: 88vh;
        box-shadow: 0 32px 68px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .feedback-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .feedback-modal-title {
        font-weight: 700;
        font-size: 1.35rem;
        margin-bottom: 0.35rem;
        color: var(--text-strong);
      }

      .feedback-modal-subtitle {
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .modal-meta {
        background: rgba(0, 83, 164, 0.08);
        border-radius: 14px;
        padding: 0.75rem 1.2rem;
        min-width: 220px;
        text-align: right;
      }

      .modal-meta-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--brand-secondary);
        font-weight: 700;
      }

      .modal-meta-value {
        display: block;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--brand-primary);
        margin-top: 0.25rem;
      }

      .feedback-modal-message {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-strong);
        overflow-y: auto;
        flex: 1;
      }

      .modal-table-wrapper {
        border-radius: 14px;
        border: 1px solid rgba(0, 83, 164, 0.12);
        background: #f8fbff;
        padding: 1rem;
      }

      .modal-table-wrapper table td:first-child {
        font-weight: 700;
        color: var(--brand-secondary);
      }

      .modal-actions {
        margin-top: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 0.75rem;
      }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      .btn-primary {
        background-color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-primary:hover,
      .btn-primary:focus {
        background-color: #004bd6;
        border-color: #004bd6;
      }

      .btn-outline-primary {
        color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-outline-primary:hover,
      .btn-outline-primary:focus {
        background-color: rgba(0, 98, 255, 0.08);
        color: #004bd6;
        border-color: #004bd6;
      }

      .btn-soft {
        background-color: #f5f5f5;
        color: var(--text-strong);
        border: 1px solid #e5e7eb;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-soft:hover,
      .btn-soft:focus {
        background-color: #e7e7e7;
        border-color: #d1d5db;
        color: var(--text-strong);
      }

      @media (max-width: 768px) {
        header.site-header { padding: 2.5rem 0 2rem; }
        .badge-open { width: 100%; justify-content: center; }
        .feedback-modal {
          padding: 1.5rem;
          max-height: 90vh;
        }
        .feedback-modal-header {
          flex-direction: column;
          align-items: stretch;
        }
        .modal-meta {
          text-align: left;
        }
      }

      /* Impress√£o apenas do conte√∫do do modal */
      @media print {
        body * { visibility: hidden !important; }
        .feedback-modal, .feedback-modal * { visibility: visible !important; }
        .feedback-modal { position: absolute; inset: 0; box-shadow: none; }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <span class="badge-open">Portal do Servidor ‚Ä¢ SESAU</span>
            <h1 class="h3 mt-3 mb-2">Mobilidade Interna & Servi√ßos</h1>
            <p class="lead mb-0">Acompanhe solicita√ß√µes, atualize seus dados e acesse orienta√ß√µes. Tudo em um s√≥ lugar, com a cara de Recife.</p>
          </div>
        </div>
      </div>
    </header>

    <main class="container py-4">
      <div class="user-greeting" id="saudacao">Ol√°, <strong>{{ $json.data.dadosComuns.nome }}!</strong> Este √© o seu painel de mobilidade interna.</div>

      <div class="row g-4">
        <!-- Card 1: Mobilidade Interna -->
        <section class="col-12 col-lg-5 col-xl-4">
          <div class="card card-programa card-hero h-100">
            <div class="card-body">
              <span class="card-tag">MOBILIDADE INTERNA</span>
              <h2 class="card-title">Solicita√ß√£o de Mobilidade (SESAU)</h2>
              <p class="card-subtitle">Fluxo eletr√¥nico para cadastrar e acompanhar pedidos de mobilidade.</p>
              <ul class="card-list">
                <li>Mobilidade interna a pedido, com crit√©rios definidos pela Portaria n¬∫ 127/2023.</li>
                <li>Pedidos registrados exclusivamente no sistema eletr√¥nico oficial.</li>
                <li>Validade de 12 meses, com necessidade de renova√ß√£o antes do vencimento.</li>
              </ul>
              <div class="card-actions">
                <form
                  id="novaSolicitacaoForm"
                  action="https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/f188b0f4-f4c9-455b-8dd9-e800c44b46e2"
                  method="post"
                  target="_blank"
                  class="d-inline"
                >
                  <input type="hidden" name="ds" id="novaSolicitacaoDs" />
                  <input type="hidden" name="grupo" id="novaSolicitacaoGrupo" />
                  <input type="hidden" name="cpf" id="novaSolicitacaoCpf" />
                  <button type="button" class="btn btn-primary" id="btnNovaSolicitacao">Nova solicita√ß√£o</button>
                </form>
                <a class="btn btn-outline-primary" href="#orientacoesContainer">Orienta√ß√µes</a>
              </div>
            </div>
          </div>
        </section>

        <!-- Card 2: Atualiza√ß√£o Cadastral -->
        <section class="col-12 col-lg-7 col-xl-8">
          <div class="card card-programa card-hero h-100">
            <div class="card-body">
              <span class="card-tag">ATUALIZA√á√ÉO CADASTRAL</span>
              <h2 class="card-title">Dados para contato e lota√ß√£o</h2>
              <p class="card-subtitle">Mantenha seus dados atualizados para agilizar an√°lises de mobilidade.</p>
              <details class="collapsible-form">
                <summary>Atualizar cadastro</summary>
                <form id="form-cadastro" class="pt-3" novalidate>
                  <div class="row g-3">
                    <!-- Matr√≠cula -->
                    <div class="col-12">
                      <label for="matriculaSelect" class="form-label">Matr√≠cula</label>
                      <select id="matriculaSelect" class="form-select" required></select>
                      <input type="hidden" id="grupoHidden" value="{{ $json.data.vinculos[0].grupo }}" />
                      <input type="hidden" id="cpfHidden" value="{{ $json.data.dadosComuns.cpf }}" />
                      <div class="invalid-feedback">Selecione uma matr√≠cula v√°lida.</div>
                    </div>

                    <!-- Contatos -->
                    <div class="col-12 col-md-6">
                      <label for="whatsapp" class="form-label">WhatsApp</label>
                      <input id="whatsapp" class="form-control" placeholder="(81) 9 9999-9999" />
                      <div class="invalid-feedback">Informe um WhatsApp v√°lido.</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="telefonealternativo" class="form-label">Telefone alternativo</label>
                      <input id="telefonealternativo" class="form-control" placeholder="(81) 3333-3333" />
                    </div>

                    <!-- Endere√ßo -->
                    <div class="col-12 col-sm-4">
                      <label for="cep" class="form-label">CEP</label>
                      <input id="cep" class="form-control" placeholder="00000-000" />
                      <div class="invalid-feedback">Informe um CEP v√°lido.</div>
                    </div>
                    <div class="col-12 col-sm-8">
                      <label for="logradouro" class="form-label">Logradouro</label>
                      <input id="logradouro" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-4">
                      <label for="numero" class="form-label">N√∫mero</label>
                      <input id="numero" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-8">
                      <label for="complemento" class="form-label">Complemento</label>
                      <input id="complemento" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-6">
                      <label for="bairro" class="form-label">Bairro</label>
                      <input id="bairro" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-4">
                      <label for="cidade" class="form-label">Cidade</label>
                      <input id="cidade" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-2">
                      <label for="uf" class="form-label">UF</label>
                      <input id="uf" class="form-control" maxlength="2" placeholder="PE" />
                      <div class="invalid-feedback">UF deve ter 2 letras.</div>
                    </div>

                    <!-- DS/Executiva -->
                    <div class="col-12 col-md-6">
                      <label for="dsSelect" class="form-label">DS/Executiva atual</label>
                      <select id="dsSelect" class="form-select" required>
                        <option value="" selected disabled>Selecione...</option>
                        <option>SEAA - JURIDICO</option>
                        <option>SEAB</option>
                        <option>DS II</option>
                        <option>DS I</option>
                        <option>DS IV</option>
                        <option>SECOGE</option>
                        <option>SEGTES</option>
                        <option>SEAF</option>
                        <option>SEINFRA</option>
                        <option>SEVS</option>
                        <option>DS III</option>
                        <option>DS VII</option>
                        <option>DS VI</option>
                        <option>DS VIII</option>
                        <option>DS V</option>
                        <option>GABINETE SESAU</option>
                        <option>SERMAC</option>
                      </select>
                      <div class="invalid-feedback">Selecione a DS/Executiva.</div>
                    </div>

                    <!-- Unidade/Turno/Regime (din√¢micos) -->
                    <div class="col-12 col-md-6">
                      <label for="unidadeSelect" class="form-label">Unidade atual</label>
                      <select id="unidadeSelect" class="form-select" disabled>
                        <option>Selecione a DS/Executiva...</option>
                      </select>
                      <div class="invalid-feedback">Selecione a Unidade.</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="turnoSelect" class="form-label">Turno atual</label>
                      <select id="turnoSelect" class="form-select" disabled>
                        <option>Selecione a Unidade...</option>
                      </select>
                      <div class="invalid-feedback">Selecione o Turno.</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="regimeSelect" class="form-label">Regime atual</label>
                      <select id="regimeSelect" class="form-select" disabled>
                        <option>Selecione a Unidade...</option>
                      </select>
                      <div class="invalid-feedback">Selecione o Regime.</div>
                    </div>

                    <div class="col-12">
                      <button type="submit" class="btn btn-primary">Enviar atualiza√ß√£o</button>
                      <span class="text-muted ms-2" id="formStatus" aria-live="polite"></span>
                    </div>
                  </div>
                </form>
              </details>
            </div>
          </div>
        </section>

        <!-- Card 3: Minhas Solicita√ß√µes -->
        <section class="col-12">
          <div class="card card-programa">
            <div class="card-header">
              <div class="section-title">Minhas solicita√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="minhasSolicitacoes" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 minhas-grid">
                <!-- Mini cards renderizados via JS -->
              </div>
              <div id="minhasPlaceholder" class="minhas-placeholder mt-3 d-none">Nenhum v√≠nculo encontrado.</div>
            </div>
          </div>
        </section>

        <!-- Card 4: Orienta√ß√µes -->
        <section class="col-12 col-lg-6">
          <div class="card card-programa h-100">
            <div class="card-header">
              <div class="section-title">Orienta√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="orientacoesContainer" class="small text-justify"></div>
            </div>
          </div>
        </section>

        <!-- Card 5: Publica√ß√µes -->
        <section class="col-12 col-lg-6">
          <div class="card card-programa h-100">
            <div class="card-header">
              <div class="section-title">Publica√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="publicacoesLista" class="downloads-grid"></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="container">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>¬© Prefeitura do Recife ‚Äî Secretaria de Sa√∫de</div>
        <div class="text-end">Portal do Servidor ‚Ä¢ Automa√ß√£o e Servi√ßos</div>
      </div>
    </footer>

    <!-- Modal custom (feedback) -->
    <div id="modalBackdrop" class="feedback-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="feedback-modal">
        <div class="feedback-modal-header">
          <div>
            <div class="feedback-modal-title">Comprovante de solicita√ß√£o</div>
            <div class="feedback-modal-subtitle">Solicita√ß√£o registrada em banco de dados para a matr√≠cula <strong>{{ $json.data.vinculos[0].matricula }}</strong></div>
          </div>
          <div class="modal-meta">
            <span class="modal-meta-label">N√∫mero da Solicita√ß√£o</span>
            <span class="modal-meta-value" id="modalNumeroSolicitacao">‚Äî</span>
          </div>
        </div>
        <div id="modalBody" class="feedback-modal-message"></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-success" id="btnSalvarPDF">Salvar em PDF</button>
          <button type="button" class="btn btn-primary" id="btnImprimir">Imprimir</button>
          <button type="button" class="btn btn-danger" id="btnFecharModal">Fechar</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      // ===== Helpers =====
      const postJSON = async (url, body) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        if (!res.ok) throw new Error('Erro de rede');
        return res.json();
      };

      const toBRDate = (iso) => {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d)) return '';
        return d.toLocaleDateString('pt-BR');
      };

      const setStatus = (msg, ok = true) => {
        const el = document.getElementById('formStatus');
        el.textContent = msg || '';
        el.className = ok ? 'text-success ms-2' : 'text-danger ms-2';
      };

      const sanitizeValue = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val).trim();
        return str === 'undefined' || str === 'null' ? '' : str;
      };

      const sanitizeUF = (val) => (val || '').toUpperCase().slice(0,2);
      const isUF = (val) => /^[A-Za-z]{2}$/.test(val || '');
      const isCEP = (val) => /^(\d{5}-?\d{3})$/.test(val || '');
      const isWhats = (val) => /^(\(\d{2}\)\s?)?(9)?\d{4}-?\d{4}$/.test((val || '').replace(/\s/g, ''));

      // Dados vindos do template (quando presentes)
      const DATA = {
        nome: sanitizeValue(`{{ $json.data.dadosComuns.nome }}`),
        cpf: sanitizeValue(`{{ $json.data.dadosComuns.cpf }}`),
        vinculos: [
          {
            matricula: sanitizeValue(`{{ $json.data.vinculos[0].matricula }}`),
            cargo: sanitizeValue(`{{ $json.data.vinculos[0].cargo }}`),
            grupo: sanitizeValue(`{{ $json.data.vinculos[0].grupo }}`)
          },
          {
            matricula: sanitizeValue(`{{ $json.data.vinculos[1].matricula }}`),
            cargo: sanitizeValue(`{{ $json.data.vinculos[1].cargo }}`),
            grupo: sanitizeValue(`{{ $json.data.vinculos[1].grupo }}`)
          }
        ],
        contatos: {
          whatsapp: sanitizeValue(`{{ $json.data.dadosComuns.whatsapp }}`),
          telalternativo: sanitizeValue(`{{ $json.data.dadosComuns.telalternativo }}`)
        },
        endereco: {
          cep: sanitizeValue(`{{ $json.data.dadosComuns.endereco.cep }}`),
          logradouro: sanitizeValue(`{{ $json.data.dadosComuns.endereco.logradouro }}`),
          numero: sanitizeValue(`{{ $json.data.dadosComuns.endereco.numero }}`),
          complemento: sanitizeValue(`{{ $json.data.dadosComuns.endereco.complemento }}`),
          bairro: sanitizeValue(`{{ $json.data.dadosComuns.endereco.bairro }}`),
          cidade: sanitizeValue(`{{ $json.data.dadosComuns.endereco.cidade }}`),
          uf: sanitizeValue(`{{ $json.data.dadosComuns.endereco.uf }}`)
        }
      };

      // ===== Inicializa√ß√£o dos campos =====
      function populateMatriculas() {
        const sel = document.getElementById('matriculaSelect');
        sel.innerHTML = '';
        const opts = [];
        const pushVinculoOption = (vinculo) => {
          if (!vinculo) return;
          const value = sanitizeValue(vinculo.matricula);
          if (!value) return;
          opts.push({
            value,
            text: value,
            grupo: sanitizeValue(vinculo.grupo)
          });
        };
        (DATA.vinculos || []).forEach(pushVinculoOption);
        if (opts.length === 0) {
          sel.innerHTML = '<option value="" disabled selected>Sem matr√≠culas dispon√≠veis</option>';
          sel.setAttribute('disabled', 'disabled');
        } else {
          sel.removeAttribute('disabled');
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Selecione...';
          placeholder.disabled = true;
          placeholder.selected = true;
          sel.appendChild(placeholder);
          opts.forEach((optionData) => {
            const option = document.createElement('option');
            option.value = optionData.value;
            option.textContent = optionData.text;
            if (optionData.grupo) option.dataset.grupo = optionData.grupo;
            sel.appendChild(option);
          });
        }
        const hiddenGrupo = document.getElementById('grupoHidden');
        if (hiddenGrupo) hiddenGrupo.value = sanitizeValue(hiddenGrupo.value);
        const hiddenCpf = document.getElementById('cpfHidden');
        if (hiddenCpf) hiddenCpf.value = DATA.cpf;
      }

      function populateContatosEndereco() {
        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v && v !== 'undefined' && v !== 'null') ? v : ''; };
        setVal('whatsapp', DATA.contatos.whatsapp);
        setVal('telefonealternativo', DATA.contatos.telalternativo);
        setVal('cep', DATA.endereco.cep);
        setVal('logradouro', DATA.endereco.logradouro);
        setVal('numero', DATA.endereco.numero);
        setVal('complemento', DATA.endereco.complemento);
        setVal('bairro', DATA.endereco.bairro);
        setVal('cidade', DATA.endereco.cidade);
        setVal('uf', sanitizeUF(DATA.endereco.uf));
      }

      function renderMinhasSolicitacoesCards() {
        const wrap = document.getElementById('minhasSolicitacoes');
        const placeholder = document.getElementById('minhasPlaceholder');
        wrap.innerHTML = '';
        const entries = DATA.vinculos.filter(v => v && v.matricula && v.matricula !== 'undefined' && v.matricula.trim() !== '');
        if (entries.length === 0) {
          placeholder.classList.remove('d-none');
          return;
        }
        placeholder.classList.add('d-none');
        entries.forEach((v, idx) => {
          const cargo = (v.cargo && v.cargo !== 'undefined') ? v.cargo : '';
          const card = document.createElement('div');
          card.className = 'col';
          card.innerHTML = `
            <div class="minha-card h-100">
              <div class="fw-bold mb-1">${v.matricula}</div>
              <div class="text-muted small">${cargo}</div>
            </div>
          `;
          card.querySelector('.minha-card').addEventListener('click', () => abrirRevisaoSolicitacao(v.matricula));
          wrap.appendChild(card);
        });
      }

      // ===== Encadeamento DS -> Unidade -> Turno/Regime =====
      async function loadUnidades(ds, grupoFromParam) {
        const sel = document.getElementById('unidadeSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        document.getElementById('turnoSelect').innerHTML = '<option>Selecione a Unidade...</option>';
        document.getElementById('turnoSelect').setAttribute('disabled', 'disabled');
        document.getElementById('regimeSelect').innerHTML = '<option>Selecione a Unidade...</option>';
        document.getElementById('regimeSelect').setAttribute('disabled', 'disabled');
        try {
          const hiddenGrupoInput = document.getElementById('grupoHidden');
          const resolvedGrupo = sanitizeValue(grupoFromParam ?? (hiddenGrupoInput ? hiddenGrupoInput.value : ''));
          const payload = { ds, grupo: resolvedGrupo || null };
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/unidades', payload);
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach(u => {
            if (u && u.unidade) sel.insertAdjacentHTML('beforeend', `<option value="${u.unidade}">${u.unidade}</option>`);
          });
          sel.removeAttribute('disabled');
        } catch (e) {
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadTurnos(unidade) {
        const sel = document.getElementById('turnoSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turnos', { unidade });
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach(t => { if (t && t.turno) sel.insertAdjacentHTML('beforeend', `<option>${t.turno}</option>`); });
          sel.removeAttribute('disabled');
        } catch (e) {
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadRegimes(unidade) {
        const sel = document.getElementById('regimeSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/regimes', { unidade });
          const regimes = [];
          const pushRegime = (value) => {
            if (!value || value === 'undefined') return;
            regimes.push(value);
          };
          if (Array.isArray(data)) {
            data.forEach(item => {
              if (typeof item === 'string') pushRegime(item);
              else if (item && typeof item === 'object') pushRegime(item.regime || item.nome || item.Regime);
            });
          } else if (data && typeof data === 'object') {
            if (Array.isArray(data.regimes)) data.regimes.forEach(pushRegime);
            if (Array.isArray(data.Regimes)) data.Regimes.forEach(pushRegime);
            if (Array.isArray(data.data)) data.data.forEach(pushRegime);
          }
          if (regimes.length) {
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            regimes.forEach(reg => sel.insertAdjacentHTML('beforeend', `<option>${reg}</option>`));
            sel.removeAttribute('disabled');
          } else {
            sel.innerHTML = '<option>Nenhum regime dispon√≠vel</option>';
          }
        } catch (e) {
          sel.innerHTML = '<option>N√£o foi poss√≠vel carregar os regimes</option>';
        }
      }

      // ===== Minhas Solicita√ß√µes -> Modal =====
      async function abrirRevisaoSolicitacao(matricula) {
        const backdrop = document.getElementById('modalBackdrop');
        const modalBody = document.getElementById('modalBody');
        document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
        modalBody.innerHTML = '<div class="text-muted">Carregando...</div>';
        backdrop.classList.add('active');
        backdrop.setAttribute('aria-hidden', 'false');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2', { matricula });
          if (!Array.isArray(data) || data.length === 0) {
            modalBody.innerHTML = '<div class="text-danger">Nenhum registro encontrado.</div>';
            return;
          }
          const numeroSolicitacao = data[0]?.protocolo || '';
          document.getElementById('modalNumeroSolicitacao').textContent = numeroSolicitacao || '‚Äî';
          const rows = data.map((it) => `
            <tr>
              <td class="text-center fw-semibold">${it.prioridade ?? ''}</td>
              <td>${it.matricula || ''}</td>
              <td>${it.cargo || ''}</td>
              <td>${it.distrito || ''}</td>
              <td>${it.lotacao || ''}</td>
              <td>${toBRDate(it.data_credenciamento)}</td>
              <td>${toBRDate(it.data_solicitacao)}</td>
            </tr>
          `).join('');
          modalBody.innerHTML = `
            <div class="table-responsive modal-table-wrapper">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th class="text-center">Prioridade</th>
                    <th>Matr√≠cula</th>
                    <th>Cargo</th>
                    <th>Distrito</th>
                    <th>Lota√ß√£o</th>
                    <th>Credenciamento</th>
                    <th>Solicita√ß√£o</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        } catch (e) {
          document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
          modalBody.innerHTML = '<div class="text-danger">Falha ao carregar dados da solicita√ß√£o.</div>';
        }
      }

      function gerarPdfModal() {
        const modalBody = document.getElementById('modalBody');
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert('N√£o foi poss√≠vel gerar o PDF no momento. Tente novamente mais tarde.');
          return;
        }
        const numero = (document.getElementById('modalNumeroSolicitacao').textContent || '').trim();
        const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
        const marginX = 48;
        const headerMargin = 60;
        let cursorY = headerMargin;

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(18);
        doc.text('Comprovante de solicita√ß√£o', marginX, cursorY);
        cursorY += 28;

        if (numero && numero !== '‚Äî') {
          doc.setFont('Helvetica', 'normal');
          doc.setFontSize(12);
          doc.text(`N√∫mero da Solicita√ß√£o: ${numero}`, marginX, cursorY);
          cursorY += 24;
        }

        const table = modalBody.querySelector('table');
        if (!table) {
          doc.setFontSize(12);
          doc.text('N√£o h√° dados para exportar.', marginX, cursorY);
          const safeNome = numero && numero !== '‚Äî' ? numero.replace(/[^\w-]+/g, '-') : 'detalhes';
          doc.save(`solicitacao-${safeNome}.pdf`);
          return;
        }

        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => Array.from(tr.children).map(td => td.textContent.trim()));

        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(11);
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const maxLineWidth = pageWidth - marginX * 2;

        const headerLine = doc.splitTextToSize(headers.join('  |  '), maxLineWidth);
        headerLine.forEach(line => {
          doc.text(line, marginX, cursorY);
          cursorY += 16;
        });

        doc.setFont('Helvetica', 'normal');
        rows.forEach(cols => {
          const line = cols.join('  |  ');
          const wrapped = doc.splitTextToSize(line, maxLineWidth);
          wrapped.forEach(segment => {
            if (cursorY > pageHeight - 60) {
              doc.addPage('a4', 'landscape');
              cursorY = headerMargin;
            }
            doc.text(segment, marginX, cursorY);
            cursorY += 16;
          });
          cursorY += 6;
        });

        const safeNumero = numero && numero !== '‚Äî' ? numero.replace(/[^\w-]+/g, '-') : 'detalhes';
        doc.save(`solicitacao-${safeNumero}.pdf`);
      }

      function fecharModal() {
        const backdrop = document.getElementById('modalBackdrop');
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = '';
        backdrop.classList.remove('active');
        backdrop.setAttribute('aria-hidden', 'true');
        document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
      }

      // ===== Orienta√ß√µes (TXT) =====
      function renderOrientacoes(texto) {
        const el = document.getElementById('orientacoesContainer');
        if (!texto) { el.textContent = 'Conte√∫do indispon√≠vel.'; return; }
        const parts = String(texto).split(/\n\n+/).map(p => `<p class="mb-2">${p.replace(/\n/g, '<br>')}</p>`);
        el.innerHTML = parts.join('');
      }

      // ===== Publica√ß√µes =====
      function renderPublicacoes(list) {
        const wrap = document.getElementById('publicacoesLista');
        wrap.innerHTML = '';
        (list || []).forEach((pub) => {
          const titulo = pub.titulo || 'Sem t√≠tulo';
          const descricao = pub.descricao || '';
          const url = pub.url || '#';
          const item = document.createElement('div');
          item.className = 'download-card';
          item.innerHTML = `
            <div class="fw-semibold"><a href="${url}" target="_blank" rel="noopener">${titulo}</a></div>
            <div class="text-muted small">${descricao}</div>
          `;
          wrap.appendChild(item);
        });
        if (!wrap.children.length) {
          wrap.innerHTML = '<div class="text-muted">Nenhuma publica√ß√£o dispon√≠vel.</div>';
        }
      }

      // ===== Valida√ß√£o simples do formul√°rio =====
      function validarFormulario() {
        let ok = true;
        const w = document.getElementById('whatsapp');
        const c = document.getElementById('cep');
        const uf = document.getElementById('uf');
        // Whats
        if (w.value && !isWhats(w.value)) { w.classList.add('is-invalid'); ok = false; } else { w.classList.remove('is-invalid'); w.classList.add('is-valid'); }
        // CEP
        if (c.value && !isCEP(c.value)) { c.classList.add('is-invalid'); ok = false; } else { c.classList.remove('is-invalid'); c.classList.add('is-valid'); }
        // UF
        uf.value = sanitizeUF(uf.value);
        if (uf.value && !isUF(uf.value)) { uf.classList.add('is-invalid'); ok = false; } else { uf.classList.remove('is-invalid'); uf.classList.add('is-valid'); }
        return ok;
      }

      // ===== Eventos =====
      document.getElementById('dsSelect').addEventListener('change', (e) => {
        const v = e.target.value;
        if (v) {
          const grupoAtual = sanitizeValue(document.getElementById('grupoHidden')?.value || '');
          loadUnidades(v, grupoAtual);
        }
      });

      document.getElementById('matriculaSelect').addEventListener('change', (e) => {
        const selected = e.target.selectedOptions[0];
        const grupoSelecionado = selected ? sanitizeValue(selected.dataset.grupo || '') : '';
        const hiddenGrupo = document.getElementById('grupoHidden');
        if (hiddenGrupo) hiddenGrupo.value = grupoSelecionado;
        const dsAtual = document.getElementById('dsSelect').value;
        if (dsAtual) loadUnidades(dsAtual, grupoSelecionado);
      });

      document.getElementById('unidadeSelect').addEventListener('change', (e) => {
        const unidade = e.target.value;
        if (unidade) {
          loadTurnos(unidade);
          loadRegimes(unidade);
        }
      });

      document.getElementById('form-cadastro').addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validarFormulario()) { setStatus('Revise os campos destacados.', false); return; }
        // Monte o payload final para envio (destino n√£o especificado no briefing)
        const grupoAtual = sanitizeValue(document.getElementById('grupoHidden')?.value || '');
        const payload = {
          matricula: document.getElementById('matriculaSelect').value || null,
          whatsapp: document.getElementById('whatsapp').value || null,
          telefonealternativo: document.getElementById('telefonealternativo').value || null,
          endereco: {
            cep: document.getElementById('cep').value || null,
            logradouro: document.getElementById('logradouro').value || null,
            numero: document.getElementById('numero').value || null,
            complemento: document.getElementById('complemento').value || null,
            bairro: document.getElementById('bairro').value || null,
            cidade: document.getElementById('cidade').value || null,
            uf: document.getElementById('uf').value || null,
          },
          ds: document.getElementById('dsSelect').value || null,
          unidade: document.getElementById('unidadeSelect').value || null,
          turno: document.getElementById('turnoSelect').value || null,
          regime: document.getElementById('regimeSelect').value || null,
          grupo: grupoAtual || null,
        };
        console.log('Payload atualiza√ß√£o cadastral:', payload);
        setStatus('Dados preparados para envio.', true);
      });

      document.getElementById('btnNovaSolicitacao').addEventListener('click', () => {
        const dsValue = sanitizeValue(document.getElementById('dsSelect')?.value || '');
        const matriculaValue = sanitizeValue(document.getElementById('matriculaSelect')?.value || '');
        if (!matriculaValue) {
          alert('Selecione uma matr√≠cula para continuar.');
          return;
        }
        if (!dsValue) {
          alert('Selecione a DS/Executiva atual para continuar.');
          return;
        }
        const grupoValue = sanitizeValue(document.getElementById('grupoHidden')?.value || '');
        const cpfValue = sanitizeValue(document.getElementById('cpfHidden')?.value || '');
        document.getElementById('novaSolicitacaoDs').value = dsValue;
        document.getElementById('novaSolicitacaoGrupo').value = grupoValue;
        document.getElementById('novaSolicitacaoCpf').value = cpfValue;
        const form = document.getElementById('novaSolicitacaoForm');
        if (form) form.submit();
      });

      document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
      document.getElementById('btnImprimir').addEventListener('click', () => window.print());
      document.getElementById('btnSalvarPDF').addEventListener('click', gerarPdfModal);
      document.getElementById('modalBackdrop').addEventListener('click', (e) => { if (e.target.id === 'modalBackdrop') fecharModal(); });

      // ===== Bootstrap inicial =====
      (function init() {
        populateMatriculas();
        populateContatosEndereco();
        renderMinhasSolicitacoesCards();
        // Orienta√ß√µes: use window.ORIENTACOES_TXT = '...'; em produ√ß√£o
        if (window.ORIENTACOES_TXT) renderOrientacoes(window.ORIENTACOES_TXT);
        else renderOrientacoes('Carregaremos aqui as orienta√ß√µes do processo.');
        // Publica√ß√µes: use window.PUBLICACOES = [{titulo, descricao, url}, ...]; em produ√ß√£o
        renderPublicacoes(window.PUBLICACOES || []);
      })();
    </script>
  </body>
</html>
