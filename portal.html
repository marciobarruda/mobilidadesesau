<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Portal do Servidor ‚Äî Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.9);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(0, 83, 164, 0.09), rgba(0, 163, 255, 0.12));
        color: var(--text-strong);
        box-shadow: 0 10px 30px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .card {
        border-radius: 4px;
        overflow: hidden;
      }

      .rounded-4 {
        border-radius: 4px !important;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        letter-spacing: 0.02em;
        color: var(--text-strong);
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        border-radius: 4px;
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .card-programa:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 38px rgba(0, 45, 98, 0.12);
      }

      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 83, 164, 0.08);
        background: linear-gradient(180deg, #ffffff 0%, #f5f8fc 100%);
        padding: 1.5rem 1.6rem 1.1rem;
        border-radius: 4px 4px 0 0;
      }

      .card-programa .card-body {
        padding: 1.6rem 1.6rem 1.75rem;
        border-radius: 0 0 4px 4px;
      }

      .downloads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }

      .download-card {
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        border-radius: 4px;
        padding: 1.35rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 170px;
      }

      .collapsible-form {
        border: 1px solid rgba(0, 83, 164, 0.15);
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        padding: 1rem 1.25rem;
      }

      .collapsible-form summary {
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        list-style: none;
      }

      .collapsible-form summary::marker,
      .collapsible-form summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-form summary::before {
        content: "‚ûï";
        font-size: 0.9rem;
        transition: transform 0.2s ease;
      }

      .collapsible-form[open] summary::before {
        transform: rotate(45deg);
      }

      .minhas-grid {
        margin-top: 1rem;
      }

      .minha-card {
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 4px;
      }

      .minha-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 45, 98, 0.12);
      }

      .minhas-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .feedback-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(27, 38, 59, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1050;
      }
      .feedback-modal-backdrop.active { display: flex; }
      .feedback-modal { 
        background: #ffffff; 
        border-radius: 1rem; 
        max-width: 860px; 
        width: 100%; 
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.18); 
        padding: 1.75rem; 
        margin: 0 auto; 
      }
      .feedback-modal-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-strong); }
      .feedback-modal-message { font-size: 0.95rem; line-height: 1.6; color: var(--text-strong); max-height: 60vh; overflow-y: auto; }
      .feedback-modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        header.site-header { padding: 2.5rem 0 2rem; }
        .badge-open { width: 100%; justify-content: center; }
      }
    </style>
  </head>
  <body>
    <!-- Campos ocultos (carregados junto √† carta) -->
    <input type="hidden" id="cpf" value="{{ $json.cpf }}" />

    <header class="site-header">
      <div class="container">
        <span class="badge-open">Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Prefeitura do Recife</span>
        <h1 class="display-6 fw-semibold mt-3">Portal do Servidor SESAU</h1>
        <p class="lead mt-2" id="resumo-mobilidade">
          A Portaria n¬∫ 127/2023 disciplina a mobilidade interna dos servidores da Secretaria de Sa√∫de do Recife, garantindo
          que as movimenta√ß√µes respeitem a carga hor√°ria do cargo, ocorram via sistema eletr√¥nico espec√≠fico e mantenham a
          continuidade da assist√™ncia. Os pedidos t√™m validade de 12 meses, devem ser renovados com anteced√™ncia e seguem
          prioridade pela ordem de protocolo, observadas as veda√ß√µes e crit√©rios definidos na norma.
        </p>
      </div>
    </header>

    <main class="container my-5">
      <p class="user-greeting">Ol√°, servidor(a)! Este √© o seu painel de mobilidade interna.</p>

      <!-- CARD: Mobilidade Interna -->
      <section class="mb-5">
        <div class="row g-4">
          <div class="col-lg-7">
            <article class="card card-programa">
              <div class="card-header">
                <span class="badge text-bg-light text-primary text-uppercase">Mobilidade interna</span>
                <h3 class="h5 mt-3 mb-1">Solicita√ß√£o de Mobilidade (SESAU)</h3>
                <p class="mb-0 text-muted">Fluxo eletr√¥nico para cadastrar e acompanhar pedidos de mobilidade.</p>
              </div>
              <div class="card-body">
                <ul class="mb-3 text-muted">
                  <li>Mobilidade interna <strong>a pedido</strong>, com crit√©rios definidos pela Portaria n¬∫ 127/2023.</li>
                  <li>Pedidos registrados exclusivamente no sistema eletr√¥nico oficial.</li>
                  <li>Validade de 12 meses, com necessidade de renova√ß√£o antes do vencimento.</li>
                </ul>

                <div class="d-flex flex-wrap gap-2">
                  <a class="btn btn-primary rounded-pill px-4 py-2" id="btn-nova-solicitacao" href="#" role="button">Nova solicita√ß√£o</a>
                  <a class="btn btn-outline-primary rounded-pill px-4 py-2" id="btn-ver-orientacoes" href="#orientacoes">Orienta√ß√µes</a>
                </div>
              </div>
            </article>
          </div>

          <!-- CARD: Atualiza√ß√£o cadastral (colapsado) -->
          <div class="col-lg-5">
            <article class="card card-programa">
              <div class="card-header">
                <span class="badge text-bg-light text-primary text-uppercase">Atualiza√ß√£o cadastral</span>
                <h3 class="h5 mt-3 mb-1">Dados para contato e lota√ß√£o</h3>
                <p class="mb-0 text-muted">Mantenha seus dados atualizados para agilizar an√°lises de mobilidade.</p>
              </div>
              <div class="card-body">
                <details class="collapsible-form">
                  <summary>Atualizar cadastro</summary>

                  <div class="mt-3">
                    <label class="form-label" for="sel-matricula">Matr√≠cula</label>
                    <select class="form-select" id="sel-matricula" required></select>
                    <div class="form-text">Selecione o v√≠nculo a atualizar.</div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="in-whatsapp">WhatsApp</label>
                      <input class="form-control" type="tel" id="in-whatsapp" inputmode="numeric" maxlength="11" placeholder="DDD + n√∫mero" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="in-telefone-alt">Telefone alternativo</label>
                      <input class="form-control" type="tel" id="in-telefone-alt" inputmode="numeric" maxlength="11" placeholder="DDD + n√∫mero" />
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-email">E-mail</label>
                    <input class="form-control" type="email" id="in-email" placeholder="nome@exemplo.com" autocomplete="email" />
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-cep">CEP</label>
                    <input class="form-control" type="text" id="in-cep" inputmode="numeric" maxlength="8" placeholder="00000000" />
                    <div class="form-text">Ao informar o CEP, os demais campos de endere√ßo ser√£o preenchidos automaticamente.</div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-8">
                      <label class="form-label" for="in-logradouro">Logradouro</label>
                      <input class="form-control" type="text" id="in-logradouro" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="in-numero">N√∫mero</label>
                      <input class="form-control" type="text" id="in-numero" />
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-complemento">Complemento</label>
                    <input class="form-control" type="text" id="in-complemento" />
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="in-bairro">Bairro</label>
                      <input class="form-control" type="text" id="in-bairro" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="in-cidade">Cidade</label>
                      <input class="form-control" type="text" id="in-cidade" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label" for="in-uf">UF</label>
                      <input class="form-control text-uppercase" type="text" id="in-uf" maxlength="2" />
                    </div>
                  </div>

                  <hr class="my-3" />

                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="sel-ds">DS/Executiva atual</label>
                      <select class="form-select" id="sel-ds"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="sel-unidade">Unidade atual</label>
                      <select class="form-select" id="sel-unidade"></select>
                    </div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="sel-turno">Turno atual</label>
                      <select class="form-select" id="sel-turno"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="sel-regime">Regime atual</label>
                      <select class="form-select" id="sel-regime"></select>
                    </div>
                  </div>

                  <button class="btn btn-outline-primary rounded-pill mt-3" id="btn-atualizar-cadastro" type="button" disabled>Enviar atualiza√ß√£o</button>
                </details>
              </div>
            </article>
          </div>
        </div>
      </section>

      <!-- Minhas Solicita√ß√µes -->
      <section class="mb-5" id="minhas-solicitacoes-section">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
          <h2 class="section-title mb-0">Minhas solicita√ß√µes</h2>
          <p class="text-muted small mb-0">Selecione uma solicita√ß√£o para visualizar o resumo.</p>
        </div>
        <div id="minhas-solicitacoes-loading" class="minhas-placeholder">
          Carregando solicita√ß√µes vinculadas ao CPF informado...
        </div>
        <div id="minhas-solicitacoes-empty" class="minhas-placeholder d-none">
          Nenhuma solicita√ß√£o encontrada.
        </div>
        <div id="minhas-solicitacoes-cards"
             class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 minhas-grid d-none"></div>
      </section>

      <!-- Orienta√ß√µes -->
      <section class="row g-4 align-items-start mb-5" id="orientacoes">
        <div class="col-lg-7">
          <h2 class="section-title mb-3">Orienta√ß√µes</h2>
          <ol class="list-group list-group-numbered shadow-sm">
            <li class="list-group-item">Cadastre seu pedido exclusivamente pelo sistema eletr√¥nico.</li>
            <li class="list-group-item">Mantenha dados de contato e lota√ß√£o atualizados.</li>
            <li class="list-group-item">Pedidos t√™m validade de 12 meses; renove com anteced√™ncia.</li>
            <li class="list-group-item">A prioridade segue a data de protocolo e demais crit√©rios da Portaria 127/2023.</li>
          </ol>
        </div>
        <div class="col-lg-5">
          <div class="p-4 bg-white rounded-4 border shadow-sm">
            <h3 class="h6 text-uppercase text-secondary fw-bold mb-3">Publica√ß√µes</h3>
            <ul class="list-unstyled mb-0" id="publicacoes-list">
              <li class="text-muted">Carregando publica√ß√µes...</li>
            </ul>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-white border-top">
      <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
        <span>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Prefeitura do Recife</span>
        <span class="text-muted">¬© 2025 ‚Ä¢ Gest√£o do Trabalho e Educa√ß√£o na Sa√∫de</span>
      </div>
    </footer>

    <!-- Modal -->
    <div class="feedback-modal-backdrop" id="feedback-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="feedback-modal">
        <h4 class="feedback-modal-title" id="feedback-modal-title">Detalhes</h4>
        <div class="feedback-modal-message" id="feedback-modal-message"></div>
        <div class="feedback-modal-actions" id="feedback-modal-actions">
          <button type="button" class="btn btn-secondary" id="feedback-modal-close">Fechar</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const cpf = (document.getElementById("cpf")?.value || "").replace(/\\D/g, "");
        const solicitacoesEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/cbda8a38-3a07-4b85-9d63-7ebda0294f6a";
        const solicitacaoDetalheEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2";
        const novaSolicitacaoEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/f188b0f4-f4c9-455b-8dd9-e800c44b46e2";
        const hierarquiaEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/d594b31c-8ca0-4cbe-a380-4e5112128402";
        const publicacoesEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/7b3f9046-f11b-4cc3-b570-c3e586748f6c";

        const atualizarCadastroEndpoint = ""; // ex.: "https://.../webhook/atualizar-cadastro"

        // UI helpers
        const modal = document.getElementById("feedback-modal");
        const modalTitle = document.getElementById("feedback-modal-title");
        const modalMessage = document.getElementById("feedback-modal-message");
        const modalActions = document.getElementById("feedback-modal-actions");
        const modalClose = document.getElementById("feedback-modal-close");
        const detalhesCache = new Map();
        const hierarquiaMapa = new Map();
        let resumoSolicitacaoAtual = null;
        let solicitacoesAtuais = [];

        const openModal = (title, html, actions = []) => {
          modalTitle.textContent = title || "Detalhes";
          modalMessage.innerHTML = html || "<p class='mb-0 text-muted'>Sem conte√∫do.</p>";
          if (modalActions) {
            while (modalActions.firstChild) modalActions.removeChild(modalActions.firstChild);
            (actions || []).forEach(btn => {
              if (btn) modalActions.appendChild(btn);
            });
            if (modalClose) modalActions.appendChild(modalClose);
          }
          modal.classList.add("active");
          modal.setAttribute("aria-hidden", "false");
          modalClose?.focus();
        };
        const closeModal = () => {
          modal.classList.remove("active");
          modal.setAttribute("aria-hidden", "true");
          resumoSolicitacaoAtual = null;
        };
        modalClose?.addEventListener("click", closeModal);
        modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
        document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

        const btnNovaSolicitacao = document.getElementById("btn-nova-solicitacao");
        const selMatricula = document.getElementById("sel-matricula");
        const selDistrito = document.getElementById("sel-ds");
        const selUnidade = document.getElementById("sel-unidade");
        const selTurno = document.getElementById("sel-turno");
        const selRegime = document.getElementById("sel-regime");
        const redirectPost = (url, data) => {
          if (!url) return;
          const form = document.createElement("form");
          form.method = "POST";
          form.action = url;
          form.style.display = "none";
          Object.entries(data || {}).forEach(([key, value]) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = typeof value === "string" ? value : JSON.stringify(value);
            form.appendChild(input);
          });
          document.body.appendChild(form);
          form.submit();
          setTimeout(() => form.remove(), 1000);
        };

        btnNovaSolicitacao?.addEventListener("click", (event) => {
          event.preventDefault();
          if (!cpf) {
            openModal("‚ö†Ô∏è CPF n√£o localizado", "<p>N√£o foi poss√≠vel identificar o CPF do servidor para iniciar a solicita√ß√£o.</p>");
            return;
          }
          redirectPost(novaSolicitacaoEndpoint, { cpf });
        });

        const normalizeText = (value) => (value ?? "").toString().trim();
        const escapeHtml = (value) => normalizeText(value).replace(/[&<>"']/g, (match) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        })[match] || match);
        const slugify = (value) => {
          const base = normalizeText(value);
          return base.normalize ? base.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : base.toLowerCase();
        };

        const setOptions = (select, list, placeholder) => {
          if (!select) return;
          const currentValue = select.value;
          select.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = placeholder || "Selecione...";
          select.appendChild(opt0);
          const options = (list || []).filter(Boolean);
          options.forEach(item => {
            const value = item?.value ?? item?.label ?? item;
            if (!value) return;
            const option = document.createElement("option");
            option.value = value;
            option.textContent = item?.label ?? value;
            option.dataset.key = item?.key || slugify(value);
            select.appendChild(option);
          });
          select.disabled = options.length === 0;
          if (options.some(item => (item?.value ?? item?.label ?? item) === currentValue)) {
            select.value = currentValue;
          } else {
            select.value = "";
          }
        };

        const formatarData = (valor) => {
          if (!valor) return "";
          const texto = normalizeText(valor);
          const iso = new Date(texto);
          if (!isNaN(iso)) return iso.toLocaleDateString("pt-BR");
          const partes = texto.match(/^([0-3]?\d)\/([0-1]?\d)\/(\d{4})$/);
          if (partes) {
            const [ , dia, mes, ano ] = partes;
            return `${dia.padStart(2,"0")}/${mes.padStart(2,"0")}/${ano}`;
          }
          return texto;
        };

        // CEP -> autopreencher
        const inCep = document.getElementById("in-cep");
        const inLogradouro = document.getElementById("in-logradouro");
        const inNumero = document.getElementById("in-numero");
        const inComplemento = document.getElementById("in-complemento");
        const inBairro = document.getElementById("in-bairro");
        const inCidade = document.getElementById("in-cidade");
        const inUf = document.getElementById("in-uf");
        const onlyDigits = (v) => (v || "").replace(/\\D/g, "");
        const brasilApiBase = "https://brasilapi.com.br/api/cep/v1/";
        let lastCep = "";
        let cepTimer = null;

        const sanitizeCep = () => {
          const cepVal = onlyDigits(inCep?.value).slice(0, 8);
          if (inCep && inCep.value !== cepVal) inCep.value = cepVal;
          return cepVal;
        };

        const preencherEndereco = (data) => {
          if (!data) return;
          const logradouro = data.street || data.logradouro;
          const bairro = data.neighborhood || data.bairro;
          const cidade = data.city || data.localidade || data.cidade;
          const estado = data.state || data.estado || data.uf;
          const complemento = data.complement || data.complemento;
          if (inLogradouro && logradouro) inLogradouro.value = String(logradouro).toUpperCase();
          if (inBairro && bairro) inBairro.value = String(bairro).toUpperCase();
          if (inCidade && cidade) inCidade.value = String(cidade).toUpperCase();
          if (inUf && estado) inUf.value = String(estado).toUpperCase();
          if (inComplemento && complemento && !inComplemento.value) inComplemento.value = String(complemento).toUpperCase();
        };

        const buscarCep = () => {
          const cepVal = sanitizeCep();
          if (cepVal.length !== 8 || cepVal === lastCep) {
            validateUpdateForm();
            return;
          }
          lastCep = cepVal;

          fetch(brasilApiBase + cepVal, { cache: "no-store" })
            .then(r => { if (!r.ok) throw new Error("CEP n√£o encontrado"); return r.json(); })
            .then(data => {
              preencherEndereco(data);
              validateUpdateForm();
            })
            .catch(() => {
              lastCep = "";
              openModal("‚ö†Ô∏è Aten√ß√£o", "<p>N√£o encontramos informa√ß√µes para o CEP informado. Voc√™ pode preencher os campos manualmente.</p>");
            });
        };

        inCep?.addEventListener("input", () => {
          const cepVal = sanitizeCep();
          if (cepTimer) clearTimeout(cepTimer);
          if (cepVal.length === 8) {
            cepTimer = setTimeout(buscarCep, 300);
          }
          validateUpdateForm();
        });
        inCep?.addEventListener("change", buscarCep);
        inCep?.addEventListener("blur", buscarCep);

        // Carregar publica√ß√µes
        fetch(publicacoesEndpoint)
          .then(r => r.json())
          .then(data => {
            const list = document.getElementById("publicacoes-list");
            list.innerHTML = "";
            const items = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
            if (!items.length) {
              list.innerHTML = "<li class='text-muted'>Nenhuma publica√ß√£o dispon√≠vel no momento.</li>";
              return;
            }
            const parseDate = (raw) => {
              if (!raw) return null;
              const d = new Date(raw);
              if (!isNaN(d)) return d;
              const m = String(raw).match(/^([0-3]?\\d)\\/([0-1]?\\d)\\/(\\d{4})$/);
              if (m) return new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
              return null;
            };
            const fmt = (d) => d?.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" }) || "";
            items.map(it => ({
              url: it.url,
              descricao: it.description || it.descricao || it.title || it.titulo,
              dt: parseDate(it.date || it.data || it.dt || it.createdAt)
            }))
            .filter(it => it.url && it.descricao)
            .sort((a,b) => (b.dt?.getTime()||0) - (a.dt?.getTime()||0))
            .forEach(it => {
              const li = document.createElement("li");
              li.className = "mb-2";
              const container = document.createElement("div");
              container.className = "d-flex flex-column flex-sm-row align-items-sm-center gap-2";
              if (it.dt) {
                const time = document.createElement("time");
                time.textContent = fmt(it.dt);
                time.dateTime = it.dt.toISOString();
                container.appendChild(time);
              }
              const a = document.createElement("a");
              a.href = it.url;
              a.rel = "noopener";
              a.className = "link-primary fw-semibold";
              a.textContent = "üìÑ " + it.descricao;
              container.appendChild(a);
              li.appendChild(container);
              list.appendChild(li);
            });
          })
          .catch(() => {
            const list = document.getElementById("publicacoes-list");
            if (list) list.innerHTML = "<li class='text-muted'>N√£o foi poss√≠vel carregar as publica√ß√µes.</li>";
          });

        // Minhas solicita√ß√µes
        const secMinhas = document.getElementById("minhas-solicitacoes-section");
        const grid = document.getElementById("minhas-solicitacoes-cards");
        const loadBox = document.getElementById("minhas-solicitacoes-loading");
        const emptyBox = document.getElementById("minhas-solicitacoes-empty");

        function setMinhasState(state) {
          loadBox?.classList.toggle("d-none", state !== "loading");
          emptyBox?.classList.toggle("d-none", state !== "empty");
          grid?.classList.toggle("d-none", state !== "ready");
        }

        function normalizeSolicitacoes(data) {
          let items = [];
          if (Array.isArray(data)) items = data;
          else if (Array.isArray(data?.items)) items = data.items;
          else if (Array.isArray(data?.data)) items = data.data;
          else if (Array.isArray(data?.result)) items = data.result;
          else if (data && typeof data === "object") items = [data];

          const mapa = new Map();
          items.forEach(entry => {
            const matricula = normalizeText(entry?.matricula || entry?.MATRICULA || entry?.id || entry?.titulo || "");
            if (!matricula) return;
            const cargo = normalizeText(entry?.cargo || entry?.CARGO || entry?.subtitulo || entry?.descricao || "");
            const atual = mapa.get(matricula) || { matricula, cargo: cargo || "Cargo n√£o informado" };
            if (!atual.cargo && cargo) atual.cargo = cargo;
            mapa.set(matricula, atual);
          });

          return Array.from(mapa.values());
        }

        function normalizarDetalhesSolicitacao(data, matriculaPadrao) {
          let items = [];
          if (Array.isArray(data)) items = data;
          else if (Array.isArray(data?.items)) items = data.items;
          else if (Array.isArray(data?.data)) items = data.data;
          else if (Array.isArray(data?.result)) items = data.result;
          else if (data && typeof data === "object") {
            items = [];
            Object.values(data).forEach(value => {
              if (Array.isArray(value)) items.push(...value);
              else items.push(value);
            });
          }

          return items
            .map(item => {
              if (!item || typeof item !== "object") return null;
              const matricula = normalizeText(item.matricula || item.MATRICULA || matriculaPadrao || "");
              if (!matricula) return null;
              const distrito = normalizeText(item.distrito || item.DISTRITO || item.ds || item.executiva || item["ds/executiva"] || "");
              const lotacao = normalizeText(item.lotacao || item.LOTACAO || item.unidade || item.local || item.descricao || "");
              const turno = normalizeText(item.turno || item.TURNO || "");
              const regime = normalizeText(item.regime || item.REGIME || "");
              const prioridadeRaw = item.prioridade ?? item.PRIORIDADE ?? item.ordem ?? item.ORDEM;
              const prioridadeNum = typeof prioridadeRaw === "number" ? prioridadeRaw : parseInt(prioridadeRaw, 10);
              const prioridade = Number.isFinite(prioridadeNum) ? prioridadeNum : "";
              const dataCredenciamento = item.data_credenciamento || item.dataCredenciamento || item.credenciamento || "";
              const dataSolicitacao = item.data_solicitacao || item.dataSolicitacao || item.solicitacao || item.data || "";
              const protocolo = normalizeText(item.protocolo || item.PROTOCOLO || "");
              return { matricula, distrito, lotacao, turno, regime, prioridade, dataCredenciamento, dataSolicitacao, protocolo };
            })
            .filter(Boolean);
        }

        function montarResumoSolicitacao(matricula, detalhes) {
          const protocolo = normalizeText(detalhes.find(item => item.protocolo)?.protocolo || "");
          const cabecalho = [
            `<p class="mb-1"><strong>Matr√≠cula:</strong> ${escapeHtml(matricula)}</p>`
          ];
          if (protocolo) {
            cabecalho.push(`<p class="mb-1"><strong>Protocolo:</strong> ${escapeHtml(protocolo)}</p>`);
          }
          cabecalho.push(`<p class="text-muted mb-2">Total de registros: ${detalhes.length}</p>`);

          const linhas = detalhes.map(item => {
            const prioridade = item.prioridade === "" || item.prioridade === null ? "-" : escapeHtml(String(item.prioridade));
            const distrito = escapeHtml(item.distrito || "-");
            const lotacao = escapeHtml(item.lotacao || "-");
            const turnoRegime = [item.turno, item.regime].map(normalizeText).filter(Boolean).map(escapeHtml).join(" ‚Ä¢ ");
            const dataSolic = escapeHtml(formatarData(item.dataSolicitacao));
            const dataCred = escapeHtml(formatarData(item.dataCredenciamento));
            const infoExtra = turnoRegime ? `<div class="small text-muted">${turnoRegime}</div>` : "";
            return `<tr><td class="text-center">${prioridade}</td><td>${distrito}</td><td><div class="fw-semibold">${lotacao}</div>${infoExtra}</td><td>${dataSolic}</td><td>${dataCred}</td></tr>`;
          }).join("") || `<tr><td colspan="5" class="text-center text-muted">Nenhum registro encontrado.</td></tr>`;

          const tabela = `<div class="table-responsive"><table class="table table-sm align-middle mb-0"><thead class="table-light"><tr><th class="text-center" style="width:110px">Prioridade</th><th style="width:140px">Distrito</th><th>Lota√ß√£o</th><th style="width:140px">Data solicita√ß√£o</th><th style="width:160px">Data credenciamento</th></tr></thead><tbody>${linhas}</tbody></table></div>`;

          return { html: `<div class="mb-3">${cabecalho.join("")}</div>${tabela}`, protocolo, detalhes };
        }

        const criarBotaoModal = (texto, classe, aoClicar) => {
          const botao = document.createElement("button");
          botao.type = "button";
          botao.className = classe;
          botao.textContent = texto;
          botao.addEventListener("click", aoClicar);
          return botao;
        };

        const imprimirResumoSolicitacao = (modo) => {
          if (!resumoSolicitacaoAtual?.html) {
            openModal("‚ÑπÔ∏è Nenhum resumo dispon√≠vel", "<p>Abra uma solicita√ß√£o antes de imprimir ou salvar em PDF.</p>");
            return;
          }
          const titulo = `${modo === "pdf" ? "Salvar PDF" : "Imprimir"} - Solicita√ß√£o ${resumoSolicitacaoAtual.matricula || ""}`.trim();
          const janela = window.open("", "_blank");
          if (!janela) {
            openModal("‚ö†Ô∏è Popup bloqueado", "<p>Permita pop-ups no navegador para gerar a impress√£o ou o PDF.</p>");
            return;
          }
          janela.document.write(`<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8" /><title>${escapeHtml(titulo)}</title><style>body{font-family:'Public Sans',Arial,sans-serif;padding:24px;color:#1b263b;}h1{font-size:1.25rem;margin-bottom:1rem;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #d0d7e2;padding:8px;vertical-align:top;}th{background:#f4f7fb;font-weight:600;} .text-center{text-align:center;} .fw-semibold{font-weight:600;} .small{font-size:0.85rem;color:#5b6c8c;}</style></head><body><h1>${escapeHtml(resumoSolicitacaoAtual.titulo || "Resumo da solicita√ß√£o")}</h1>${resumoSolicitacaoAtual.html}</body></html>`);
          janela.document.close();
          janela.focus();
          janela.print();
        };

        function exibirResumoSolicitacao(matricula, resumo) {
          if (!resumo) {
            openModal("‚ùå Erro", "<p>N√£o foi poss√≠vel exibir os dados desta solicita√ß√£o.</p>");
            return;
          }
          resumoSolicitacaoAtual = {
            ...resumo,
            matricula,
            titulo: `üìÑ Resumo da solicita√ß√£o ${matricula}`
          };
          const actions = [
            criarBotaoModal("Salvar PDF", "btn btn-primary", () => imprimirResumoSolicitacao("pdf")),
            criarBotaoModal("Imprimir", "btn btn-outline-primary", () => imprimirResumoSolicitacao("print"))
          ];
          openModal(resumoSolicitacaoAtual.titulo, resumo.html, actions);
        }

        function abrirResumoSolicitacao(matricula) {
          const matriculaLimpa = normalizeText(matricula);
          if (!matriculaLimpa) return;
          const emCache = detalhesCache.get(matriculaLimpa);
          if (emCache) {
            exibirResumoSolicitacao(matriculaLimpa, emCache);
            return;
          }

          resumoSolicitacaoAtual = null;
          openModal("‚è≥ Carregando detalhes", `<p>Buscando informa√ß√µes da matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>...</p>`);
          fetch(solicitacaoDetalheEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ matricula: matriculaLimpa, cpf })
          })
            .then(r => { if (!r.ok) throw new Error("Falha na consulta"); return r.json(); })
            .then(data => {
              const detalhes = normalizarDetalhesSolicitacao(data, matriculaLimpa);
              if (!detalhes.length) {
                openModal("‚ÑπÔ∏è Sem registros", `<p>N√£o encontramos informa√ß√µes detalhadas para a matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>.</p>`);
                return;
              }
              const resumo = montarResumoSolicitacao(matriculaLimpa, detalhes);
              detalhesCache.set(matriculaLimpa, resumo);
              exibirResumoSolicitacao(matriculaLimpa, resumo);
            })
            .catch(() => {
              openModal("‚ùå Erro", `<p>N√£o foi poss√≠vel carregar o resumo da matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>. Tente novamente.</p>`);
            });
        }

        function renderSolicitacoes(entries) {
          solicitacoesAtuais = Array.isArray(entries) ? entries : [];
          grid.innerHTML = "";

          const matriculaOptions = Array.from(new Map(
            solicitacoesAtuais
              .filter(item => item.matricula)
              .map(item => [item.matricula, { value: item.matricula, label: item.matricula }])
          ).values());
          setOptions(selMatricula, matriculaOptions, "Selecione a matr√≠cula");

          solicitacoesAtuais.forEach(entry => {
            const col = document.createElement("div");
            col.className = "col";

            const card = document.createElement("article");
            card.className = "card h-100 shadow-sm minha-card";
            card.setAttribute("role", "button");
            card.setAttribute("tabindex", "0");
            card.setAttribute("aria-label", "Solicita√ß√£o da matr√≠cula " + entry.matricula);
            card.dataset.matricula = entry.matricula;

            const body = document.createElement("div");
            body.className = "card-body";
            const title = document.createElement("h3");
            title.className = "h6 fw-semibold text-primary mb-1";
            title.textContent = entry.matricula;
            const sub = document.createElement("p");
            sub.className = "text-muted mb-0";
            sub.textContent = entry.cargo || "Cargo n√£o informado";

            body.appendChild(title);
            body.appendChild(sub);
            card.appendChild(body);

            const abrir = () => abrirResumoSolicitacao(entry.matricula);
            card.addEventListener("click", abrir);
            card.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                abrir();
              }
            });

            col.appendChild(card);
            grid.appendChild(col);
          });

          setMinhasState(solicitacoesAtuais.length ? "ready" : "empty");
          if (!solicitacoesAtuais.length) {
            setOptions(selMatricula, [], "Selecione a matr√≠cula");
          }
          validateUpdateForm();
        }

        function carregarMinhasSolicitacoes() {
          if (!cpf) {
            solicitacoesAtuais = [];
            setOptions(selMatricula, [], "Selecione a matr√≠cula");
            setMinhasState("empty");
            validateUpdateForm();
            return;
          }
          setMinhasState("loading");
          fetch(solicitacoesEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpf })
          })
            .then(r => { if (!r.ok) throw new Error("Falha na consulta"); return r.json(); })
            .then(data => renderSolicitacoes(normalizeSolicitacoes(data)))
            .catch(() => {
              solicitacoesAtuais = [];
              setOptions(selMatricula, [], "Selecione a matr√≠cula");
              if (emptyBox) emptyBox.textContent = "N√£o foi poss√≠vel carregar suas solicita√ß√µes. Tente novamente mais tarde.";
              setMinhasState("empty");
              validateUpdateForm();
            });
        }

        function normalizarHierarquiaCadastro(data) {
          let items = [];
          if (Array.isArray(data)) items = data;
          else if (Array.isArray(data?.items)) items = data.items;
          else if (Array.isArray(data?.data)) items = data.data;
          else if (Array.isArray(data?.result)) items = data.result;
          else if (data && typeof data === "object") {
            items = [];
            Object.values(data).forEach(value => {
              if (Array.isArray(value)) items.push(...value);
              else items.push(value);
            });
          }

          return items
            .map(item => {
              if (!item || typeof item !== "object") return null;
              const distrito = normalizeText(item.distrito || item.ds || item.executiva || item["ds/executiva"] || item.DISTRITO || "");
              const lotacao = normalizeText(item.lotacao || item.unidade || item.local || item.LOTACAO || "");
              const turno = normalizeText(item.turno || item.TURNO || "");
              const regime = normalizeText(item.regime || item.REGIME || "");
              if (!distrito || !lotacao) return null;
              return { distrito, lotacao, turno, regime };
            })
            .filter(Boolean);
        }

        function adicionarRegistroHierarquia(registro) {
          const dsKey = slugify(registro?.distrito);
          if (!dsKey) return;
          if (!hierarquiaMapa.has(dsKey)) {
            hierarquiaMapa.set(dsKey, { label: registro.distrito, lotacoes: new Map() });
          }
          const dsItem = hierarquiaMapa.get(dsKey);
          const lotKey = slugify(registro.lotacao);
          if (!lotKey) return;
          if (!dsItem.lotacoes.has(lotKey)) {
            dsItem.lotacoes.set(lotKey, { label: registro.lotacao, turnos: new Map() });
          }
          const lotItem = dsItem.lotacoes.get(lotKey);
          const turnoLabel = registro.turno || (registro.regime ? "N√£o informado" : "");
          if (turnoLabel) {
            const turnoKey = slugify(turnoLabel);
            if (!lotItem.turnos.has(turnoKey)) {
              lotItem.turnos.set(turnoKey, { label: turnoLabel, regimes: new Set() });
            }
            if (registro.regime) {
              lotItem.turnos.get(turnoKey).regimes.add(registro.regime);
            }
          }
        }

        function atualizarLotacoes() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotOptions = dsItem ? Array.from(dsItem.lotacoes.values()).map(lot => ({ value: lot.label, label: lot.label })) : [];
          setOptions(selUnidade, lotOptions, "Selecione a unidade atual");
          setOptions(selTurno, [], "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");
          validateUpdateForm();
        }

        function atualizarTurnos() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotItem = dsItem?.lotacoes.get(slugify(selUnidade?.value));
          const turnoOptions = lotItem ? Array.from(lotItem.turnos.values()).map(turno => ({ value: turno.label, label: turno.label })) : [];
          setOptions(selTurno, turnoOptions, "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");
          validateUpdateForm();
        }

        function atualizarRegimes() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotItem = dsItem?.lotacoes.get(slugify(selUnidade?.value));
          const turnoItem = lotItem?.turnos.get(slugify(selTurno?.value));
          const regimes = turnoItem ? Array.from(turnoItem.regimes).filter(Boolean) : [];
          const regimeOptions = regimes.map(reg => ({ value: reg, label: reg }));
          setOptions(selRegime, regimeOptions, "Selecione o regime atual");
          validateUpdateForm();
        }

        function carregarDadosIniciais() {
          setOptions(selDistrito, [], "Selecione a DS/Executiva atual");
          setOptions(selUnidade, [], "Selecione a unidade atual");
          setOptions(selTurno, [], "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");

          if (!hierarquiaEndpoint) {
            validateUpdateForm();
            return;
          }

          fetch(hierarquiaEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cpf })
          })
            .then(r => { if (!r.ok) throw new Error("Falha na consulta"); return r.json(); })
            .then(data => {
              hierarquiaMapa.clear();
              normalizarHierarquiaCadastro(data).forEach(adicionarRegistroHierarquia);
              const dsOptions = Array.from(hierarquiaMapa.values())
                .map(item => ({ value: item.label, label: item.label }))
                .sort((a, b) => a.label.localeCompare(b.label, "pt-BR"));
              setOptions(selDistrito, dsOptions, "Selecione a DS/Executiva atual");
              atualizarLotacoes();
            })
            .catch(() => {
              hierarquiaMapa.clear();
              setOptions(selDistrito, [], "Selecione a DS/Executiva atual");
              setOptions(selUnidade, [], "Selecione a unidade atual");
              setOptions(selTurno, [], "Selecione o turno atual");
              setOptions(selRegime, [], "Selecione o regime atual");
            })
            .finally(() => {
              validateUpdateForm();
            });
        }

        selDistrito?.addEventListener("change", atualizarLotacoes);
        selUnidade?.addEventListener("change", atualizarTurnos);
        selTurno?.addEventListener("change", atualizarRegimes);

        // Valida√ß√£o simples do formul√°rio de atualiza√ß√£o
        const btnAtualizar = document.getElementById("btn-atualizar-cadastro");
        const inWhats = document.getElementById("in-whatsapp");
        const inTelAlt = document.getElementById("in-telefone-alt");
        const inEmail = document.getElementById("in-email");
        const only11 = (v) => onlyDigits(v).slice(0, 11);
        function validateUpdateForm() {
          if (inWhats) inWhats.value = only11(inWhats.value);
          if (inTelAlt) inTelAlt.value = only11(inTelAlt.value);
          if (inCep) inCep.value = onlyDigits(inCep.value).slice(0,8);

          const emailOk = !!(inEmail?.value && /.+@.+\..+/.test(inEmail.value));
          const wppOk = !!(inWhats?.value && inWhats.value.length === 11);
          const cepOk = !!(inCep?.value && inCep.value.length === 8);
          const matOk = !!selMatricula?.value;
          const dsOk = !!selDistrito?.value;
          const unOk = !!selUnidade?.value;
          const turnoOk = !!selTurno?.value;
          const regimeOk = !!selRegime?.value;

          btnAtualizar.disabled = !(emailOk && wppOk && cepOk && matOk && dsOk && unOk && turnoOk && regimeOk);
        }
        [ "input","change","blur" ].forEach(evt => {
          inWhats?.addEventListener(evt, validateUpdateForm);
          inTelAlt?.addEventListener(evt, validateUpdateForm);
          inEmail?.addEventListener(evt, validateUpdateForm);
          inCep?.addEventListener(evt, validateUpdateForm);
          inLogradouro?.addEventListener(evt, validateUpdateForm);
          inNumero?.addEventListener(evt, validateUpdateForm);
          inComplemento?.addEventListener(evt, validateUpdateForm);
          inBairro?.addEventListener(evt, validateUpdateForm);
          inCidade?.addEventListener(evt, validateUpdateForm);
          inUf?.addEventListener(evt, validateUpdateForm);
          [selMatricula, selDistrito, selUnidade, selTurno, selRegime].forEach(el => {
            el?.addEventListener(evt, validateUpdateForm);
          });
        });

        btnAtualizar?.addEventListener("click", function () {
          const payload = {
            cpf,
            matricula: selMatricula?.value || "",
            whatsapp: inWhats?.value || "",
            telefoneAlternativo: inTelAlt?.value || "",
            email: inEmail?.value || "",
            cep: inCep?.value || "",
            logradouro: inLogradouro?.value || "",
            numero: inNumero?.value || "",
            complemento: inComplemento?.value || "",
            bairro: inBairro?.value || "",
            cidade: inCidade?.value || "",
            uf: (inUf?.value || "").toUpperCase(),
            dsExecutiva: selDistrito?.value || "",
            unidade: selUnidade?.value || "",
            turno: selTurno?.value || "",
            regime: selRegime?.value || ""
          };

          if (!atualizarCadastroEndpoint) {
            openModal("‚úÖ Sucesso (demo)",
              "<p>Os dados seriam enviados para a API definida em <code>atualizarCadastroEndpoint</code>.</p>" +
              "<pre class='mb-0' style='white-space:pre-wrap;background:#f6f8fb;border-radius:.5rem;padding:.5rem'>" +
              JSON.stringify(payload, null, 2) + "</pre>"
            );
            return;
          }

          fetch(atualizarCadastroEndpoint, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)})
            .then(r => r.json().catch(() => ({})))
            .then(resp => openModal("‚úÖ Sucesso", "<pre class='mb-0' style='white-space:pre-wrap;background:#f6f8fb;border-radius:.5rem;padding:.5rem'>" + JSON.stringify(resp, null, 2) + "</pre>"))
            .catch(() => openModal("‚ùå Erro", "<p>N√£o foi poss√≠vel enviar a atualiza√ß√£o. Tente novamente.</p>"));
        });

        // Inicializa√ß√µes
        carregarDadosIniciais();
        carregarMinhasSolicitacoes();
        validateUpdateForm();
      });
    </script>
  </body>
</html>
