<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Portal do Servidor ‚Äî Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.9);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        background: linear-gradient(135deg, rgba(0, 83, 164, 0.09), rgba(0, 163, 255, 0.12));
        color: var(--text-strong);
        box-shadow: 0 10px 30px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .card {
        border-radius: 4px;
        overflow: hidden;
      }

      .rounded-4 {
        border-radius: 4px !important;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        letter-spacing: 0.02em;
        color: var(--text-strong);
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        border-radius: 4px;
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .card-programa:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 38px rgba(0, 45, 98, 0.12);
      }

      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 83, 164, 0.08);
        background: linear-gradient(180deg, #ffffff 0%, #f5f8fc 100%);
        padding: 1.5rem 1.6rem 1.1rem;
        border-radius: 4px 4px 0 0;
      }

      .card-programa .card-body {
        padding: 1.6rem 1.6rem 1.75rem;
        border-radius: 0 0 4px 4px;
      }

      .downloads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }

      .download-card {
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        border-radius: 4px;
        padding: 1.35rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 170px;
      }

      .collapsible-form {
        border: 1px solid rgba(0, 83, 164, 0.15);
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        padding: 1rem 1.25rem;
      }

      .collapsible-form summary {
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        list-style: none;
      }

      .collapsible-form summary::marker,
      .collapsible-form summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-form summary::before {
        content: "‚ûï";
        font-size: 0.9rem;
        transition: transform 0.2s ease;
      }

      .collapsible-form[open] summary::before {
        transform: rotate(45deg);
      }

      .minhas-grid {
        margin-top: 1rem;
      }

      .minha-card {
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease;
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 4px;
      }

      .minha-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 45, 98, 0.12);
      }

      .minhas-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .feedback-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(27, 38, 59, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1050;
      }
      .feedback-modal-backdrop.active { display: flex; }
      .feedback-modal { 
        background: #ffffff; 
        border-radius: 1rem; 
        max-width: 860px; 
        width: 100%; 
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.18); 
        padding: 1.75rem; 
        margin: 0 auto; 
      }
      .feedback-modal-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-strong); }
      .feedback-modal-message { font-size: 0.95rem; line-height: 1.6; color: var(--text-strong); max-height: 60vh; overflow-y: auto; }
      .feedback-modal-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        header.site-header { padding: 2.5rem 0 2rem; }
        .badge-open { width: 100%; justify-content: center; }
      }
    </style>
  </head>
  <body>
    <!-- Campos ocultos (carregados junto √† carta) -->
    <input type="hidden" id="cpf" value="{{ $json.data.dadosComuns.cpf || '' }}" />
    <script id="portal-template-data" type="application/json">
      {{ JSON.stringify($json) }}
    </script>

    <header class="site-header">
      <div class="container">
        <span class="badge-open">Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Prefeitura do Recife</span>
        <h1 class="display-6 fw-semibold mt-3">Portal do Servidor SESAU</h1>
        <p class="lead mt-2" id="resumo-mobilidade">
          A Portaria n¬∫ 127/2023 disciplina a mobilidade interna dos servidores da Secretaria de Sa√∫de do Recife, garantindo
          que as movimenta√ß√µes respeitem a carga hor√°ria do cargo, ocorram via sistema eletr√¥nico espec√≠fico e mantenham a
          continuidade da assist√™ncia. Os pedidos t√™m validade de 12 meses, devem ser renovados com anteced√™ncia e seguem
          prioridade pela ordem de protocolo, observadas as veda√ß√µes e crit√©rios definidos na norma.
        </p>
      </div>
    </header>

    <main class="container my-5">
      <p class="user-greeting">
        Ol√°, <strong>{{ $json.data.dadosComuns.nome }}</strong>! Este √© o seu painel de mobilidade interna.
      </p>

      <!-- CARD: Mobilidade Interna -->
      <section class="mb-5">
        <div class="row g-4">
          <div class="col-lg-4">
            <article class="card card-programa">
              <div class="card-header">
                <span class="badge text-bg-light text-primary text-uppercase">Mobilidade interna</span>
                <h3 class="h5 mt-3 mb-1">Solicita√ß√£o de Mobilidade (SESAU)</h3>
                <p class="mb-0 text-muted">Fluxo eletr√¥nico para cadastrar e acompanhar pedidos de mobilidade.</p>
              </div>
              <div class="card-body">
                <ul class="mb-3 text-muted">
                  <li>Mobilidade interna <strong>a pedido</strong>, com crit√©rios definidos pela Portaria n¬∫ 127/2023.</li>
                  <li>Pedidos registrados exclusivamente no sistema eletr√¥nico oficial.</li>
                  <li>Validade de 12 meses, com necessidade de renova√ß√£o antes do vencimento.</li>
                </ul>

                <div class="d-flex flex-wrap gap-2">
                  <a class="btn btn-primary rounded-pill px-4 py-2" id="btn-nova-solicitacao" href="#" role="button">Nova solicita√ß√£o</a>
                  <a class="btn btn-outline-primary rounded-pill px-4 py-2" id="btn-ver-orientacoes" href="#orientacoes">Orienta√ß√µes</a>
                </div>
              </div>
            </article>
          </div>

          <!-- CARD: Atualiza√ß√£o cadastral (colapsado) -->
          <div class="col-lg-8">
            <article class="card card-programa">
              <div class="card-header">
                <span class="badge text-bg-light text-primary text-uppercase">Atualiza√ß√£o cadastral</span>
                <h3 class="h5 mt-3 mb-1">Dados para contato e lota√ß√£o</h3>
                <p class="mb-0 text-muted">Mantenha seus dados atualizados para agilizar an√°lises de mobilidade.</p>
              </div>
              <div class="card-body">
                <details class="collapsible-form">
                  <summary>Atualizar cadastro</summary>

                  <div class="mt-3">
                    <label class="form-label" for="sel-matricula">Matr√≠cula</label>
                    <select class="form-select" id="sel-matricula" data-valor-atual="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].matricula || '' : '' }}" required>
                      <option value="">Selecione a matr√≠cula</option>
                      <option value="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].matricula || '' : '' }}">{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].matricula || '' : '' }}</option>
                      <option value="{{ $json.data.vinculos && $json.data.vinculos[1] ? $json.data.vinculos[1].matricula || '' : '' }}">{{ $json.data.vinculos && $json.data.vinculos[1] ? $json.data.vinculos[1].matricula || '' : '' }}</option>
                    </select>
                    <div class="form-text">Selecione o v√≠nculo a atualizar.</div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="in-whatsapp">WhatsApp</label>
                      <input class="form-control" type="tel" id="in-whatsapp" inputmode="numeric" maxlength="11" placeholder="DDD + n√∫mero" value="{{ $json.data.dadosComuns.whatsapp || '' }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="in-telefone-alt">Telefone alternativo</label>
                      <input class="form-control" type="tel" id="in-telefone-alt" inputmode="numeric" maxlength="11" placeholder="DDD + n√∫mero" value="{{ $json.data.dadosComuns.tel_alternativo || '' }}" />
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-email">E-mail</label>
                    <input class="form-control" type="email" id="in-email" placeholder="nome@exemplo.com" autocomplete="email" value="{{ $json.data.dadosComuns.email || '' }}" />
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-cep">CEP</label>
                    <input class="form-control" type="text" id="in-cep" inputmode="numeric" maxlength="8" placeholder="00000000" value="{{ $json.data.dadosComuns.endereco.cep || '' }}" />
                    <div class="form-text">Ao informar o CEP, os demais campos de endere√ßo ser√£o preenchidos automaticamente.</div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-8">
                      <label class="form-label" for="in-logradouro">Logradouro</label>
                      <input class="form-control" type="text" id="in-logradouro" value="{{ $json.data.dadosComuns.endereco.logradouro || '' }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="in-numero">N√∫mero</label>
                      <input class="form-control" type="text" id="in-numero" value="{{ $json.data.dadosComuns.endereco.numero || '' }}" />
                    </div>
                  </div>

                  <div class="mt-3">
                    <label class="form-label" for="in-complemento">Complemento</label>
                    <input class="form-control" type="text" id="in-complemento" value="{{ $json.data.dadosComuns.endereco.complemento || '' }}" />
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="in-bairro">Bairro</label>
                      <input class="form-control" type="text" id="in-bairro" value="{{ $json.data.dadosComuns.endereco.bairro || '' }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="in-cidade">Cidade</label>
                      <input class="form-control" type="text" id="in-cidade" value="{{ $json.data.dadosComuns.endereco.cidade || '' }}" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label" for="in-uf">UF</label>
                      <input class="form-control text-uppercase" type="text" id="in-uf" maxlength="2" value="{{ $json.data.dadosComuns.endereco.uf || '' }}" />
                    </div>
                  </div>

                  <hr class="my-3" />

                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="sel-ds">DS/Executiva atual</label>
                      <select class="form-select" id="sel-ds" data-valor-atual="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].distrito || '' : '' }}"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="sel-unidade">Unidade atual</label>
                      <select class="form-select" id="sel-unidade" data-valor-atual="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].lotacao || '' : '' }}"></select>
                    </div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6">
                      <label class="form-label" for="sel-turno">Turno atual</label>
                      <select class="form-select" id="sel-turno" data-valor-atual="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].turno || '' : '' }}"></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="sel-regime">Regime atual</label>
                      <select class="form-select" id="sel-regime" data-valor-atual="{{ $json.data.vinculos && $json.data.vinculos[0] ? $json.data.vinculos[0].regime || '' : '' }}"></select>
                    </div>
                  </div>

                  <button class="btn btn-outline-primary rounded-pill mt-3" id="btn-atualizar-cadastro" type="button" disabled>Enviar atualiza√ß√£o</button>
                </details>
              </div>
            </article>
          </div>
        </div>
      </section>

      <!-- Minhas Solicita√ß√µes -->
      <section class="mb-5" id="minhas-solicitacoes-section">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
          <h2 class="section-title mb-0">Minhas solicita√ß√µes</h2>
          <p class="text-muted small mb-0">Selecione uma solicita√ß√£o para visualizar o resumo.</p>
        </div>
        <div id="minhas-solicitacoes-loading" class="minhas-placeholder">
          Carregando solicita√ß√µes vinculadas ao CPF informado...
        </div>
        <div id="minhas-solicitacoes-empty" class="minhas-placeholder d-none">
          Nenhuma solicita√ß√£o encontrada.
        </div>
        <div id="minhas-solicitacoes-cards"
             class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 minhas-grid d-none"></div>
      </section>

      <!-- Orienta√ß√µes -->
      <section class="row g-4 align-items-start mb-5" id="orientacoes">
        <div class="col-lg-7">
          <h2 class="section-title mb-3">Orienta√ß√µes</h2>
          <ol class="list-group list-group-numbered shadow-sm">
            <li class="list-group-item">Cadastre seu pedido exclusivamente pelo sistema eletr√¥nico.</li>
            <li class="list-group-item">Mantenha dados de contato e lota√ß√£o atualizados.</li>
            <li class="list-group-item">Pedidos t√™m validade de 12 meses; renove com anteced√™ncia.</li>
            <li class="list-group-item">A prioridade segue a data de protocolo e demais crit√©rios da Portaria 127/2023.</li>
          </ol>
        </div>
        <div class="col-lg-5">
          <div class="p-4 bg-white rounded-4 border shadow-sm">
            <h3 class="h6 text-uppercase text-secondary fw-bold mb-3">Publica√ß√µes</h3>
            <ul class="list-unstyled mb-0" id="publicacoes-list">
              <li class="text-muted">Carregando publica√ß√µes...</li>
            </ul>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-white border-top">
      <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
        <span>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Prefeitura do Recife</span>
        <span class="text-muted">¬© 2025 ‚Ä¢ Gest√£o do Trabalho e Educa√ß√£o na Sa√∫de</span>
      </div>
    </footer>

    <!-- Modal -->
    <div class="feedback-modal-backdrop" id="feedback-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="feedback-modal">
        <h4 class="feedback-modal-title" id="feedback-modal-title">Detalhes</h4>
        <div class="feedback-modal-message" id="feedback-modal-message"></div>
        <div class="feedback-modal-actions" id="feedback-modal-actions">
          <button type="button" class="btn btn-secondary" id="feedback-modal-close">Fechar</button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const cpfInput = document.getElementById("cpf");
        const onlyDigits = (v) => (v || "").replace(/\\D/g, "");
        const sanitizeCpf = (value) => {
          const digits = onlyDigits(value).slice(0, 11);
          return digits.length === 11 ? digits : "";
        };
        let cpf = sanitizeCpf(cpfInput?.value);
        const solicitacaoDetalheEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2";
        const novaSolicitacaoEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/f188b0f4-f4c9-455b-8dd9-e800c44b46e2";
        const publicacoesEndpoint = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/7b3f9046-f11b-4cc3-b570-c3e586748f6c";

        const atualizarCadastroEndpoint = ""; // ex.: "https://.../webhook/atualizar-cadastro"

        // UI helpers
        const modal = document.getElementById("feedback-modal");
        const modalTitle = document.getElementById("feedback-modal-title");
        const modalMessage = document.getElementById("feedback-modal-message");
        const modalActions = document.getElementById("feedback-modal-actions");
        const modalClose = document.getElementById("feedback-modal-close");
        const detalhesCache = new Map();
        const hierarquiaMapa = new Map();
        let resumoSolicitacaoAtual = null;
        let solicitacoesAtuais = [];
        let dadosServidor = null;
        const valoresPreferidos = {
          matricula: "",
          distrito: "",
          unidade: "",
          turno: "",
          regime: ""
        };
        const vinculosPreferidosPorMatricula = new Map();
        let hierarquiaCarregada = false;
        const openModal = (title, html, actions = []) => {
          modalTitle.textContent = title || "Detalhes";
          modalMessage.innerHTML = html || "<p class='mb-0 text-muted'>Sem conte√∫do.</p>";
          if (modalActions) {
            while (modalActions.firstChild) modalActions.removeChild(modalActions.firstChild);
            (actions || []).forEach(btn => {
              if (btn) modalActions.appendChild(btn);
            });
            if (modalClose) modalActions.appendChild(modalClose);
          }
          modal.classList.add("active");
          modal.setAttribute("aria-hidden", "false");
          modalClose?.focus();
        };
        const closeModal = () => {
          modal.classList.remove("active");
          modal.setAttribute("aria-hidden", "true");
          resumoSolicitacaoAtual = null;
        };
        modalClose?.addEventListener("click", closeModal);
        modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
        document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

        const btnNovaSolicitacao = document.getElementById("btn-nova-solicitacao");
        const selMatricula = document.getElementById("sel-matricula");
        const selDistrito = document.getElementById("sel-ds");
        const selUnidade = document.getElementById("sel-unidade");
        const selTurno = document.getElementById("sel-turno");
        const selRegime = document.getElementById("sel-regime");
        const redirectPost = (url, data) => {
          if (!url) return;
          const form = document.createElement("form");
          form.method = "POST";
          form.action = url;
          form.style.display = "none";
          Object.entries(data || {}).forEach(([key, value]) => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = typeof value === "string" ? value : JSON.stringify(value);
            form.appendChild(input);
          });
          document.body.appendChild(form);
          form.submit();
          setTimeout(() => form.remove(), 1000);
        };

        btnNovaSolicitacao?.addEventListener("click", (event) => {
          event.preventDefault();
          const atual = sanitizeCpf(cpfInput?.value);
          if (atual) cpf = atual;
          if (!cpf) {
            openModal("‚ö†Ô∏è CPF n√£o localizado", "<p>N√£o foi poss√≠vel identificar o CPF do servidor para iniciar a solicita√ß√£o.</p>");
            return;
          }
          redirectPost(novaSolicitacaoEndpoint, { cpf });
        });

        const normalizeText = (value) => (value ?? "").toString().trim();
        const templatePlaceholderPattern = /\{\{\s*[^}]+\s*\}\}/;
        const resolveTemplateValue = (value) => {
          const text = normalizeText(value);
          if (!text) return "";
          const lower = text.toLowerCase();
          if (lower === "null" || lower === "undefined") return "";
          if (templatePlaceholderPattern.test(text)) return "";
          return text;
        };
        const formatarPrimeiroNome = (nome) => {
          const texto = resolveTemplateValue(nome);
          if (!texto) return "";
          const partes = texto.split(/\s+/).filter(Boolean);
          if (!partes.length) return "";
          const conectores = new Set(["da", "de", "di", "do", "dos", "das", "du"]);
          const selecionadas = [partes[0]];
          if (partes.length > 1) {
            let segundoNome = null;
            for (let i = 1; i < partes.length; i++) {
              const candidato = partes[i];
              if (!candidato) continue;
              const candLower = candidato.toLocaleLowerCase("pt-BR");
              if (conectores.has(candLower)) continue;
              segundoNome = candidato;
              break;
            }
            if (!segundoNome) {
              segundoNome = partes[1];
            }
            if (segundoNome) {
              selecionadas.push(segundoNome);
            }
          }
          return selecionadas
            .map(parte => parte.toLocaleLowerCase("pt-BR"))
            .map(parte =>
              parte
                .split(/([-'])/)
                .map((segmento, index, arr) => {
                  if (segmento === "-" || segmento === "'") return segmento;
                  if (!segmento) return segmento;
                  const isConnector = conectores.has(segmento);
                  if (isConnector && index !== 0 && index !== arr.length - 1) {
                    return segmento;
                  }
                  return segmento.charAt(0).toLocaleUpperCase("pt-BR") + segmento.slice(1);
                })
                .join("")
            )
            .join(" ");
        };
        const preferTemplateValue = (...values) => {
          for (const valor of values) {
            const resolved = resolveTemplateValue(valor);
            if (resolved) return resolved;
          }
          return "";
        };
        const valorMatriculaPreferidaAttr = resolveTemplateValue(selMatricula?.dataset?.valorAtual);
        const valorDistritoPreferidoAttr = resolveTemplateValue(selDistrito?.dataset?.valorAtual);
        const valorUnidadePreferidaAttr = resolveTemplateValue(selUnidade?.dataset?.valorAtual);
        const valorTurnoPreferidoAttr = resolveTemplateValue(selTurno?.dataset?.valorAtual);
        const valorRegimePreferidoAttr = resolveTemplateValue(selRegime?.dataset?.valorAtual);
        if (selMatricula) {
          if (valorMatriculaPreferidaAttr) selMatricula.dataset.valorAtual = valorMatriculaPreferidaAttr;
          else delete selMatricula.dataset.valorAtual;
        }
        if (selDistrito) {
          if (valorDistritoPreferidoAttr) selDistrito.dataset.valorAtual = valorDistritoPreferidoAttr;
          else delete selDistrito.dataset.valorAtual;
        }
        if (selUnidade) {
          if (valorUnidadePreferidaAttr) selUnidade.dataset.valorAtual = valorUnidadePreferidaAttr;
          else delete selUnidade.dataset.valorAtual;
        }
        if (selTurno) {
          if (valorTurnoPreferidoAttr) selTurno.dataset.valorAtual = valorTurnoPreferidoAttr;
          else delete selTurno.dataset.valorAtual;
        }
        if (selRegime) {
          if (valorRegimePreferidoAttr) selRegime.dataset.valorAtual = valorRegimePreferidoAttr;
          else delete selRegime.dataset.valorAtual;
        }
        const obterTemplatePayload = () => {
          if (typeof window !== "undefined" && window.portalTemplateData) {
            return window.portalTemplateData;
          }
          const scriptTemplate = document.getElementById("portal-template-data");
          if (scriptTemplate) {
            const raw = scriptTemplate.textContent?.trim();
            if (raw && !raw.includes("{{")) {
              try {
                return JSON.parse(raw);
              } catch (err) {
                console.warn("N√£o foi poss√≠vel interpretar os dados do template", err);
              }
            }
          }
          return null;
        };
        const extrairTemplateContexto = (payload) => {
          const vazio = { dadosComuns: {}, endereco: {}, vinculos: [], catalogos: {} };
          if (!payload) return vazio;
          const lista = Array.isArray(payload) ? payload : [payload];
          for (const item of lista) {
            if (!item || typeof item !== "object") continue;
            const dataNode = item.data && typeof item.data === "object" ? item.data : item;
            const dadosComuns = dataNode.dadosComuns && typeof dataNode.dadosComuns === "object" ? dataNode.dadosComuns : {};
            const enderecoDireto = dataNode.endereco && typeof dataNode.endereco === "object" ? dataNode.endereco : {};
            const endereco = dadosComuns.endereco && typeof dadosComuns.endereco === "object" ? dadosComuns.endereco : enderecoDireto;
            const vinculos = Array.isArray(dataNode.vinculos)
              ? dataNode.vinculos.filter(reg => reg && typeof reg === "object")
              : [];
            const catalogos = dataNode.catalogos && typeof dataNode.catalogos === "object" ? dataNode.catalogos : {};
            return { dadosComuns, endereco, vinculos, catalogos };
          }
          return vazio;
        };
        const templatePayload = obterTemplatePayload();
        const templateContexto = extrairTemplateContexto(templatePayload);
        const catalogosTemplate = templateContexto.catalogos || {};
        const greetingStrong = document.querySelector(".user-greeting strong");
        const primeiroVinculoTemplate = templateContexto.vinculos.length ? templateContexto.vinculos[0] : {};
        const dadosServidorTemplate = {
          matricula: preferTemplateValue(primeiroVinculoTemplate?.matricula, templateContexto.dadosComuns?.matricula, valorMatriculaPreferidaAttr),
          nome: preferTemplateValue(templateContexto.dadosComuns?.nome, greetingStrong?.textContent),
          cpf: preferTemplateValue(templateContexto.dadosComuns?.cpf, cpfInput?.value),
          admissao: preferTemplateValue(primeiroVinculoTemplate?.admissao),
          nascimento: preferTemplateValue(templateContexto.dadosComuns?.nascimento),
          cargo: preferTemplateValue(primeiroVinculoTemplate?.cargo),
          grupo: preferTemplateValue(primeiroVinculoTemplate?.grupo),
          vinculo: preferTemplateValue(primeiroVinculoTemplate?.vinculo),
          carga_horaria: preferTemplateValue(primeiroVinculoTemplate?.carga_horaria, primeiroVinculoTemplate?.cargaHoraria),
          cep: preferTemplateValue(templateContexto.endereco?.cep),
          logradouro: preferTemplateValue(templateContexto.endereco?.logradouro),
          numero: preferTemplateValue(templateContexto.endereco?.numero),
          complemento: preferTemplateValue(templateContexto.endereco?.complemento),
          bairro: preferTemplateValue(templateContexto.endereco?.bairro),
          cidade: preferTemplateValue(templateContexto.endereco?.cidade),
          uf: preferTemplateValue(templateContexto.endereco?.uf),
          whatsapp: preferTemplateValue(templateContexto.dadosComuns?.whatsapp),
          tel_alternativo: preferTemplateValue(templateContexto.dadosComuns?.tel_alternativo, templateContexto.dadosComuns?.telAlternativo),
          email: preferTemplateValue(templateContexto.dadosComuns?.email),
          distrito: preferTemplateValue(primeiroVinculoTemplate?.distrito, valorDistritoPreferidoAttr),
          lotacao: preferTemplateValue(primeiroVinculoTemplate?.lotacao, valorUnidadePreferidaAttr),
          turno: preferTemplateValue(primeiroVinculoTemplate?.turno, valorTurnoPreferidoAttr),
          regime: preferTemplateValue(primeiroVinculoTemplate?.regime, valorRegimePreferidoAttr)
        };
        const valorMatriculaPreferida = preferTemplateValue(valorMatriculaPreferidaAttr, dadosServidorTemplate.matricula);
        const valorDistritoPreferido = preferTemplateValue(valorDistritoPreferidoAttr, dadosServidorTemplate.distrito);
        const valorUnidadePreferida = preferTemplateValue(valorUnidadePreferidaAttr, dadosServidorTemplate.lotacao);
        const valorTurnoPreferido = preferTemplateValue(valorTurnoPreferidoAttr, dadosServidorTemplate.turno);
        const valorRegimePreferido = preferTemplateValue(valorRegimePreferidoAttr, dadosServidorTemplate.regime);
        const escapeHtml = (value) => normalizeText(value).replace(/[&<>"']/g, (match) => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        })[match] || match);
        const slugify = (value) => {
          const base = normalizeText(value);
          return base.normalize ? base.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : base.toLowerCase();
        };
        if (!valoresPreferidos.matricula && dadosServidorTemplate.matricula) {
          valoresPreferidos.matricula = dadosServidorTemplate.matricula;
        }
        if (!valoresPreferidos.distrito && dadosServidorTemplate.distrito) {
          valoresPreferidos.distrito = dadosServidorTemplate.distrito;
        }
        if (!valoresPreferidos.unidade && dadosServidorTemplate.lotacao) {
          valoresPreferidos.unidade = dadosServidorTemplate.lotacao;
        }
        if (!valoresPreferidos.turno && dadosServidorTemplate.turno) {
          valoresPreferidos.turno = dadosServidorTemplate.turno;
        }
        if (!valoresPreferidos.regime && dadosServidorTemplate.regime) {
          valoresPreferidos.regime = dadosServidorTemplate.regime;
        }
        const primeiroNomeSaudacao = formatarPrimeiroNome(dadosServidorTemplate.nome || greetingStrong?.textContent);
        if (greetingStrong) {
          if (dadosServidorTemplate.nome) {
            greetingStrong.dataset.nomeCompleto = dadosServidorTemplate.nome;
          }
          const nomeCompletoResolvido = resolveTemplateValue(dadosServidorTemplate.nome);
          const saudacaoTexto = primeiroNomeSaudacao || nomeCompletoResolvido || resolveTemplateValue(greetingStrong.textContent);
          if (saudacaoTexto) {
            greetingStrong.textContent = saudacaoTexto.trim();
          } else {
            greetingStrong.textContent = "servidor(a)";
          }
        }
        if (dadosServidorTemplate.cpf) {
          dadosServidorTemplate.cpf = onlyDigits(dadosServidorTemplate.cpf);
        }
        const baseRegistroTemplate = {
          nome: dadosServidorTemplate.nome,
          cpf: dadosServidorTemplate.cpf,
          whatsapp: dadosServidorTemplate.whatsapp,
          tel_alternativo: dadosServidorTemplate.tel_alternativo,
          email: dadosServidorTemplate.email,
          cep: dadosServidorTemplate.cep,
          logradouro: dadosServidorTemplate.logradouro,
          numero: dadosServidorTemplate.numero,
          complemento: dadosServidorTemplate.complemento,
          bairro: dadosServidorTemplate.bairro,
          cidade: dadosServidorTemplate.cidade,
          uf: dadosServidorTemplate.uf
        };
        const vinculosTemplate = templateContexto.vinculos.length
          ? templateContexto.vinculos.map(v => ({ ...baseRegistroTemplate, ...v }))
          : [];
        const registrosServidorPreCarregados = vinculosTemplate.length
          ? vinculosTemplate
          : (Object.values(baseRegistroTemplate).some(valor => normalizeText(valor)) ? [baseRegistroTemplate] : []);
        if (!cpf) {
          const cpfTemplate = onlyDigits(dadosServidorTemplate.cpf);
          if (cpfTemplate) {
            cpf = cpfTemplate;
            if (cpfInput) {
              cpfInput.value = cpfTemplate;
              cpfInput.setAttribute("value", cpfTemplate);
            }
          }
        }

        const setOptions = (select, list, placeholder) => {
          if (!select) return;
          const currentValue = select.value;
          select.innerHTML = "";
          const opt0 = document.createElement("option");
          opt0.value = "";
          opt0.textContent = placeholder || "Selecione...";
          select.appendChild(opt0);
          const seen = new Set();
          const options = [];
          (list || []).filter(Boolean).forEach(item => {
            const value = item?.value ?? item?.label ?? item;
            const label = item?.label ?? item?.value ?? item;
            if (!value || !label) return;
            const key = (item?.key || slugify(value || label));
            if (seen.has(key)) return;
            seen.add(key);
            options.push({ value, label, key });
          });
          options.sort((a, b) => a.label.localeCompare(b.label, "pt-BR"));
          options.forEach(item => {
            const option = document.createElement("option");
            option.value = item.value;
            option.textContent = item.label;
            option.dataset.key = item.key;
            select.appendChild(option);
          });
          select.disabled = options.length === 0;
          if (options.some(item => item.value === currentValue || item.label === currentValue)) {
            select.value = currentValue;
          } else {
            select.value = "";
          }
        };

        const tentarSelecionarValor = (select, valor) => {
          if (!select || !valor) return false;
          const alvo = normalizeText(valor).toLowerCase();
          for (const option of Array.from(select.options)) {
            const optValue = normalizeText(option.value).toLowerCase();
            const optText = normalizeText(option.textContent).toLowerCase();
            if (optValue === alvo || optText === alvo) {
              select.value = option.value;
              return true;
            }
          }
          return false;
        };

        const selecionarOuCriarOpcao = (select, valor, label) => {
          if (!select || !valor) return false;
          const alvo = normalizeText(valor).toLowerCase();
          const valorAntes = select.value;

          Array.from(select.options)
            .filter(option => option.dataset && option.dataset.synthetic === "true")
            .forEach(option => {
              const optValue = normalizeText(option.value).toLowerCase();
              const optText = normalizeText(option.textContent).toLowerCase();
              if (optValue !== alvo && optText !== alvo) {
                option.remove();
              }
            });

          let selecionou = false;
          for (const option of Array.from(select.options)) {
            const optValue = normalizeText(option.value).toLowerCase();
            const optText = normalizeText(option.textContent).toLowerCase();
            if (optValue === alvo || optText === alvo) {
              if (select.value !== option.value) {
                select.value = option.value;
              }
              selecionou = true;
              break;
            }
          }

          if (!selecionou) {
            const opcaoSintetica = document.createElement("option");
            opcaoSintetica.value = valor;
            opcaoSintetica.textContent = label || valor;
            opcaoSintetica.dataset.synthetic = "true";
            const temPlaceholder = select.options.length && select.options[0].value === "";
            if (temPlaceholder) {
              select.insertBefore(opcaoSintetica, select.options[1] || null);
            } else {
              select.insertBefore(opcaoSintetica, select.options[0] || null);
            }
            select.value = valor;
            selecionou = true;
          }

          return selecionou && select.value !== valorAntes;
        };

        const limparSelecao = (select) => {
          if (!select) return;
          Array.from(select.options)
            .filter(option => option.dataset && option.dataset.synthetic === "true")
            .forEach(option => option.remove());
          select.value = "";
        };

        const aplicarDadosVinculoNosSelects = (dados) => {
          if (!dados) return;
          if (resolveTemplateValue(dados.distrito)) selecionarOuCriarOpcao(selDistrito, dados.distrito, dados.distrito);
          else limparSelecao(selDistrito);
          if (resolveTemplateValue(dados.unidade)) selecionarOuCriarOpcao(selUnidade, dados.unidade, dados.unidade);
          else limparSelecao(selUnidade);
          if (resolveTemplateValue(dados.turno)) selecionarOuCriarOpcao(selTurno, dados.turno, dados.turno);
          else limparSelecao(selTurno);
          if (resolveTemplateValue(dados.regime)) selecionarOuCriarOpcao(selRegime, dados.regime, dados.regime);
          else limparSelecao(selRegime);
        };

        const sincronizarMetadadosMatriculas = () => {
          if (!selMatricula) return;
          Array.from(selMatricula.options).forEach(option => {
            if (!option || !option.value) return;
            const chave = resolveTemplateValue(option.value);
            if (!chave) return;
            const dados = vinculosPreferidosPorMatricula.get(chave);
            if (!dados) {
              delete option.dataset.distrito;
              delete option.dataset.unidade;
              delete option.dataset.turno;
              delete option.dataset.regime;
              return;
            }
            option.dataset.distrito = dados.distrito || "";
            option.dataset.unidade = dados.unidade || "";
            option.dataset.turno = dados.turno || "";
            option.dataset.regime = dados.regime || "";
          });
        };

        const formatarData = (valor) => {
          if (!valor) return "";
          const texto = normalizeText(valor);
          const iso = new Date(texto);
          if (!isNaN(iso)) return iso.toLocaleDateString("pt-BR");
          const partes = texto.match(/^([0-3]?\d)\/([0-1]?\d)\/(\d{4})$/);
          if (partes) {
            const [ , dia, mes, ano ] = partes;
            return `${dia.padStart(2,"0")}/${mes.padStart(2,"0")}/${ano}`;
          }
          return texto;
        };

        // CEP -> autopreencher
        const inCep = document.getElementById("in-cep");
        const inLogradouro = document.getElementById("in-logradouro");
        const inNumero = document.getElementById("in-numero");
        const inComplemento = document.getElementById("in-complemento");
        const inBairro = document.getElementById("in-bairro");
        const inCidade = document.getElementById("in-cidade");
        const inUf = document.getElementById("in-uf");
        const brasilApiBase = "https://brasilapi.com.br/api/cep/v1/";
        let lastCep = "";
        let cepTimer = null;

        const sanitizeCep = () => {
          const cepVal = onlyDigits(inCep?.value).slice(0, 8);
          if (inCep && inCep.value !== cepVal) inCep.value = cepVal;
          return cepVal;
        };

        const preencherEndereco = (data) => {
          if (!data) return;
          const logradouro = data.street || data.logradouro;
          const bairro = data.neighborhood || data.bairro;
          const cidade = data.city || data.localidade || data.cidade;
          const estado = data.state || data.estado || data.uf;
          const complemento = data.complement || data.complemento;
          if (inLogradouro && logradouro) inLogradouro.value = String(logradouro).toUpperCase();
          if (inBairro && bairro) inBairro.value = String(bairro).toUpperCase();
          if (inCidade && cidade) inCidade.value = String(cidade).toUpperCase();
          if (inUf && estado) inUf.value = String(estado).toUpperCase();
          if (inComplemento && complemento && !inComplemento.value) inComplemento.value = String(complemento).toUpperCase();
        };

        const buscarCep = () => {
          const cepVal = sanitizeCep();
          if (cepVal.length !== 8 || cepVal === lastCep) {
            validateUpdateForm();
            return;
          }
          lastCep = cepVal;

          fetch(brasilApiBase + cepVal, { cache: "no-store" })
            .then(r => { if (!r.ok) throw new Error("CEP n√£o encontrado"); return r.json(); })
            .then(data => {
              preencherEndereco(data);
              validateUpdateForm();
            })
            .catch(() => {
              lastCep = "";
              openModal("‚ö†Ô∏è Aten√ß√£o", "<p>N√£o encontramos informa√ß√µes para o CEP informado. Voc√™ pode preencher os campos manualmente.</p>");
            });
        };

        inCep?.addEventListener("input", () => {
          const cepVal = sanitizeCep();
          if (cepTimer) clearTimeout(cepTimer);
          if (cepVal.length === 8) {
            cepTimer = setTimeout(buscarCep, 300);
          }
          validateUpdateForm();
        });
        inCep?.addEventListener("change", buscarCep);
        inCep?.addEventListener("blur", buscarCep);

        // Carregar publica√ß√µes
        fetch(publicacoesEndpoint)
          .then(r => r.json())
          .then(data => {
            const list = document.getElementById("publicacoes-list");
            list.innerHTML = "";
            const items = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);
            if (!items.length) {
              list.innerHTML = "<li class='text-muted'>Nenhuma publica√ß√£o dispon√≠vel no momento.</li>";
              return;
            }
            const parseDate = (raw) => {
              if (!raw) return null;
              const d = new Date(raw);
              if (!isNaN(d)) return d;
              const m = String(raw).match(/^([0-3]?\\d)\\/([0-1]?\\d)\\/(\\d{4})$/);
              if (m) return new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
              return null;
            };
            const fmt = (d) => d?.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit", year: "numeric" }) || "";
            items.map(it => ({
              url: it.url,
              descricao: it.description || it.descricao || it.title || it.titulo,
              dt: parseDate(it.date || it.data || it.dt || it.createdAt)
            }))
            .filter(it => it.url && it.descricao)
            .sort((a,b) => (b.dt?.getTime()||0) - (a.dt?.getTime()||0))
            .forEach(it => {
              const li = document.createElement("li");
              li.className = "mb-2";
              const container = document.createElement("div");
              container.className = "d-flex flex-column flex-sm-row align-items-sm-center gap-2";
              if (it.dt) {
                const time = document.createElement("time");
                time.textContent = fmt(it.dt);
                time.dateTime = it.dt.toISOString();
                container.appendChild(time);
              }
              const a = document.createElement("a");
              a.href = it.url;
              a.rel = "noopener";
              a.className = "link-primary fw-semibold";
              a.textContent = "üìÑ " + it.descricao;
              container.appendChild(a);
              li.appendChild(container);
              list.appendChild(li);
            });
          })
          .catch(() => {
            const list = document.getElementById("publicacoes-list");
            if (list) list.innerHTML = "<li class='text-muted'>N√£o foi poss√≠vel carregar as publica√ß√µes.</li>";
          });

        // Minhas solicita√ß√µes
        const secMinhas = document.getElementById("minhas-solicitacoes-section");
        const grid = document.getElementById("minhas-solicitacoes-cards");
        const loadBox = document.getElementById("minhas-solicitacoes-loading");
        const emptyBox = document.getElementById("minhas-solicitacoes-empty");
        const emptyBoxDefaultMessage = emptyBox?.textContent?.trim() || "Nenhuma solicita√ß√£o encontrada.";

        function setMinhasState(state) {
          loadBox?.classList.toggle("d-none", state !== "loading");
          emptyBox?.classList.toggle("d-none", state !== "empty");
          grid?.classList.toggle("d-none", state !== "ready");
        }

        const coletarRegistros = (data) => {
          if (Array.isArray(data)) return data;
          if (Array.isArray(data?.items)) return data.items;
          if (Array.isArray(data?.data)) return data.data;
          if (Array.isArray(data?.result)) return data.result;
          if (data && typeof data === "object") {
            const valores = Object.values(data).filter(item => typeof item === "object");
            const acumulado = [];
            valores.forEach(item => {
              if (Array.isArray(item)) acumulado.push(...item);
              else acumulado.push(item);
            });
            if (!acumulado.length) acumulado.push(data);
            return acumulado;
          }
          return [];
        };

        const normalizarDadosServidor = (item) => {
          if (!item || typeof item !== "object") return null;
          const prefer = (...values) => {
            for (const valor of values) {
              const resolved = resolveTemplateValue(valor);
              if (resolved) return resolved;
            }
            return "";
          };
          const cadastro = {
            nome: prefer(item.nome, item.NOME),
            matricula: prefer(item.matricula, item.MATRICULA),
            cargo: prefer(item.cargo, item.CARGO),
            cpf: onlyDigits(prefer(item.cpf, item.CPF, cpf)),
            whatsapp: onlyDigits(prefer(item.whatsapp, item.WHATSAPP, item.telefone, item.TELEFONE)),
            telAlternativo: onlyDigits(
              prefer(item.tel_alternativo, item.telAlternativo, item.telefoneAlternativo, item.TEL_ALTERNATIVO)
            ),
            email: prefer(item.email, item.EMAIL),
            cep: onlyDigits(prefer(item.cep, item.CEP)),
            logradouro: prefer(item.logradouro, item.LOGRADOURO, item.endereco, item.ENDERECO),
            numero: prefer(item.numero, item.NUMERO),
            complemento: prefer(item.complemento, item.COMPLEMENTO),
            bairro: prefer(item.bairro, item.BAIRRO),
            cidade: prefer(item.cidade, item.CIDADE),
            uf: prefer(item.uf, item.UF),
            distrito: prefer(item.distrito, item.DISTRITO, item.ds, item.executiva, item["ds/executiva"]),
            unidade: prefer(item.lotacao, item.LOTACAO, item.unidade, item.local),
            turno: prefer(item.turno, item.TURNO),
            regime: prefer(item.regime, item.REGIME)
          };
          return cadastro;
        };

        const definirPreferenciasHierarquia = (dados) => {
          if (!dados) return;
          if (dados.matricula) valoresPreferidos.matricula = dados.matricula;
          if (dados.distrito) valoresPreferidos.distrito = dados.distrito;
          if (dados.unidade) valoresPreferidos.unidade = dados.unidade;
          if (dados.turno) valoresPreferidos.turno = dados.turno;
          if (dados.regime) valoresPreferidos.regime = dados.regime;
        };

        const resetarPreferenciasHierarquia = () => {
          valoresPreferidos.matricula = "";
          valoresPreferidos.distrito = "";
          valoresPreferidos.unidade = "";
          valoresPreferidos.turno = "";
          valoresPreferidos.regime = "";
        };

        const aplicarSelecaoMatriculaPreferida = () => {
          if (!selMatricula || !valoresPreferidos.matricula) return;
          const valorAntes = selMatricula.value;
          if (tentarSelecionarValor(selMatricula, valoresPreferidos.matricula) && selMatricula.value !== valorAntes) {
            selMatricula.dispatchEvent(new Event("change"));
          }
        };

        const aplicarHierarquiaPreferida = () => {
          if (!hierarquiaCarregada) return;
          let distritoAlterou = false;
          if (valoresPreferidos.distrito) {
            distritoAlterou = selecionarOuCriarOpcao(selDistrito, valoresPreferidos.distrito, valoresPreferidos.distrito);
          } else if (selDistrito && selDistrito.value) {
            limparSelecao(selDistrito);
            distritoAlterou = true;
          }
          if (distritoAlterou) {
            atualizarLotacoes();
          }

          let unidadeAlterou = false;
          if (valoresPreferidos.unidade) {
            unidadeAlterou = selecionarOuCriarOpcao(selUnidade, valoresPreferidos.unidade, valoresPreferidos.unidade);
          } else if (selUnidade && selUnidade.value) {
            limparSelecao(selUnidade);
            unidadeAlterou = true;
          }
          if (unidadeAlterou) {
            atualizarTurnos();
          }

          let turnoAlterou = false;
          if (valoresPreferidos.turno) {
            turnoAlterou = selecionarOuCriarOpcao(selTurno, valoresPreferidos.turno, valoresPreferidos.turno);
          } else if (selTurno && selTurno.value) {
            limparSelecao(selTurno);
            turnoAlterou = true;
          }
          if (turnoAlterou) {
            atualizarRegimes();
          }

          if (valoresPreferidos.regime) {
            selecionarOuCriarOpcao(selRegime, valoresPreferidos.regime, valoresPreferidos.regime);
          } else {
            limparSelecao(selRegime);
          }
          validateUpdateForm();
        };

        const atribuirValorCampo = (input, valor, transform) => {
          if (!input) return "";
          const resolvido = resolveTemplateValue(valor);
          if (!resolvido) {
            input.value = "";
            return "";
          }
          const final = transform ? transform(resolvido) : resolvido;
          input.value = final;
          return final;
        };

        const aplicarDadosServidor = (reaplicarSelecoes = true) => {
          const dados = dadosServidor || {};
          atribuirValorCampo(inWhats, dados.whatsapp);
          atribuirValorCampo(inTelAlt, dados.telAlternativo);
          atribuirValorCampo(inEmail, dados.email);
          const cepAplicado = atribuirValorCampo(inCep, dados.cep);
          lastCep = onlyDigits(cepAplicado);
          atribuirValorCampo(inLogradouro, dados.logradouro, (val) => val.toUpperCase());
          atribuirValorCampo(inNumero, dados.numero);
          atribuirValorCampo(inComplemento, dados.complemento, (val) => val.toUpperCase());
          atribuirValorCampo(inBairro, dados.bairro, (val) => val.toUpperCase());
          atribuirValorCampo(inCidade, dados.cidade, (val) => val.toUpperCase());
          atribuirValorCampo(inUf, dados.uf, (val) => val.toUpperCase());

          if (reaplicarSelecoes) {
            aplicarSelecaoMatriculaPreferida();
            aplicarHierarquiaPreferida();
          }
          validateUpdateForm();
        };

        const registrarDadosServidor = (data) => {
          const registros = coletarRegistros(data);
          vinculosPreferidosPorMatricula.clear();
          let primeiroNormalizado = null;
          let primeiroComMatricula = null;

          registros.forEach(item => {
            const normalizadoAtual = normalizarDadosServidor(item);
            if (!normalizadoAtual) return;
            if (!primeiroNormalizado) primeiroNormalizado = normalizadoAtual;
            if (normalizadoAtual.matricula) {
              vinculosPreferidosPorMatricula.set(normalizadoAtual.matricula, normalizadoAtual);
              if (!primeiroComMatricula) primeiroComMatricula = normalizadoAtual;
            }
          });

          const basePreferida = (
            (selMatricula?.value && vinculosPreferidosPorMatricula.get(resolveTemplateValue(selMatricula.value))) ||
            (valoresPreferidos.matricula && vinculosPreferidosPorMatricula.get(valoresPreferidos.matricula)) ||
            primeiroComMatricula ||
            primeiroNormalizado
          );

          if (!basePreferida) {
            dadosServidor = null;
            resetarPreferenciasHierarquia();
            aplicarDadosServidor();
            sincronizarMetadadosMatriculas();
            return;
          }

          dadosServidor = { ...basePreferida };
          resetarPreferenciasHierarquia();
          definirPreferenciasHierarquia(basePreferida);
          aplicarDadosServidor();
          sincronizarMetadadosMatriculas();
        };
        function normalizeSolicitacoes(data) {
          let items = [];
          if (Array.isArray(data)) items = data;
          else if (Array.isArray(data?.items)) items = data.items;
          else if (Array.isArray(data?.data)) items = data.data;
          else if (Array.isArray(data?.result)) items = data.result;
          else if (data && typeof data === "object") items = [data];

          const mapa = new Map();
          items.forEach(entry => {
            const matricula = resolveTemplateValue(entry?.matricula ?? entry?.MATRICULA ?? entry?.id ?? entry?.titulo ?? "");
            if (!matricula) return;
            const cargo = resolveTemplateValue(entry?.cargo ?? entry?.CARGO ?? entry?.subtitulo ?? entry?.descricao ?? "");
            const atual = mapa.get(matricula) || { matricula, cargo: cargo || "Cargo n√£o informado" };
            if (!atual.cargo && cargo) atual.cargo = cargo;
            mapa.set(matricula, atual);
          });

          return Array.from(mapa.values());
        }

        function normalizarDetalhesSolicitacao(data, matriculaPadrao) {
          let items = [];
          if (Array.isArray(data)) items = data;
          else if (Array.isArray(data?.items)) items = data.items;
          else if (Array.isArray(data?.data)) items = data.data;
          else if (Array.isArray(data?.result)) items = data.result;
          else if (data && typeof data === "object") {
            items = [];
            Object.values(data).forEach(value => {
              if (Array.isArray(value)) items.push(...value);
              else items.push(value);
            });
          }

          return items
            .map(item => {
              if (!item || typeof item !== "object") return null;
              const matricula = normalizeText(item.matricula || item.MATRICULA || matriculaPadrao || "");
              if (!matricula) return null;
              const distrito = normalizeText(item.distrito || item.DISTRITO || item.ds || item.executiva || item["ds/executiva"] || "");
              const lotacao = normalizeText(item.lotacao || item.LOTACAO || item.unidade || item.local || item.descricao || "");
              const turno = normalizeText(item.turno || item.TURNO || "");
              const regime = normalizeText(item.regime || item.REGIME || "");
              const prioridadeRaw = item.prioridade ?? item.PRIORIDADE ?? item.ordem ?? item.ORDEM;
              const prioridadeNum = typeof prioridadeRaw === "number" ? prioridadeRaw : parseInt(prioridadeRaw, 10);
              const prioridade = Number.isFinite(prioridadeNum) ? prioridadeNum : "";
              const dataCredenciamento = item.data_credenciamento || item.dataCredenciamento || item.credenciamento || "";
              const dataSolicitacao = item.data_solicitacao || item.dataSolicitacao || item.solicitacao || item.data || "";
              const protocolo = normalizeText(item.protocolo || item.PROTOCOLO || "");
              return { matricula, distrito, lotacao, turno, regime, prioridade, dataCredenciamento, dataSolicitacao, protocolo };
            })
            .filter(Boolean);
        }

        function montarResumoSolicitacao(matricula, detalhes) {
          const protocolo = normalizeText(detalhes.find(item => item.protocolo)?.protocolo || "");
          const cabecalho = [
            `<p class="mb-1"><strong>Matr√≠cula:</strong> ${escapeHtml(matricula)}</p>`
          ];
          if (protocolo) {
            cabecalho.push(`<p class="mb-1"><strong>Protocolo:</strong> ${escapeHtml(protocolo)}</p>`);
          }
          cabecalho.push(`<p class="text-muted mb-2">Total de registros: ${detalhes.length}</p>`);

          const linhas = detalhes.map(item => {
            const prioridade = item.prioridade === "" || item.prioridade === null ? "-" : escapeHtml(String(item.prioridade));
            const distrito = escapeHtml(item.distrito || "-");
            const lotacao = escapeHtml(item.lotacao || "-");
            const turnoRegime = [item.turno, item.regime].map(normalizeText).filter(Boolean).map(escapeHtml).join(" ‚Ä¢ ");
            const dataSolic = escapeHtml(formatarData(item.dataSolicitacao));
            const dataCred = escapeHtml(formatarData(item.dataCredenciamento));
            const infoExtra = turnoRegime ? `<div class="small text-muted">${turnoRegime}</div>` : "";
            return `<tr><td class="text-center">${prioridade}</td><td>${distrito}</td><td><div class="fw-semibold">${lotacao}</div>${infoExtra}</td><td>${dataSolic}</td><td>${dataCred}</td></tr>`;
          }).join("") || `<tr><td colspan="5" class="text-center text-muted">Nenhum registro encontrado.</td></tr>`;

          const tabela = `<div class="table-responsive"><table class="table table-sm align-middle mb-0"><thead class="table-light"><tr><th class="text-center" style="width:110px">Prioridade</th><th style="width:140px">Distrito</th><th>Lota√ß√£o</th><th style="width:140px">Data solicita√ß√£o</th><th style="width:160px">Data credenciamento</th></tr></thead><tbody>${linhas}</tbody></table></div>`;

          return { html: `<div class="mb-3">${cabecalho.join("")}</div>${tabela}`, protocolo, detalhes };
        }

        const criarBotaoModal = (texto, classe, aoClicar) => {
          const botao = document.createElement("button");
          botao.type = "button";
          botao.className = classe;
          botao.textContent = texto;
          botao.addEventListener("click", aoClicar);
          return botao;
        };

        const imprimirResumoSolicitacao = (modo) => {
          if (!resumoSolicitacaoAtual?.html) {
            openModal("‚ÑπÔ∏è Nenhum resumo dispon√≠vel", "<p>Abra uma solicita√ß√£o antes de imprimir ou salvar em PDF.</p>");
            return;
          }
          const titulo = `${modo === "pdf" ? "Salvar PDF" : "Imprimir"} - Solicita√ß√£o ${resumoSolicitacaoAtual.matricula || ""}`.trim();
          const janela = window.open("", "_blank");
          if (!janela) {
            openModal("‚ö†Ô∏è Popup bloqueado", "<p>Permita pop-ups no navegador para gerar a impress√£o ou o PDF.</p>");
            return;
          }
          janela.document.write(`<!DOCTYPE html><html lang="pt-BR"><head><meta charset="utf-8" /><title>${escapeHtml(titulo)}</title><style>body{font-family:'Public Sans',Arial,sans-serif;padding:24px;color:#1b263b;}h1{font-size:1.25rem;margin-bottom:1rem;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #d0d7e2;padding:8px;vertical-align:top;}th{background:#f4f7fb;font-weight:600;} .text-center{text-align:center;} .fw-semibold{font-weight:600;} .small{font-size:0.85rem;color:#5b6c8c;}</style></head><body><h1>${escapeHtml(resumoSolicitacaoAtual.titulo || "Resumo da solicita√ß√£o")}</h1>${resumoSolicitacaoAtual.html}</body></html>`);
          janela.document.close();
          janela.focus();
          janela.print();
        };

        function exibirResumoSolicitacao(matricula, resumo) {
          if (!resumo) {
            openModal("‚ùå Erro", "<p>N√£o foi poss√≠vel exibir os dados desta solicita√ß√£o.</p>");
            return;
          }
          resumoSolicitacaoAtual = {
            ...resumo,
            matricula,
            titulo: `üìÑ Resumo da solicita√ß√£o ${matricula}`
          };
          const actions = [
            criarBotaoModal("Salvar PDF", "btn btn-primary", () => imprimirResumoSolicitacao("pdf")),
            criarBotaoModal("Imprimir", "btn btn-outline-primary", () => imprimirResumoSolicitacao("print"))
          ];
          openModal(resumoSolicitacaoAtual.titulo, resumo.html, actions);
        }

        function abrirResumoSolicitacao(matricula) {
          const matriculaLimpa = normalizeText(matricula);
          if (!matriculaLimpa) return;
          const emCache = detalhesCache.get(matriculaLimpa);
          if (emCache) {
            exibirResumoSolicitacao(matriculaLimpa, emCache);
            return;
          }

          resumoSolicitacaoAtual = null;
          openModal("‚è≥ Carregando detalhes", `<p>Buscando informa√ß√µes da matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>...</p>`);
          fetch(solicitacaoDetalheEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ matricula: matriculaLimpa, cpf })
          })
            .then(r => { if (!r.ok) throw new Error("Falha na consulta"); return r.json(); })
            .then(data => {
              const detalhes = normalizarDetalhesSolicitacao(data, matriculaLimpa);
              if (!detalhes.length) {
                openModal("‚ÑπÔ∏è Sem registros", `<p>N√£o encontramos informa√ß√µes detalhadas para a matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>.</p>`);
                return;
              }
              const resumo = montarResumoSolicitacao(matriculaLimpa, detalhes);
              detalhesCache.set(matriculaLimpa, resumo);
              exibirResumoSolicitacao(matriculaLimpa, resumo);
            })
            .catch(() => {
              openModal("‚ùå Erro", `<p>N√£o foi poss√≠vel carregar o resumo da matr√≠cula <strong>${escapeHtml(matriculaLimpa)}</strong>. Tente novamente.</p>`);
            });
        }

        function renderSolicitacoes(entries) {
          solicitacoesAtuais = Array.isArray(entries) ? entries : [];
          grid.innerHTML = "";

          const matriculaOptions = Array.from(new Map(
            solicitacoesAtuais
              .filter(item => item.matricula)
              .map(item => [item.matricula, { value: item.matricula, label: item.matricula }])
          ).values());
          setOptions(selMatricula, matriculaOptions, "Selecione a matr√≠cula");
          sincronizarMetadadosMatriculas();
          aplicarSelecaoMatriculaPreferida();

          solicitacoesAtuais.forEach(entry => {
            const col = document.createElement("div");
            col.className = "col";

            const card = document.createElement("article");
            card.className = "card h-100 shadow-sm minha-card";
            card.setAttribute("role", "button");
            card.setAttribute("tabindex", "0");
            card.setAttribute("aria-label", "Solicita√ß√£o da matr√≠cula " + entry.matricula);
            card.dataset.matricula = entry.matricula;

            const body = document.createElement("div");
            body.className = "card-body";
            const title = document.createElement("h3");
            title.className = "h6 fw-semibold text-primary mb-1";
            title.textContent = entry.matricula;
            const sub = document.createElement("p");
            sub.className = "text-muted mb-0";
            sub.textContent = entry.cargo || "Cargo n√£o informado";

            body.appendChild(title);
            body.appendChild(sub);
            card.appendChild(body);

            const abrir = () => abrirResumoSolicitacao(entry.matricula);
            card.addEventListener("click", abrir);
            card.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                abrir();
              }
            });

            col.appendChild(card);
            grid.appendChild(col);
          });

          if (!solicitacoesAtuais.length) {
            setOptions(selMatricula, [], "Selecione a matr√≠cula");
            if (emptyBox) emptyBox.textContent = emptyBoxDefaultMessage;
          } else if (emptyBox) {
            emptyBox.textContent = emptyBoxDefaultMessage;
          }
          setMinhasState(solicitacoesAtuais.length ? "ready" : "empty");
          validateUpdateForm();
        }

        function carregarMinhasSolicitacoes() {
          const atual = sanitizeCpf(cpfInput?.value);
          if (atual) cpf = atual;
          if (emptyBox) emptyBox.textContent = emptyBoxDefaultMessage;
          setMinhasState("loading");

          registrarDadosServidor(registrosServidorPreCarregados);

          if (!cpf) {
            solicitacoesAtuais = [];
            setOptions(selMatricula, [], "Selecione a matr√≠cula");
            if (emptyBox) {
              emptyBox.textContent = "Informe ou aguarde o CPF do servidor para carregar as solicita√ß√µes.";
            }
            setMinhasState("empty");
            validateUpdateForm();
            return;
          }

          if (registrosServidorPreCarregados.length) {
            renderSolicitacoes(normalizeSolicitacoes(registrosServidorPreCarregados));
          } else {
            solicitacoesAtuais = [];
            setOptions(selMatricula, [], "Selecione a matr√≠cula");
            setMinhasState("empty");
            validateUpdateForm();
          }
        }

        function atualizarLotacoes() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotOptions = dsItem
            ? Array.from(dsItem.lotacoes.values())
                .map(lot => ({
                  value: lot.value || lot.label || "",
                  label: lot.label || lot.value || ""
                }))
                .filter(opt => opt.value && opt.label)
                .sort((a, b) => a.label.localeCompare(b.label, "pt-BR"))
            : [];
          setOptions(selUnidade, lotOptions, "Selecione a unidade atual");
          setOptions(selTurno, [], "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");
          validateUpdateForm();
        }

        function atualizarTurnos() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotItem = dsItem?.lotacoes.get(slugify(selUnidade?.value));
          const turnoOptions = lotItem
            ? Array.from(lotItem.turnos.values())
                .map(turno => ({
                  value: turno.value || turno.label || "",
                  label: turno.label || turno.value || ""
                }))
                .filter(opt => opt.value && opt.label)
                .sort((a, b) => a.label.localeCompare(b.label, "pt-BR"))
            : [];
          setOptions(selTurno, turnoOptions, "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");
          validateUpdateForm();
        }

        function atualizarRegimes() {
          const dsItem = hierarquiaMapa.get(slugify(selDistrito?.value));
          const lotItem = dsItem?.lotacoes.get(slugify(selUnidade?.value));
          const turnoItem = lotItem?.turnos.get(slugify(selTurno?.value));
          const regimes = turnoItem ? Array.from(turnoItem.regimes).filter(Boolean) : [];
          const regimeOptions = regimes
            .map(reg => ({ value: reg, label: reg }))
            .sort((a, b) => a.label.localeCompare(b.label, "pt-BR"));
          setOptions(selRegime, regimeOptions, "Selecione o regime atual");
          validateUpdateForm();
        }

        function carregarDadosIniciais() {
          setOptions(selDistrito, [], "Selecione a DS/Executiva atual");
          setOptions(selUnidade, [], "Selecione a unidade atual");
          setOptions(selTurno, [], "Selecione o turno atual");
          setOptions(selRegime, [], "Selecione o regime atual");

          hierarquiaMapa.clear();
          hierarquiaCarregada = false;

          const extrairColecao = (fonte) => {
            if (!fonte) return [];
            if (Array.isArray(fonte)) return fonte;
            if (Array.isArray(fonte?.items)) return fonte.items;
            if (Array.isArray(fonte?.data)) return fonte.data;
            if (Array.isArray(fonte?.result)) return fonte.result;
            if (typeof fonte === "object") return Object.values(fonte);
            return [];
          };

          const extrairValorPreferido = (entrada, preferidos = [], fallback = []) => {
            if (entrada == null) return "";
            if (typeof entrada === "string" || typeof entrada === "number") {
              return resolveTemplateValue(entrada);
            }
            if (typeof entrada !== "object") return "";
            for (const chave of preferidos) {
              if (Object.prototype.hasOwnProperty.call(entrada, chave)) {
                const resolvido = resolveTemplateValue(entrada[chave]);
                if (resolvido) return resolvido;
              }
            }
            for (const chave of fallback) {
              const resolvido = resolveTemplateValue(entrada[chave]);
              if (resolvido) return resolvido;
            }
            return "";
          };

          const distritosLista = extrairColecao(catalogosTemplate.distritos);
          const distritosUnidadesLista = extrairColecao(catalogosTemplate.distritos_unidades);
          const unidadesTurnosLista = extrairColecao(catalogosTemplate.unidades_turnos);
          const turnosRegimesLista = extrairColecao(catalogosTemplate.turnos_regimes);

          const lotacaoParaDistrito = new Map();
          const turnoParaRegimes = new Map();

          distritosLista.forEach(item => {
            const label = extrairValorPreferido(item, ["label", "nome", "descricao", "distrito", "executiva", "ds"], ["value", "valor", "codigo", "id"]);
            const value = extrairValorPreferido(item, ["value", "valor", "codigo", "id", "distrito", "executiva", "ds"], ["label", "nome", "descricao"]);
            const finalLabel = label || value;
            const finalValue = value || finalLabel;
            const dsKey = slugify(finalValue || finalLabel);
            if (!dsKey || !finalLabel) return;
            if (!hierarquiaMapa.has(dsKey)) {
              hierarquiaMapa.set(dsKey, { label: finalLabel, value: finalValue || finalLabel, lotacoes: new Map() });
            } else {
              const existente = hierarquiaMapa.get(dsKey);
              if (finalLabel && !existente.label) existente.label = finalLabel;
              if (finalValue && !existente.value) existente.value = finalValue;
            }
          });

          distritosUnidadesLista.forEach(item => {
            const distrito = extrairValorPreferido(item, ["distrito", "ds", "executiva", "dsExecutiva"], ["label_distrito", "distritoLabel", "nome_distrito", "descricao_distrito"]);
            const unidade = extrairValorPreferido(item, ["unidade", "lotacao", "descricao", "nome"], ["label", "value"]);
            const dsKey = slugify(distrito || "");
            const lotKey = slugify(unidade || "");
            if (!dsKey || !lotKey) return;
            if (!hierarquiaMapa.has(dsKey)) {
              hierarquiaMapa.set(dsKey, { label: distrito || unidade, value: distrito || unidade, lotacoes: new Map() });
            }
            const dsItem = hierarquiaMapa.get(dsKey);
            if (distrito) {
              if (!dsItem.label) dsItem.label = distrito;
              if (!dsItem.value) dsItem.value = distrito;
            }
            if (!dsItem.lotacoes.has(lotKey)) {
              dsItem.lotacoes.set(lotKey, { label: unidade || "", value: unidade || "", turnos: new Map() });
            } else {
              const existente = dsItem.lotacoes.get(lotKey);
              if (unidade && !existente.label) existente.label = unidade;
              if (unidade && !existente.value) existente.value = unidade;
            }
            lotacaoParaDistrito.set(lotKey, dsKey);
          });

          unidadesTurnosLista.forEach(item => {
            const unidade = extrairValorPreferido(item, ["unidade", "lotacao", "descricao", "nome"], ["label", "value"]);
            const turno = extrairValorPreferido(item, ["turno", "nome_turno", "descricao_turno"], ["label", "value", "nome"]);
            const lotKey = slugify(unidade || "");
            const turnoKey = slugify(turno || "");
            if (!lotKey || !turnoKey) return;
            const dsKey = lotacaoParaDistrito.get(lotKey);
            if (!dsKey) return;
            const dsItem = hierarquiaMapa.get(dsKey);
            if (!dsItem) return;
            if (!dsItem.lotacoes.has(lotKey)) {
              dsItem.lotacoes.set(lotKey, { label: unidade || "", value: unidade || "", turnos: new Map() });
            }
            const lotItem = dsItem.lotacoes.get(lotKey);
            if (unidade) {
              if (!lotItem.label) lotItem.label = unidade;
              if (!lotItem.value) lotItem.value = unidade;
            }
            if (!lotItem.turnos.has(turnoKey)) {
              lotItem.turnos.set(turnoKey, { label: turno || "", value: turno || "", regimes: new Set() });
            }
          });

          turnosRegimesLista.forEach(item => {
            const turno = extrairValorPreferido(item, ["turno", "nome_turno", "descricao_turno"], ["label", "turnoLabel", "value"]);
            const regime = extrairValorPreferido(item, ["regime", "nome_regime", "descricao_regime"], ["label", "value", "nome"]);
            const turnoKey = slugify(turno || "");
            if (!turnoKey || !regime) return;
            if (!turnoParaRegimes.has(turnoKey)) {
              turnoParaRegimes.set(turnoKey, new Set());
            }
            turnoParaRegimes.get(turnoKey).add(regime);
          });

          hierarquiaMapa.forEach(dsItem => {
            dsItem.lotacoes.forEach(lotItem => {
              lotItem.turnos.forEach(turnoItem => {
                const regimes = turnoParaRegimes.get(slugify(turnoItem.label || turnoItem.value));
                if (regimes) {
                  regimes.forEach(reg => turnoItem.regimes.add(reg));
                }
              });
            });
          });

          const dsOptions = Array.from(hierarquiaMapa.values())
            .map(item => ({ value: item.value || item.label, label: item.label || item.value || "" }))
            .filter(opt => opt.value && opt.label)
            .sort((a, b) => a.label.localeCompare(b.label, "pt-BR"));

          setOptions(selDistrito, dsOptions, "Selecione a DS/Executiva atual");

          hierarquiaCarregada = true;
          aplicarHierarquiaPreferida();
          validateUpdateForm();
        }

        selDistrito?.addEventListener("change", atualizarLotacoes);
        selUnidade?.addEventListener("change", atualizarTurnos);
        selTurno?.addEventListener("change", atualizarRegimes);

        // Valida√ß√£o simples do formul√°rio de atualiza√ß√£o
        const btnAtualizar = document.getElementById("btn-atualizar-cadastro");
        const inWhats = document.getElementById("in-whatsapp");
        const inTelAlt = document.getElementById("in-telefone-alt");
        const inEmail = document.getElementById("in-email");
        const only11 = (v) => onlyDigits(v).slice(0, 11);
        function validateUpdateForm() {
          if (inWhats) inWhats.value = only11(inWhats.value);
          if (inTelAlt) inTelAlt.value = only11(inTelAlt.value);
          if (inCep) inCep.value = onlyDigits(inCep.value).slice(0,8);

          const emailOk = !!(inEmail?.value && /.+@.+\..+/.test(inEmail.value));
          const wppOk = !!(inWhats?.value && inWhats.value.length === 11);
          const cepOk = !!(inCep?.value && inCep.value.length === 8);
          const matOk = !!selMatricula?.value;
          const dsOk = !!selDistrito?.value;
          const unOk = !!selUnidade?.value;
          const turnoOk = !!selTurno?.value;
          const regimeOk = !!selRegime?.value;

          btnAtualizar.disabled = !(emailOk && wppOk && cepOk && matOk && dsOk && unOk && turnoOk && regimeOk);
        }

        const handleMatriculaChange = () => {
          const selecionada = resolveTemplateValue(selMatricula?.value);
          resetarPreferenciasHierarquia();
          let dadosMatricula = null;

          if (selecionada) {
            valoresPreferidos.matricula = selecionada;
            dadosMatricula = vinculosPreferidosPorMatricula.get(selecionada);
            if (dadosMatricula) {
              definirPreferenciasHierarquia(dadosMatricula);
              dadosServidor = { ...(dadosServidor || {}), ...dadosMatricula };
            }
            aplicarDadosServidor(false);
            aplicarDadosVinculoNosSelects(dadosMatricula);
          } else {
            if (dadosServidor) {
              dadosServidor = { ...dadosServidor, matricula: "" };
            }
            aplicarDadosServidor(false);
            [selDistrito, selUnidade, selTurno, selRegime].forEach(limparSelecao);
          }

          sincronizarMetadadosMatriculas();
          aplicarHierarquiaPreferida();
          validateUpdateForm();
        };

        selMatricula?.addEventListener("change", handleMatriculaChange);
        [ "input","change","blur" ].forEach(evt => {
          inWhats?.addEventListener(evt, validateUpdateForm);
          inTelAlt?.addEventListener(evt, validateUpdateForm);
          inEmail?.addEventListener(evt, validateUpdateForm);
          inCep?.addEventListener(evt, validateUpdateForm);
          inLogradouro?.addEventListener(evt, validateUpdateForm);
          inNumero?.addEventListener(evt, validateUpdateForm);
          inComplemento?.addEventListener(evt, validateUpdateForm);
          inBairro?.addEventListener(evt, validateUpdateForm);
          inCidade?.addEventListener(evt, validateUpdateForm);
          inUf?.addEventListener(evt, validateUpdateForm);
          [selMatricula, selDistrito, selUnidade, selTurno, selRegime].forEach(el => {
            el?.addEventListener(evt, validateUpdateForm);
          });
        });

        btnAtualizar?.addEventListener("click", function () {
          const cpfAtual = sanitizeCpf(cpfInput?.value);
          if (cpfAtual) cpf = cpfAtual;
          const payload = {
            cpf,
            matricula: selMatricula?.value || "",
            whatsapp: inWhats?.value || "",
            telefoneAlternativo: inTelAlt?.value || "",
            email: inEmail?.value || "",
            cep: inCep?.value || "",
            logradouro: inLogradouro?.value || "",
            numero: inNumero?.value || "",
            complemento: inComplemento?.value || "",
            bairro: inBairro?.value || "",
            cidade: inCidade?.value || "",
            uf: (inUf?.value || "").toUpperCase(),
            dsExecutiva: selDistrito?.value || "",
            unidade: selUnidade?.value || "",
            turno: selTurno?.value || "",
            regime: selRegime?.value || ""
          };

          if (!atualizarCadastroEndpoint) {
            openModal("‚úÖ Sucesso (demo)",
              "<p>Os dados seriam enviados para a API definida em <code>atualizarCadastroEndpoint</code>.</p>" +
              "<pre class='mb-0' style='white-space:pre-wrap;background:#f6f8fb;border-radius:.5rem;padding:.5rem'>" +
              JSON.stringify(payload, null, 2) + "</pre>"
            );
            return;
          }

          fetch(atualizarCadastroEndpoint, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)})
            .then(r => r.json().catch(() => ({})))
            .then(resp => openModal("‚úÖ Sucesso", "<pre class='mb-0' style='white-space:pre-wrap;background:#f6f8fb;border-radius:.5rem;padding:.5rem'>" + JSON.stringify(resp, null, 2) + "</pre>"))
            .catch(() => openModal("‚ùå Erro", "<p>N√£o foi poss√≠vel enviar a atualiza√ß√£o. Tente novamente.</p>"));
        });

        function iniciarFluxosCpf() {
          carregarMinhasSolicitacoes();
          carregarDadosIniciais();
          validateUpdateForm();
        }

        const atualizarCpfAtual = () => {
          const atual = sanitizeCpf(cpfInput?.value);
          if (atual === cpf) return;
          cpf = atual;
          iniciarFluxosCpf();
        };

        iniciarFluxosCpf();

        if (cpfInput) {
          cpfInput.addEventListener("input", atualizarCpfAtual);
          cpfInput.addEventListener("change", atualizarCpfAtual);

          let cpfPoller = null;
          const encerrarPollerSePossivel = () => {
            if (cpf && cpfPoller) {
              clearInterval(cpfPoller);
              cpfPoller = null;
            }
          };

          if (typeof MutationObserver !== "undefined") {
            const observer = new MutationObserver(() => {
              atualizarCpfAtual();
              encerrarPollerSePossivel();
            });
            observer.observe(cpfInput, { attributes: true, attributeFilter: ["value"] });
          }

          if (!cpf) {
            cpfPoller = setInterval(() => {
              atualizarCpfAtual();
              encerrarPollerSePossivel();
            }, 250);
            setTimeout(() => {
              if (cpfPoller) {
                clearInterval(cpfPoller);
                cpfPoller = null;
              }
            }, 15000);
          }
        }
      });
    </script>
  </body>
</html>
