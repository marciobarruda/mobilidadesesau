<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SESAU • Formulário de Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }
      *,*::before,*::after{box-sizing:border-box}
      body{
        font-family:"Public Sans",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        background:var(--surface);color:var(--text-strong);min-height:100vh
      }
      header.site-header{
        background:url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
        color:#fff;padding:3rem 0 2.25rem
      }
      header .lead{color:rgba(255,255,255,.9);font-size:1rem;line-height:1.65;max-width:100%}
      .badge-open{display:inline-flex;align-items:center;gap:.5rem;font-size:.95rem;font-weight:600;padding:.45rem .9rem;border-radius:999px;background:rgba(255,255,255,.14)}
      .section-title{display:flex;align-items:center;gap:.65rem;font-weight:700;font-size:1.2rem;color:var(--text-strong)}
      .section-title::before{content:"";display:inline-block;width:32px;height:3px;border-radius:999px;background:var(--brand-highlight)}
      .card{border-radius:4px;overflow:hidden}
      .card-programa{border:1px solid rgba(0,83,164,.08);border-radius:4px;background:var(--surface-strong);box-shadow:0 16px 34px rgba(0,45,98,.08)}
      .card-programa .card-header{border-bottom:1px solid rgba(0,83,164,.08);background:linear-gradient(180deg,#fff 0%,#f5f8fc 100%);padding:1.25rem 1.25rem 1rem}
      .collapsible-form{border:1px solid rgba(0,83,164,.15);border-radius:4px;background:rgba(0,83,164,.05);padding:1rem 1.25rem}
      .collapsible-form summary{font-weight:600;cursor:pointer;display:flex;align-items:center;gap:.5rem}
      .collapsible-form summary::marker,.collapsible-form summary::-webkit-details-marker{display:none}
      .collapsible-form summary::before{content:"➕";font-size:.9rem;transition:transform .2s ease}
      .collapsible-form[open] summary::before{transform:rotate(45deg)}
      .table-editable input, .table-editable select{width:100%;border:1px solid var(--border-color);border-radius:.25rem;padding:.35rem .5rem}
      .table thead th{white-space:nowrap}
      .actions-cell button{min-width:38px}
      .muted{color:var(--text-muted)}
      footer{color:var(--text-muted);padding:2rem 0 1.5rem;font-size:.9rem}
      @media (max-width: 768px){header.site-header{padding:2.25rem 0 1.75rem}.badge-open{width:100%;justify-content:center}}
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <span class="badge-open">Secretaria de Saúde — SESAU • Prefeitura do Recife</span>
        <h1 class="display-6 h1-title mt-3 mb-2">Formulário — Mobilidade Interna</h1>
        <p class="lead mb-0">Preencha os dados para cadastrar ou atualizar sua solicitação de mobilidade.</p>
      </div>
    </header>

    <main class="container py-4">
      <!-- Identificação -->
      <section class="card card-programa mb-4">
        <div class="card-header py-3"><div class="section-title">Identificação</div></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label" for="matricula">Matrícula</label>
              <select id="matricula" class="form-select" required></select>
              <div class="text-muted small">Opções carregadas via CPF.</div>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="admissao">Data de admissão</label>
              <input id="admissao" class="form-control" readonly />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="nascimento">Data de nascimento</label>
              <input id="nascimento" class="form-control" readonly />
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="nome">Nome</label>
              <input id="nome" class="form-control" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="cargo">Cargo</label>
              <input id="cargo" class="form-control" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="grupo">Grupo</label>
              <input id="grupo" class="form-control" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="vinculo">Vínculo</label>
              <input id="vinculo" class="form-control" readonly />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="carga">Carga horária de atuação</label>
              <input id="carga" class="form-control" readonly />
            </div>
          </div>
        </div>

      </section>

      <!-- Endereço e Contatos -->
      <section class="card card-programa mb-4">
        <div class="card-header py-3"><div class="section-title">Endereço e Contatos</div></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label" for="cep">CEP</label>
              <input id="cep" class="form-control" placeholder="00000-000" />
              <div class="small-note">Autopreenche via BrasilAPI.</div>
            </div>
            <div class="col-12 col-md-5">
              <label class="form-label" for="logradouro">Logradouro</label>
              <input id="logradouro" class="form-control" />
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label" for="numero">Número</label>
              <input id="numero" class="form-control" />
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label" for="complemento">Complemento</label>
              <input id="complemento" class="form-control" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="bairro">Bairro</label>
              <input id="bairro" class="form-control" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="cidade">Cidade</label>
              <input id="cidade" class="form-control" />
            </div>
            <div class="col-12 col-md-2">
              <label class="form-label" for="uf">UF</label>
              <input id="uf" maxlength="2" class="form-control" placeholder="PE" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="whatsapp">WhatsApp</label>
              <input id="whatsapp" class="form-control" placeholder="DDD + número" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="telalt">Telefone alternativo</label>
              <input id="telalt" class="form-control" placeholder="DDD + número" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="email">E-mail</label>
              <input id="email" class="form-control" type="email" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="email2">Confirme o e-mail</label>
              <input id="email2" class="form-control" type="email" />
            </div>
          </div>
        </div>
      </section>

      <!-- Dados de Lotação Atual -->
      <section class="card card-programa mb-4">
        <div class="card-header py-3"><div class="section-title">Dados de Lotação Atual</div></div>
        <div class="card-body">
          <div class="mb-2 muted">Dependentes por seleção</div>
          <div class="row g-3">
            <div class="col-12 col-md-3">
              <label class="form-label" for="dsSelect">Distrito atual</label>
              <select id="dsSelect" class="form-select">
                <option value="" selected disabled>Selecione...</option>
                <option>SEAA - JURIDICO</option>
                <option>SEAB</option>
                <option>DS II</option>
                <option>DS I</option>
                <option>DS IV</option>
                <option>SECOGE</option>
                <option>SEGTES</option>
                <option>SEAF</option>
                <option>SEINFRA</option>
                <option>SEVS</option>
                <option>DS III</option>
                <option>DS VII</option>
                <option>DS VI</option>
                <option>DS VIII</option>
                <option>DS V</option>
                <option>GABINETE SESAU</option>
                <option>SERMAC</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" for="unidadeSelect">Lotação atual</label>
              <select id="unidadeSelect" class="form-select" disabled>
                <option>Selecione o distrito...</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" for="turnoSelect">Horário atual</label>
              <select id="turnoSelect" class="form-select" disabled>
                <option>Selecione a unidade...</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label" for="regimeSelect">Regime de trabalho</label>
              <select id="regimeSelect" class="form-select" disabled>
                <option>Selecione a unidade...</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Preferências -->
      <section class="card card-programa mb-4">
        <div class="card-header py-3 d-flex align-items-center justify-content-between">
          <div class="section-title">Preferências (máx. 10)</div>
          <button id="btnAddLinha" class="btn btn-primary">Adicionar linha</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle table-fixed" id="tabelaPrefs">
              <thead>
                <tr>
                  <th style="width:100px">Prioridade</th>
                  <th>Distrito</th>
                  <th>Lotação</th>
                  <th style="width:170px">Data de solicitação</th>
                  <th style="width:190px">Data de credenciamento</th>
                  <th class="table-actions">Ações</th>
                </tr>
              </thead>
              <tbody id="prefsBody">
                <!-- Linhas via JS -->
              </tbody>
            </table>
          </div>
          <div class="small-note mt-2">Linhas carregadas automaticamente não podem ser editadas (apenas removidas). A ordenação segue a prioridade (numérica).</div>
        </div>
      </section>

      <div class="d-flex justify-content-end mb-5">
        <button class="btn btn-success" id="btnEnviar">Enviar formulário</button>
      </div>
    </main>

    <!-- Modal Adicionar Unidade -->
    <div class="modal-backdrop-like" id="modalBackdrop" aria-hidden="true">
      <div class="modal-card">
        <div class="d-flex align-items-start justify-content-between mb-2">
          <div class="h5 mb-0">Adicionar unidade</div>
          <button class="btn btn-sm btn-outline-secondary" id="btnModalFechar">Fechar</button>
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label" for="mDs">Distrito</label>
            <select id="mDs" class="form-select">
              <option value="" selected disabled>Selecione...</option>
              <option>SEAA - JURIDICO</option>
              <option>SEAB</option>
              <option>DS II</option>
              <option>DS I</option>
              <option>DS IV</option>
              <option>SECOGE</option>
              <option>SEGTES</option>
              <option>SEAF</option>
              <option>SEINFRA</option>
              <option>SEVS</option>
              <option>DS III</option>
              <option>DS VII</option>
              <option>DS VI</option>
              <option>DS VIII</option>
              <option>DS V</option>
              <option>GABINETE SESAU</option>
              <option>SERMAC</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="mUnidade">Unidade</label>
            <select id="mUnidade" class="form-select" disabled>
              <option>Selecione o distrito...</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="mTurno">Turno</label>
            <select id="mTurno" class="form-select" disabled>
              <option>Selecione a unidade...</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label" for="mRegime">Regime</label>
            <select id="mRegime" class="form-select" disabled>
              <option>Selecione a unidade...</option>
            </select>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2 justify-content-end">
          <button class="btn btn-primary" id="btnModalConfirmar">Adicionar</button>
        </div>
      </div>
    </div>

    <script>
      // ======== Helpers ========
      const postJSON = async (url, body) => {
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body || {}) });
        if (!res.ok) throw new Error('Erro de rede');
        return res.json();
      };
      const toBRDate = (d) => {
        if (!d) return '';
        const dt = (d instanceof Date) ? d : new Date(d);
        return isNaN(dt) ? '' : dt.toLocaleDateString('pt-BR');
      };
      const todayBR = () => toBRDate(new Date());
      const isCEP = (v) => /^(\d{5}-?\d{3})$/.test((v||'').trim());
      const sanitizeUF = (v) => (v||'').toUpperCase().slice(0,2);

      // ======== Mock bindings vindos do template (preenchidos em produção) ========
      const BIND = {
        dadosComuns: {
          nome: `{{ $json.data.dadosComuns.nome_servidor }}`,
          nascimento: `{{ $json.data.dadosComuns.nascimento }}`,
          whatsapp: `{{ $json.data.dadosComuns.whatsapp }}`,
          telalternativo: `{{ $json.data.dadosComuns.telalternativo }}`,
          endereco: {
            cep: `{{ $json.data.dadosComuns.endereco.cep }}`,
            logradouro: `{{ $json.data.dadosComuns.endereco.logradouro }}`,
            numero: `{{ $json.data.dadosComuns.endereco.numero }}`,
            complemento: `{{ $json.data.dadosComuns.endereco.complemento }}`,
            bairro: `{{ $json.data.dadosComuns.endereco.bairro }}`,
            cidade: `{{ $json.data.dadosComuns.endereco.cidade }}`,
            uf: `{{ $json.data.dadosComuns.endereco.uf }}`
          },
          email: `{{ $json.data.dadosComuns.email }}`
        },
        vinculos: [
          { matricula: `{{ $json.data.vinculos[0].matricula }}`, nome: `{{ $json.data.vinculos[0].nome }}`, cargo: `{{ $json.data.vinculos[0].cargo }}`, grupo: `{{ $json.data.vinculos[0].grupo }}`, admissao: `{{ $json.data.vinculos[0].admissao }}`, nascimento: `{{ $json.data.vinculos[0].nascimento }}`, vinculo: `{{ $json.data.vinculos[0].vinculo }}`, carga_horaria: `{{ $json.data.vinculos[0].carga_horaria }}` },
          { matricula: `{{ $json.data.vinculos[1].matricula }}`, nome: `{{ $json.data.vinculos[1].nome }}`, cargo: `{{ $json.data.vinculos[1].cargo }}`, grupo: `{{ $json.data.vinculos[1].grupo }}`, admissao: `{{ $json.data.vinculos[1].admissao }}`, nascimento: `{{ $json.data.vinculos[1].nascimento }}`, vinculo: `{{ $json.data.vinculos[1].vinculo }}`, carga_horaria: `{{ $json.data.vinculos[1].carga_horaria }}` }
        ]
      };

      // ======== Estado ========
      const state = {
        prefs: [], // {prioridade, distrito, lotacao, data_solicitacao, data_credenciamento, imported:boolean}
        max: 10
      };

      // ======== CEP -> BrasilAPI ========
      async function fillByCEP(cep) {
        if (!isCEP(cep)) return;
        try {
          const clean = cep.replace(/\D/g, '');
          const r = await fetch(`https://brasilapi.com.br/api/cep/v2/${clean}`);
          if (!r.ok) return;
          const j = await r.json();
          document.getElementById('logradouro').value = j.street || '';
          document.getElementById('bairro').value = j.neighborhood || '';
          document.getElementById('cidade').value = j.city || '';
          document.getElementById('uf').value = (j.state || '').slice(0,2);
        } catch {}
      }

      // ======== Render Tabela ========
      function renderPrefs(){
        const tbody = document.getElementById('prefsBody');
        tbody.innerHTML = '';
        // ordenar por prioridade
        state.prefs.sort((a,b)=> (a.prioridade||999)-(b.prioridade||999));
        state.prefs.forEach((row, idx) => {
          const tr = document.createElement('tr');
          const pCell = document.createElement('td');
          if (row.imported) {
            pCell.textContent = row.prioridade;
          } else {
            pCell.innerHTML = `<input type="number" min="1" class="form-control form-control-sm" value="${row.prioridade}" data-k="prioridade"/>`;
          }
          const dCell = document.createElement('td');
          dCell.textContent = row.distrito || '';
          const lCell = document.createElement('td');
          if (row.imported) {
            lCell.textContent = row.lotacao || '';
          } else {
            lCell.innerHTML = `<input class="form-control form-control-sm" value="${row.lotacao||''}" data-k="lotacao"/>`;
          }
          const dsCell = document.createElement('td');
          dsCell.textContent = toBRDate(row.data_solicitacao);
          const dcCell = document.createElement('td');
          dcCell.textContent = toBRDate(row.data_credenciamento);
          const aCell = document.createElement('td');
          const del = document.createElement('button');
          del.className = 'btn btn-sm btn-outline-danger';
          del.textContent = 'Excluir';
          del.addEventListener('click', () => { state.prefs.splice(idx,1); updateAddBtn(); renderPrefs(); });
          aCell.appendChild(del);

          // bind editable inputs
          tr.addEventListener('input', (e)=>{
            const t = e.target; if (!t.dataset.k) return;
            state.prefs[idx][t.dataset.k] = t.value;
          });

          tr.append(pCell,dCell,lCell,dsCell,dcCell,aCell);
          if (row.imported) tr.classList.add('table-light');
          tbody.appendChild(tr);
        });
      }

      function updateAddBtn(){
        const btn = document.getElementById('btnAddLinha');
        btn.textContent = state.prefs.length >= state.max ? 'Limite atingido' : 'Adicionar unidade';
        btn.disabled = state.prefs.length >= state.max;
      }

      // ======== Encadeamentos (cards e modal) ========
      async function loadUnidades(ds, targetSel){
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>'; sel.disabled = true;
        try{
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/unidades',{ ds });
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data||[]).forEach(u=>{ if(u&&u.unidade) sel.insertAdjacentHTML('beforeend',`<option>${u.unidade}</option>`); });
          sel.disabled = false;
        }catch{ sel.innerHTML = '<option>Falha ao carregar</option>'; }
      }
      async function loadTurnos(unidade, targetSel){
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>'; sel.disabled = true;
        try{
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turnos',{ unidade });
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data||[]).forEach(t=>{ if(t&&t.turno) sel.insertAdjacentHTML('beforeend',`<option>${t.turno}</option>`); });
          sel.disabled = false;
        }catch{ sel.innerHTML = '<option>Falha ao carregar</option>'; }
      }
      async function loadRegimes(unidade, targetSel){
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>'; sel.disabled = true;
        try{
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/regimes',{ unidade });
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data||[]).forEach(r=>{ if(r&&r.regime) sel.insertAdjacentHTML('beforeend',`<option>${r.regime}</option>`); });
          sel.disabled = false;
        }catch{ sel.innerHTML = '<option>Falha ao carregar</option>'; }
      }

      // ======== Matrícula -> preencher identificação + carregar preferências ========
      function fillIdentificacaoFromVinculo(matricula){
        const v = (BIND.vinculos||[]).find(x => (x&&x.matricula&&x.matricula.toString()===matricula.toString()));
        const safe = (s) => (s && s !== 'undefined' && s !== 'null') ? s : '';
        // Nome e nascimento são carregados de dadosComuns e NÃO devem ser sobrescritos
        document.getElementById('admissao').value = toBRDate(safe(v?.admissao));
        document.getElementById('cargo').value = safe(v?.cargo);
        document.getElementById('grupo').value = safe(v?.grupo);
        document.getElementById('vinculo').value = safe(v?.vinculo);
        document.getElementById('carga').value = safe(v?.carga_horaria);
      }{
        const v = (BIND.vinculos||[]).find(x => (x&&x.matricula&&x.matricula.toString()===matricula.toString()));
        const safe = (s) => (s && s !== 'undefined' && s !== 'null') ? s : '';
        document.getElementById('admissao').value = toBRDate(safe(v?.admissao));
        document.getElementById('nascimento').value = toBRDate(safe(v?.nascimento));
        document.getElementById('nome').value = safe(v?.nome);
        document.getElementById('cargo').value = safe(v?.cargo);
        document.getElementById('vinculo').value = safe(v?.vinculo);
        document.getElementById('carga').value = safe(v?.carga);
      }

      async function loadPreferenciasByMatricula(matricula){
        try{
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2',{ matricula });
          // mapear e limitar a 10
          const imported = (Array.isArray(data)? data: []).slice(0,state.max).map(item=>({
            prioridade: item.prioridade,
            distrito: item.distrito,
            lotacao: item.lotacao,
            data_solicitacao: item.data_solicitacao,
            data_credenciamento: item.data_credenciamento,
            imported: true
          }));
          state.prefs = imported; // substitui pelo retorno
          updateAddBtn();
          renderPrefs();
        }catch{
          // falhou? apenas limpa
          state.prefs = [];
          updateAddBtn();
          renderPrefs();
        }
      }

      // ======== Inicialização ========
      function populateMatriculas(){
        const sel = document.getElementById('matricula');
        sel.innerHTML = '';
        const opts = [];
        if (BIND.vinculos[0]?.matricula && BIND.vinculos[0].matricula !== 'undefined') opts.push(BIND.vinculos[0].matricula);
        if (BIND.vinculos[1]?.matricula && BIND.vinculos[1].matricula !== 'undefined' && String(BIND.vinculos[1].matricula).trim() !== '') opts.push(BIND.vinculos[1].matricula);
        if (!opts.length){ sel.innerHTML = '<option disabled selected>Sem matrículas disponíveis</option>'; sel.disabled = true; return; }
        sel.insertAdjacentHTML('beforeend','<option value="" disabled selected>Selecione...</option>');
        opts.forEach(v => sel.insertAdjacentHTML('beforeend',`<option>${v}</option>`));
      }

      function populateEnderecoContato(){
        const dc = BIND.dadosComuns||{}; const e = dc.endereco||{};
        const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = (val&&val!=='undefined'&&val!=='null')? val: ''; };
        set('cep', e.cep); set('logradouro', e.logradouro); set('numero', e.numero); set('complemento', e.complemento);
        set('bairro', e.bairro); set('cidade', e.cidade); set('uf', sanitizeUF(e.uf));
        set('whatsapp', dc.whatsapp); set('telalt', dc.telalternativo); set('email', dc.email);
      }

      // ======== Modal ========
      function openModal(){ document.getElementById('modalBackdrop').classList.add('active'); }
      function closeModal(){ document.getElementById('modalBackdrop').classList.remove('active'); }

      // ======== Eventos ========
      document.getElementById('cep').addEventListener('change', (e)=> fillByCEP(e.target.value));
      document.getElementById('uf').addEventListener('input', (e)=> e.target.value = sanitizeUF(e.target.value));

      document.getElementById('dsSelect').addEventListener('change', (e)=>{
        const v = e.target.value; if (v) loadUnidades(v,'unidadeSelect');
      });
      document.getElementById('unidadeSelect').addEventListener('change', (e)=>{
        const u = e.target.value; if (u){ loadTurnos(u,'turnoSelect'); loadRegimes(u,'regimeSelect'); }
      });

      document.getElementById('mDs').addEventListener('change', (e)=>{
        const v = e.target.value; if (v) loadUnidades(v,'mUnidade');
      });
      document.getElementById('mUnidade').addEventListener('change', (e)=>{
        const u = e.target.value; if (u){ loadTurnos(u,'mTurno'); loadRegimes(u,'mRegime'); }
      });

      document.getElementById('matricula').addEventListener('change', async (e)=>{
        const m = e.target.value; if(!m) return;
        fillIdentificacaoFromVinculo(m);
        await loadPreferenciasByMatricula(m);
      });

      document.getElementById('btnAddLinha').addEventListener('click', ()=>{ if (state.prefs.length < state.max) openModal(); });
      document.getElementById('btnModalFechar').addEventListener('click', closeModal);
      document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });

      document.getElementById('btnModalConfirmar').addEventListener('click', ()=>{
        const ds = document.getElementById('mDs').value;
        const un = document.getElementById('mUnidade').value;
        const tu = document.getElementById('mTurno').value;
        const rg = document.getElementById('mRegime').value;
        if (!ds || !un || !tu || !rg) return;
        const pr = (state.prefs.reduce((mx, r)=> Math.max(mx, Number(r.prioridade)||0), 0) + 1) || 1;
        state.prefs.push({ prioridade: pr, distrito: ds, lotacao: `${un} • ${tu} • ${rg}`, data_solicitacao: new Date(), data_credenciamento: new Date(), imported: false });
        closeModal(); updateAddBtn(); renderPrefs();
        // Reset modal fields
        ['mDs','mUnidade','mTurno','mRegime'].forEach(id=>{ const el=document.getElementById(id); el.value=''; if(id!=='mDs'){ el.innerHTML = `<option>${id==='mUnidade'?'Selecione o distrito...':'Selecione a unidade...'}</option>`; el.disabled = true; } });
      });

      document.getElementById('btnEnviar').addEventListener('click', ()=>{
        // valida e-mails simples
        const email = document.getElementById('email').value.trim();
        const email2 = document.getElementById('email2').value.trim();
        if (email && email2 && email!==email2){ alert('Os e-mails não conferem.'); return; }
        const payload = {
          matricula: document.getElementById('matricula').value || null,
          dadosPessoais: {
            admissao: document.getElementById('admissao').value || null,
            nascimento: document.getElementById('nascimento').value || null,
            nome: document.getElementById('nome').value || null,
            cargo: document.getElementById('cargo').value || null,
            vinculo: document.getElementById('vinculo').value || null,
            carga: document.getElementById('carga').value || null
          },
          endereco: {
            cep: document.getElementById('cep').value || null,
            logradouro: document.getElementById('logradouro').value || null,
            numero: document.getElementById('numero').value || null,
            complemento: document.getElementById('complemento').value || null,
            bairro: document.getElementById('bairro').value || null,
            cidade: document.getElementById('cidade').value || null,
            uf: document.getElementById('uf').value || null,
            whatsapp: document.getElementById('whatsapp').value || null,
            telalternativo: document.getElementById('telalt').value || null,
            email,
          },
          lotacaoAtual: {
            ds: document.getElementById('dsSelect').value || null,
            unidade: document.getElementById('unidadeSelect').value || null,
            turno: document.getElementById('turnoSelect').value || null,
            regime: document.getElementById('regimeSelect').value || null,
          },
          preferencias: state.prefs.map(p=>({ prioridade: Number(p.prioridade)||null, distrito: p.distrito||null, lotacao: p.lotacao||null, data_solicitacao: toBRDate(p.data_solicitacao), data_credenciamento: toBRDate(p.data_credenciamento), imported: !!p.imported }))
        };
        console.log('Payload formulário mobilidade:', payload);
        alert('Dados preparados para envio. Veja o console.');
      });

      // ======== Boot ========
      (function init(){
        populateMatriculas();
        populateEnderecoContato();
        // Carrega nome e nascimento independentemente da matrícula
        const dc = BIND.dadosComuns || {};
        document.getElementById('nome').value = (dc.nome && dc.nome!=='undefined' && dc.nome!=='null') ? dc.nome : '';
        document.getElementById('nascimento').value = toBRDate(dc.nascimento);
        updateAddBtn();
      })();
    </script>
  </body>
</html>
