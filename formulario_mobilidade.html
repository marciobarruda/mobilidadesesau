<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SESAU • Formulário de Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        font-family: "Public Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }
      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
        color: #fff;
        padding: 3rem 0 2.25rem;
      }
      header .lead {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1rem;
        line-height: 1.65;
        max-width: 100%;
      }
      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.14);
      }
      .section-title {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-strong);
      }
      .section-title::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }
      .card {
        border-radius: 4px;
        overflow: hidden;
      }
      .card-programa {
        border: 1px solid rgba(0, 83, 164, 0.08);
        border-radius: 4px;
        background: var(--surface-strong);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
      }
      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 83, 164, 0.08);
        background: linear-gradient(180deg, #fff 0%, #f5f8fc 100%);
        padding: 1.25rem 1.25rem 1rem;
      }
      .muted {
        color: var(--text-muted);
      }
      .actions-cell {
        white-space: normal;
        vertical-align: middle;
      }
      .actions-cell .actions-wrapper {
        display: inline-flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 0.35rem;
        width: 100%;
      }
      .uppercase {
        text-transform: uppercase;
      }
      .small-note {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .table thead th {
        white-space: nowrap;
      }
      .table-fixed {
        table-layout: fixed;
      }
      .modal-alert-title {
        color: #dc3545;
      }
      .alert-list {
        padding-left: 1.1rem;
      }
      .modal-branding {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .modal-branding img {
        height: 48px;
        width: auto;
      }
      .resumo-card {
        border: 1px solid rgba(0, 83, 164, 0.12);
        border-radius: 12px;
        background: linear-gradient(180deg, #ffffff 0%, rgba(244, 247, 251, 0.8) 100%);
        box-shadow: 0 18px 46px rgba(0, 35, 79, 0.15);
      }
      .resumo-card .meta-label {
        display: block;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
      }
      .resumo-card .meta-value {
        font-weight: 600;
        font-size: 1.05rem;
        color: var(--text-strong);
      }
      .resumo-table thead {
        background: #0053a4;
        color: #fff;
      }
      .resumo-table th {
        font-weight: 600;
      }
      #printComprovante {
        background: #fff;
        border-radius: 12px;
        border: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 24px 80px rgba(0, 37, 84, 0.18);
        overflow: hidden;
        max-width: 960px;
        margin: 0 auto;
        color: var(--text-strong);
      }
      #printComprovante .receipt-header {
        background: linear-gradient(135deg, #0053a4, #003a73);
        color: #fff;
        display: flex;
        justify-content: space-between;
        gap: 2rem;
        padding: 1.75rem 2rem;
        align-items: flex-start;
      }
      #printComprovante .receipt-header .brand {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
      }
      #printComprovante .receipt-header .brand img {
        height: 60px;
        width: auto;
      }
      #printComprovante .receipt-header .brand strong {
        display: block;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }
      #printComprovante .receipt-header .brand span {
        display: block;
        font-size: 0.9rem;
        opacity: 0.85;
      }
      #printComprovante .receipt-header .protocol {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        text-align: right;
        min-width: 180px;
      }
      #printComprovante .receipt-header .protocol .label {
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.85;
      }
      #printComprovante .receipt-header .protocol .value {
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      #printComprovante .receipt-body {
        padding: 2rem;
      }
      #printComprovante .receipt-body h5,
      #printComprovante .receipt-body h4 {
        font-weight: 700;
        color: #003a73;
      }
      #printComprovante .receipt-intro p {
        margin-bottom: 0;
        color: var(--text-muted);
      }
      #printComprovante .receipt-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
      }
      #printComprovante .receipt-info-item {
        background: rgba(0, 83, 164, 0.06);
        border-radius: 10px;
        padding: 1rem 1.25rem;
      }
      #printComprovante .receipt-info-item .info-label {
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #003a73;
        font-weight: 600;
      }
      #printComprovante .receipt-info-item .info-value {
        display: block;
        margin-top: 0.35rem;
        font-size: 1rem;
        font-weight: 600;
      }
      #printComprovante .receipt-table {
        width: 100%;
        border-collapse: collapse;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
      }
      #printComprovante .receipt-table thead {
        background: #0053a4;
        color: #fff;
      }
      #printComprovante .receipt-table th,
      #printComprovante .receipt-table td {
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(0, 83, 164, 0.12);
      }
      #printComprovante .receipt-table tbody tr:nth-child(even) {
        background: rgba(0, 83, 164, 0.03);
      }
      #printComprovante .receipt-footer {
        margin-top: 2rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        text-align: right;
      }
      @media print {
        body * {
          visibility: hidden !important;
        }
        #printComprovante,
        #printComprovante * {
          visibility: visible !important;
        }
        #printComprovante {
          position: absolute;
          inset: 0;
          margin: 0 auto;
          box-shadow: none;
        }
      }
      @media (max-width: 768px) {
        header.site-header {
          padding: 2.25rem 0 1.75rem;
        }
        .badge-open {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <span class="badge-open">Secretaria de Saúde — SESAU • Prefeitura do Recife</span>
        <h1 class="display-6 h1-title mt-3 mb-2">Formulário — Mobilidade Interna</h1>
        <p class="lead mb-0">
          Preencha os dados para cadastrar ou atualizar sua solicitação de mobilidade.
        </p>
      </div>
    </header>

    <main class="container py-4">
      <!-- Identificação -->
      <section class="card card-programa mb-4" aria-labelledby="identificacaoTitulo">
        <div class="card-header py-3">
          <div class="section-title" id="identificacaoTitulo">Identificação</div>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-lg-3">
              <label class="form-label" for="matricula">Matrícula</label>
              <select id="matricula" class="form-select" required data-required="true" aria-required="true"></select>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="nome">Nome</label>
              <input id="nome" class="form-control" readonly aria-readonly="true" />
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="nascimento">Data de nascimento</label>
              <input id="nascimento" class="form-control" readonly aria-readonly="true" />
            </div>
          </div>
          <div class="row g-3 align-items-end mt-0">
            <div class="col-12 col-xl-5 col-lg-6">
              <label class="form-label" for="cargo">Cargo</label>
              <input id="cargo" class="form-control" readonly aria-readonly="true" />
            </div>
            <div class="col-6 col-xl-1 col-lg-1 col-md-3">
              <label class="form-label" for="grupo">Grupo</label>
              <input id="grupo" class="form-control" readonly aria-readonly="true" />
            </div>
            <div class="col-6 col-xl-1 col-lg-2 col-md-3">
              <label class="form-label" for="vinculo">Vínculo</label>
              <input id="vinculo" class="form-control" readonly aria-readonly="true" />
            </div>
            <div class="col-6 col-xl-2 col-lg-2 col-md-4">
              <label class="form-label" for="admissao">Data de admissão</label>
              <input id="admissao" class="form-control" readonly aria-readonly="true" />
            </div>
            <div class="col-6 col-xl-1 col-lg-1 col-md-3">
              <label class="form-label" for="carga">CH</label>
              <input id="carga" class="form-control" readonly aria-readonly="true" />
            </div>
          </div>
        </div>
      </section>

      <!-- Endereço e Contatos -->
      <section class="card card-programa mb-4" aria-labelledby="enderecoTitulo">
        <div class="card-header py-3">
          <div class="section-title" id="enderecoTitulo">Endereço e Contatos</div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-sm-4 col-lg-3">
              <label class="form-label" for="cep">CEP</label>
              <input
                id="cep"
                class="form-control"
                placeholder="00000000"
                inputmode="numeric"
                data-required="true"
                data-numeric="true"
                aria-required="true"
              />
              <div class="small-note">Autopreenche via BrasilAPI.</div>
            </div>
            <div class="col-12 col-md-6 col-lg-5">
              <label class="form-label" for="logradouro">Logradouro</label>
              <input id="logradouro" class="form-control" data-required="true" aria-required="true" />
            </div>
            <div class="col-6 col-md-3 col-lg-2">
              <label class="form-label" for="numero">Número</label>
              <input
                id="numero"
                class="form-control"
                data-required="true"
                data-numeric="true"
                inputmode="numeric"
                aria-required="true"
              />
            </div>
            <div class="col-6 col-md-3 col-lg-2">
              <label class="form-label" for="complemento">Complemento</label>
              <input id="complemento" class="form-control" data-required="true" aria-required="true" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="bairro">Bairro</label>
              <input id="bairro" class="form-control" data-required="true" aria-required="true" />
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label" for="cidade">Cidade</label>
              <input id="cidade" class="form-control" data-required="true" aria-required="true" />
            </div>
            <div class="col-12 col-md-2 col-lg-1">
              <label class="form-label" for="uf">UF</label>
              <input
                id="uf"
                maxlength="2"
                class="form-control"
                placeholder="PE"
                data-required="true"
                aria-required="true"
              />
            </div>
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="whatsapp">WhatsApp</label>
              <input
                id="whatsapp"
                class="form-control"
                placeholder="DDD + número"
                data-required="true"
                data-numeric="true"
                inputmode="numeric"
                aria-required="true"
              />
            </div>
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="telalt">Telefone alternativo</label>
              <input
                id="telalt"
                class="form-control"
                placeholder="DDD + número"
                data-numeric="true"
                inputmode="numeric"
                aria-describedby="telaltHelp"
              />
              <div id="telaltHelp" class="small-note">Campo opcional.</div>
            </div>
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="email">E-mail</label>
              <input
                id="email"
                class="form-control"
                type="email"
                autocomplete="email"
                data-required="true"
                aria-required="true"
                data-uppercase="false"
              />
            </div>
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="email2">Confirme o e-mail</label>
              <input
                id="email2"
                class="form-control"
                type="email"
                autocomplete="email"
                data-required="true"
                aria-required="true"
                data-uppercase="false"
              />
            </div>
          </div>
        </div>
      </section>

      <!-- Dados de Lotação Atual -->
      <section class="card card-programa mb-4" aria-labelledby="lotacaoAtualTitulo">
        <div class="card-header py-3">
          <div class="section-title" id="lotacaoAtualTitulo">Dados de Lotação Atual</div>
        </div>
        <div class="card-body">
          <div class="mb-2 muted">Dependentes por seleção</div>
          <div class="row g-3">
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="dsSelect">Distrito atual</label>
              <select id="dsSelect" class="form-select" data-required="true" aria-required="true">
                <option value="" selected disabled>Selecione...</option>
                <option>SEAA - JURIDICO</option>
                <option>SEAB</option>
                <option>DS II</option>
                <option>DS I</option>
                <option>DS IV</option>
                <option>SECOGE</option>
                <option>SEGTES</option>
                <option>SEAF</option>
                <option>SEINFRA</option>
                <option>SEVS</option>
                <option>DS III</option>
                <option>DS VII</option>
                <option>DS VI</option>
                <option>DS VIII</option>
                <option>DS V</option>
                <option>GABINETE SESAU</option>
                <option>SERMAC</option>
              </select>
            </div>
            <div class="col-12 col-lg-4 col-md-4">
              <label class="form-label" for="unidadeSelect">Lotação atual</label>
              <select id="unidadeSelect" class="form-select" disabled data-required="true" aria-required="true">
                <option>Selecione o distrito...</option>
              </select>
            </div>
            <div class="col-12 col-lg-3 col-md-4">
              <label class="form-label" for="turnoSelect">Horário atual</label>
              <select id="turnoSelect" class="form-select" disabled data-required="true" aria-required="true">
                <option>Selecione a unidade...</option>
              </select>
            </div>
            <div class="col-12 col-lg-2 col-md-4">
              <label class="form-label" for="regimeSelect">Regime de trabalho</label>
              <select id="regimeSelect" class="form-select" disabled data-required="true" aria-required="true">
                <option>Selecione a unidade...</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Preferências -->
      <section class="card card-programa mb-4" aria-labelledby="preferenciasTitulo">
        <div class="card-header py-3 d-flex align-items-center justify-content-between">
          <div class="section-title" id="preferenciasTitulo">Seleção de Unidades</div>
          <button id="btnAddLinha" class="btn btn-primary" type="button">Adicionar Unidade</button>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle table-fixed" id="tabelaPrefs">
              <thead>
                <tr>
                  <th style="width: 90px">Prioridade</th>
                  <th style="width: 170px">Distrito</th>
                  <th>Lotação</th>
                  <th style="width: 170px">Data de solicitação</th>
                  <th style="width: 190px">Data de credenciamento</th>
                  <th class="text-center" style="width: 220px">Ações</th>
                </tr>
              </thead>
              <tbody id="prefsBody" aria-live="polite"></tbody>
            </table>
          </div>
          <div class="small-note mt-2">
            Linhas carregadas automaticamente não podem ser editadas (apenas removidas). A ordenação segue a prioridade (numérica).
          </div>
        </div>
      </section>

      <div class="d-flex justify-content-end mb-5">
        <button class="btn btn-success" id="btnEnviar" type="button">Enviar formulário</button>
      </div>
    </main>

    <!-- Modal Unidade -->
    <div
      class="modal fade"
      id="modalUnidade"
      tabindex="-1"
      aria-labelledby="modalUnidadeTitulo"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalUnidadeTitulo">Adicionar unidade</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label" for="mDs">Distrito</label>
                <select id="mDs" class="form-select">
                  <option value="" selected disabled>Selecione...</option>
                  <option>SEAA - JURIDICO</option>
                  <option>SEAB</option>
                  <option>DS II</option>
                  <option>DS I</option>
                  <option>DS IV</option>
                  <option>SECOGE</option>
                  <option>SEGTES</option>
                  <option>SEAF</option>
                  <option>SEINFRA</option>
                  <option>SEVS</option>
                  <option>DS III</option>
                  <option>DS VII</option>
                  <option>DS VI</option>
                  <option>DS VIII</option>
                  <option>DS V</option>
                  <option>GABINETE SESAU</option>
                  <option>SERMAC</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="mUnidade">Unidade</label>
                <select id="mUnidade" class="form-select" disabled>
                  <option>Selecione o distrito...</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="mTurno">Turno</label>
                <select id="mTurno" class="form-select" disabled>
                  <option>Selecione a unidade...</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="mRegime">Regime</label>
                <select id="mRegime" class="form-select" disabled>
                  <option>Selecione a unidade...</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" id="btnModalCancelar" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnModalConfirmar">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Alerta -->
    <div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaTitulo" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <span role="img" aria-label="alerta">⚠️</span>
              <span id="modalAlertaTitulo" class="modal-alert-title">Alerta</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p>Revise os campos listados antes de prosseguir:</p>
            <ul id="alertList" class="alert-list"></ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Sucesso -->
    <div class="modal fade" id="modalSucesso" tabindex="-1" aria-labelledby="modalSucessoTitulo" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-light-subtle border-0 border-bottom">
            <div class="modal-branding">
              <img
                src="https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200"
                alt="Prefeitura do Recife"
              />
              <div>
                <h5 class="modal-title mb-0" id="modalSucessoTitulo">Comprovante de solicitação</h5>
                <small class="text-muted">Resumo da solicitação enviada</small>
              </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div id="resumoSolicitacao"></div>
            <div id="printWrapper" class="d-none">
              <div id="printComprovante" aria-live="polite"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" id="btnSalvarPDF">Salvar em PDF</button>
            <button type="button" class="btn btn-primary" id="btnImprimir">Imprimir</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      const postJSON = async (url, body) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        if (!res.ok) throw new Error('Erro de rede');
        return res.json();
      };
      const toBRDate = (d) => {
        if (!d) return '';
        const dt = d instanceof Date ? d : new Date(d);
        return Number.isNaN(dt.getTime()) ? '' : dt.toLocaleDateString('pt-BR');
      };
      const todayBR = () => toBRDate(new Date());
      const isCEP = (v) => /^(\d{5}\-?\d{3})$/.test((v || '').trim());
      const sanitizeUF = (v) => (v || '').toUpperCase().slice(0, 2);
      const onlyDigits = (value) => (value || '').replace(/\D+/g, '');
      const ensureWhatsapp = (value) => {
        const digits = onlyDigits(value);
        return digits.length >= 10 && digits.length <= 11;
      };

      const sanitizeValue = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val).trim();
        return str === 'undefined' || str === 'null' ? '' : str;
      };

      const formatCPF = (value) => {
        const digits = (value || '').replace(/\D+/g, '');
        if (digits.length !== 11) return sanitizeValue(value);
        return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      };

      const COMPROVANTE_LOGO_URL = 'https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200';
      let comprovanteLogoDataUrlPromise = null;

      const getComprovanteLogoDataUrl = async () => {
        if (!comprovanteLogoDataUrlPromise) {
          comprovanteLogoDataUrlPromise = fetch(COMPROVANTE_LOGO_URL)
            .then((response) => {
              if (!response.ok) throw new Error('Erro ao carregar logotipo');
              return response.blob();
            })
            .then(
              (blob) =>
                new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onloadend = () => resolve(reader.result);
                  reader.onerror = () => reject(new Error('Falha ao converter logotipo'));
                  reader.readAsDataURL(blob);
                })
            )
            .catch(() => null);
        }
        return comprovanteLogoDataUrlPromise;
      };

      const BIND = {
        dadosComuns: {
          nome: `{{ $json.data.dadosComuns.nome_servidor }}`,
          nascimento: `{{ $json.data.dadosComuns.nascimento }}`,
          cpf: `{{ $json.data.dadosComuns.cpf }}`,
          whatsapp: `{{ $json.data.dadosComuns.whatsapp }}`,
          telalternativo: `{{ $json.data.dadosComuns.telalternativo }}`,
          endereco: {
            cep: `{{ $json.data.dadosComuns.endereco.cep }}`,
            logradouro: `{{ $json.data.dadosComuns.endereco.logradouro }}`,
            numero: `{{ $json.data.dadosComuns.endereco.numero }}`,
            complemento: `{{ $json.data.dadosComuns.endereco.complemento }}`,
            bairro: `{{ $json.data.dadosComuns.endereco.bairro }}`,
            cidade: `{{ $json.data.dadosComuns.endereco.cidade }}`,
            uf: `{{ $json.data.dadosComuns.endereco.uf }}`
          },
          email: `{{ $json.data.dadosComuns.email }}`
        },
        vinculos: [
          {
            matricula: `{{ $json.data.vinculos[0].matricula }}`,
            nome: `{{ $json.data.vinculos[0].nome }}`,
            cargo: `{{ $json.data.vinculos[0].cargo }}`,
            grupo: `{{ $json.data.vinculos[0].grupo }}`,
            admissao: `{{ $json.data.vinculos[0].admissao }}`,
            nascimento: `{{ $json.data.vinculos[0].nascimento }}`,
            vinculo: `{{ $json.data.vinculos[0].vinculo }}`,
            carga_horaria: `{{ $json.data.vinculos[0].carga_horaria }}`
          },
          {
            matricula: `{{ $json.data.vinculos[1].matricula }}`,
            nome: `{{ $json.data.vinculos[1].nome }}`,
            cargo: `{{ $json.data.vinculos[1].cargo }}`,
            grupo: `{{ $json.data.vinculos[1].grupo }}`,
            admissao: `{{ $json.data.vinculos[1].admissao }}`,
            nascimento: `{{ $json.data.vinculos[1].nascimento }}`,
            vinculo: `{{ $json.data.vinculos[1].vinculo }}`,
            carga_horaria: `{{ $json.data.vinculos[1].carga_horaria }}`
          }
        ]
      };

      const state = {
        prefs: [],
        max: 10,
        modalMode: 'create',
        editingIndex: null,
        protocolo: null,
        printMode: 'print',
        pendingFocusId: null,
        lastPayload: null
      };

      const modalUnidade = new bootstrap.Modal(document.getElementById('modalUnidade'));
      const modalAlerta = new bootstrap.Modal(document.getElementById('modalAlerta'));
      const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));

      async function fillByCEP(cep) {
        if (!isCEP(cep)) return;
        try {
          const clean = onlyDigits(cep);
          const r = await fetch(`https://brasilapi.com.br/api/cep/v2/${clean}`);
          if (!r.ok) return;
          const j = await r.json();
          document.getElementById('logradouro').value = j.street || '';
          document.getElementById('bairro').value = j.neighborhood || '';
          document.getElementById('cidade').value = j.city || '';
          document.getElementById('uf').value = sanitizeUF(j.state);
        } catch (err) {
          console.warn('CEP não encontrado', err);
        }
      }

      function renderPrefs() {
        const tbody = document.getElementById('prefsBody');
        tbody.innerHTML = '';
        state.prefs.sort((a, b) => (Number(a.prioridade) || 999) - (Number(b.prioridade) || 999));
        state.prefs.forEach((row, idx) => {
          const tr = document.createElement('tr');
          if (row.imported) tr.classList.add('table-light');

          const priorityCell = document.createElement('td');
          priorityCell.textContent = row.prioridade || '';

          const distritoCell = document.createElement('td');
          distritoCell.textContent = row.distrito || '';

          const lotacaoCell = document.createElement('td');
          lotacaoCell.textContent = [row.unidade, row.turno, row.regime].filter(Boolean).join(' • ');

          const dataSolicCell = document.createElement('td');
          dataSolicCell.textContent = toBRDate(row.data_solicitacao);

          const dataCredCell = document.createElement('td');
          dataCredCell.textContent = toBRDate(row.data_credenciamento);

          const actionsCell = document.createElement('td');
          actionsCell.className = 'actions-cell text-center';
          const actionsWrapper = document.createElement('div');
          actionsWrapper.className = 'actions-wrapper';

          const viewBtn = document.createElement('button');
          viewBtn.type = 'button';
          viewBtn.className = 'btn btn-sm btn-outline-secondary';
          viewBtn.textContent = 'Visualizar';
          viewBtn.addEventListener('click', () => openModalUnidade('view', idx));

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn btn-sm btn-outline-primary';
          editBtn.textContent = 'Editar';
          editBtn.disabled = !!row.imported;
          editBtn.addEventListener('click', () => {
            if (!row.imported) openModalUnidade('edit', idx);
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn btn-sm btn-outline-danger';
          deleteBtn.textContent = 'Excluir';
          deleteBtn.addEventListener('click', () => {
            state.prefs.splice(idx, 1);
            updateAddBtn();
            renderPrefs();
          });

          actionsWrapper.append(viewBtn, editBtn, deleteBtn);
          actionsCell.append(actionsWrapper);
          tr.append(priorityCell, distritoCell, lotacaoCell, dataSolicCell, dataCredCell, actionsCell);
          tbody.appendChild(tr);
        });
      }

      function updateAddBtn() {
        const btn = document.getElementById('btnAddLinha');
        if (state.prefs.length >= state.max) {
          btn.textContent = 'Limite atingido';
          btn.disabled = true;
        } else {
          btn.textContent = 'Adicionar Unidade';
          btn.disabled = false;
        }
      }

      function mapPreferencias(importedPrefs = []) {
        return importedPrefs.slice(0, state.max).map((item) => ({
          prioridade: item.prioridade,
          distrito: item.distrito,
          unidade: item.unidade || item.lotacao || '',
          turno: item.turno || '',
          regime: item.regime || '',
          data_solicitacao: item.data_solicitacao,
          data_credenciamento: item.data_credenciamento,
          imported: true
        }));
      }

      async function loadUnidades(ds, targetSel, selectedValue = '') {
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>';
        sel.disabled = true;
        const grupo = document.getElementById('grupo').value || null;
        try {
          const data = await postJSON(
            'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/unidades',
            { ds, grupo }
          );
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach((u) => {
            if (u && u.unidade) {
              const option = document.createElement('option');
              option.value = u.unidade;
              option.textContent = u.unidade;
              sel.appendChild(option);
            }
          });
          sel.disabled = false;
          if (selectedValue) sel.value = selectedValue;
        } catch (err) {
          console.error(err);
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadTurnos(unidade, targetSel, ds, selectedValue = '') {
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>';
        sel.disabled = true;
        const grupo = document.getElementById('grupo').value || null;
        try {
          const data = await postJSON(
            'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turnos',
            { unidade, ds, grupo }
          );
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach((t) => {
            if (t && t.turno) {
              const option = document.createElement('option');
              option.value = t.turno;
              option.textContent = t.turno;
              sel.appendChild(option);
            }
          });
          sel.disabled = false;
          if (selectedValue) sel.value = selectedValue;
        } catch (err) {
          console.error(err);
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadRegimes(unidade, targetSel, ds, selectedValue = '') {
        const sel = document.getElementById(targetSel);
        sel.innerHTML = '<option>Carregando...</option>';
        sel.disabled = true;
        const grupo = document.getElementById('grupo').value || null;
        try {
          const data = await postJSON(
            'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/regimes',
            { unidade, ds, grupo }
          );
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach((r) => {
            if (r && r.regime) {
              const option = document.createElement('option');
              option.value = r.regime;
              option.textContent = r.regime;
              sel.appendChild(option);
            }
          });
          sel.disabled = false;
          if (selectedValue) sel.value = selectedValue;
        } catch (err) {
          console.error(err);
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      function safeValue(v) {
        return v && v !== 'undefined' && v !== 'null' ? v : '';
      }

      function fillIdentificacaoFromVinculo(matricula) {
        const vinculo = (BIND.vinculos || []).find((x) => x && x.matricula && x.matricula.toString() === matricula.toString());
        if (!vinculo) return;
        document.getElementById('nome').value = safeValue(vinculo.nome) || document.getElementById('nome').value;
        document.getElementById('nascimento').value = toBRDate(safeValue(vinculo.nascimento)) || document.getElementById('nascimento').value;
        document.getElementById('admissao').value = toBRDate(safeValue(vinculo.admissao));
        document.getElementById('cargo').value = safeValue(vinculo.cargo);
        document.getElementById('grupo').value = safeValue(vinculo.grupo);
        document.getElementById('vinculo').value = safeValue(vinculo.vinculo);
        document.getElementById('carga').value = safeValue(vinculo.carga_horaria || vinculo.carga);
      }

      async function loadPreferenciasByMatricula(matricula) {
        try {
          const data = await postJSON(
            'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2',
            { matricula }
          );
          state.prefs = mapPreferencias(Array.isArray(data) ? data : []);
        } catch (err) {
          console.warn('Não foi possível carregar preferências', err);
          state.prefs = [];
        }
        updateAddBtn();
        renderPrefs();
      }

      function populateMatriculas() {
        const sel = document.getElementById('matricula');
        sel.innerHTML = '';
        const opts = [];
        if (safeValue(BIND.vinculos?.[0]?.matricula)) opts.push(BIND.vinculos[0].matricula);
        if (safeValue(BIND.vinculos?.[1]?.matricula)) opts.push(BIND.vinculos[1].matricula);
        if (!opts.length) {
          sel.innerHTML = '<option disabled selected>Sem matrículas disponíveis</option>';
          sel.disabled = true;
          return;
        }
        sel.insertAdjacentHTML('beforeend', '<option value="" disabled selected>Selecione...</option>');
        opts.forEach((v) => sel.insertAdjacentHTML('beforeend', `<option>${v}</option>`));
      }

      function populateEnderecoContato() {
        const dc = BIND.dadosComuns || {};
        const e = dc.endereco || {};
        const set = (id, val) => {
          const el = document.getElementById(id);
          if (el) el.value = safeValue(val);
        };
        set('cep', e.cep);
        set('logradouro', e.logradouro);
        set('numero', e.numero);
        set('complemento', e.complemento);
        set('bairro', e.bairro);
        set('cidade', e.cidade);
        set('uf', sanitizeUF(e.uf));
        set('whatsapp', dc.whatsapp);
        set('telalt', dc.telalternativo);
        set('email', dc.email);
        const email2 = document.getElementById('email2');
        if (email2) email2.value = '';
      }

      function applyUppercaseBehaviour() {
        document.querySelectorAll('input[type="text"], input:not([data-uppercase="false"])').forEach((input) => {
          if (input.dataset.uppercase === 'false' || input.type === 'email' || input.readOnly) return;
          input.classList.add('uppercase');
          if (input.value) input.value = input.value.toUpperCase();
          input.addEventListener('input', () => {
            const cursor = input.selectionStart;
            input.value = input.value.toUpperCase();
            if (document.activeElement === input && typeof cursor === 'number') {
              input.setSelectionRange(cursor, cursor);
            }
          });
        });
      }

      function applyNumericBehaviour() {
        document.querySelectorAll('[data-numeric="true"]').forEach((input) => {
          input.addEventListener('input', () => {
            const cursor = input.selectionStart;
            input.value = onlyDigits(input.value);
            if (document.activeElement === input && typeof cursor === 'number') {
              const newPos = Math.min(cursor, input.value.length);
              input.setSelectionRange(newPos, newPos);
            }
          });
        });
      }

      function markInvalidField(field) {
        if (!field) return;
        field.classList.add('is-invalid');
        field.setAttribute('aria-invalid', 'true');
      }

      function clearInvalidMarkers() {
        document.querySelectorAll('.is-invalid').forEach((el) => {
          el.classList.remove('is-invalid');
          el.removeAttribute('aria-invalid');
        });
      }

      function validateForm() {
        clearInvalidMarkers();
        const errors = [];
        const requiredFields = Array.from(document.querySelectorAll('[data-required="true"]'));

        requiredFields.forEach((field) => {
          if (field.disabled || field.readOnly) return;
          if (!field.value || !field.value.toString().trim()) {
            errors.push({ fieldId: field.id, message: field.labels?.[0]?.textContent || field.id });
            markInvalidField(field);
          }
        });

        const cepField = document.getElementById('cep');
        if (cepField && cepField.value && onlyDigits(cepField.value).length !== 8) {
          errors.push({ fieldId: 'cep', message: 'CEP deve conter 8 dígitos.' });
          markInvalidField(cepField);
        }

        const whatsappField = document.getElementById('whatsapp');
        if (whatsappField && !ensureWhatsapp(whatsappField.value)) {
          errors.push({ fieldId: 'whatsapp', message: 'Informe o WhatsApp com DDD.' });
          markInvalidField(whatsappField);
        }

        const telAltField = document.getElementById('telalt');
        if (telAltField && telAltField.value) {
          const digits = onlyDigits(telAltField.value);
          if (digits.length < 10 || digits.length > 11) {
            errors.push({ fieldId: 'telalt', message: 'Telefone alternativo deve conter DDD.' });
            markInvalidField(telAltField);
          }
        }

        const email = (document.getElementById('email')?.value || '').trim();
        const email2 = (document.getElementById('email2')?.value || '').trim();
        if (email && email2 && email !== email2) {
          errors.push({ fieldId: 'email2', message: 'Os e-mails devem coincidir.' });
          markInvalidField(document.getElementById('email'));
          markInvalidField(document.getElementById('email2'));
        }

        if (!state.prefs.length) {
          errors.push({ fieldId: 'prefsBody', message: 'Inclua ao menos uma unidade na seleção.' });
        }

        return {
          isValid: errors.length === 0,
          errors
        };
      }

      function resolveFirstInvalidFieldId(errors = []) {
        for (const err of errors) {
          if (!err || !err.fieldId) continue;
          if (err.fieldId === 'prefsBody') {
            return 'btnAddLinha';
          }
          const field = document.getElementById(err.fieldId);
          if (field) {
            return err.fieldId;
          }
        }
        return null;
      }

      function fillResumo(payload) {
        const resumoEl = document.getElementById('resumoSolicitacao');
        const printEl = document.getElementById('printComprovante');
        const protocolo = state.protocolo || `22${Date.now().toString().slice(-5)}`;
        state.protocolo = protocolo;

        const prefsRows = payload.preferencias
          .map(
            (p, index) => `
              <tr>
                <td>${p.prioridade || index + 1}</td>
                <td>${p.distrito || '-'}</td>
                <td>${p.unidade || '-'}</td>
                <td>${p.turno || '-'}</td>
                <td>${p.regime || '-'}</td>
                <td>${toBRDate(p.data_credenciamento) || '-'}</td>
              </tr>
            `
          )
          .join('');

        resumoEl.innerHTML = `
          <div class="resumo-card p-4">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-4">
              <div class="d-flex align-items-center gap-3">
                <img
                  src="https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200"
                  alt="Prefeitura do Recife"
                  class="d-none d-md-block"
                  height="48"
                />
                <div>
                  <span class="text-muted d-block mb-1">Solicitação registrada</span>
                  <h4 class="mb-0">${payload.dadosPessoais.nome || 'Servidor(a)'}</h4>
                  <span class="text-muted small">Matrícula ${payload.matricula || '-'}</span>
                </div>
              </div>
              <div class="text-lg-end">
                <span class="meta-label">Número da solicitação</span>
                <span class="meta-value">${protocolo}</span>
              </div>
            </div>
            <hr class="my-4" />
            <div class="row g-4">
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Cargo</span>
                <span class="meta-value">${payload.dadosPessoais.cargo || '-'}</span>
              </div>
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Grupo</span>
                <span class="meta-value">${payload.dadosPessoais.grupo || '-'}</span>
              </div>
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Distrito atual</span>
                <span class="meta-value">${payload.lotacaoAtual.ds || '-'}</span>
              </div>
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Lotação atual</span>
                <span class="meta-value">${payload.lotacaoAtual.unidade || '-'}</span>
              </div>
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Data de admissão</span>
                <span class="meta-value">${payload.dadosPessoais.admissao || '-'}</span>
              </div>
              <div class="col-12 col-md-6 col-lg-3">
                <span class="meta-label">Última atualização</span>
                <span class="meta-value">${todayBR()}</span>
              </div>
            </div>
            <div class="table-responsive mt-4">
              <table class="table table-sm align-middle resumo-table">
                <thead>
                  <tr>
                    <th>Prioridade</th>
                    <th>Distrito</th>
                    <th>Lotação</th>
                    <th>Horário</th>
                    <th>Regime</th>
                    <th>Credenciamento</th>
                  </tr>
                </thead>
                <tbody>${prefsRows}</tbody>
              </table>
            </div>
          </div>
        `;

        printEl.innerHTML = `
          <div class="receipt-header">
            <div class="brand">
              <img
                src="https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200"
                alt="Prefeitura do Recife"
              />
              <div>
                <strong>PREFEITURA DO RECIFE</strong>
                <span>Secretaria de Saúde (SESAU)</span>
                <span>Portal do Servidor · Mobilidade Interna</span>
              </div>
            </div>
            <div class="protocol">
              <div class="label">Número da solicitação</div>
              <div class="value">${protocolo}</div>
            </div>
          </div>
          <div class="receipt-body">
            <div class="receipt-intro mb-4">
              <h4 class="mb-1">Comprovante de solicitação</h4>
              <p>Solicitação registrada em banco de dados para a matrícula <strong>${payload.matricula || '-'}</strong>.</p>
            </div>
            <div class="receipt-info-grid">
              <div class="receipt-info-item">
                <span class="info-label">Nome do servidor</span>
                <span class="info-value">${payload.dadosPessoais.nome || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">CPF</span>
                <span class="info-value">${payload.dadosPessoais.cpf || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Matrícula</span>
                <span class="info-value">${payload.matricula || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Cargo</span>
                <span class="info-value">${payload.dadosPessoais.cargo || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Grupo</span>
                <span class="info-value">${payload.dadosPessoais.grupo || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Distrito atual</span>
                <span class="info-value">${payload.lotacaoAtual.ds || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Lotação atual</span>
                <span class="info-value">${payload.lotacaoAtual.unidade || '-'}</span>
              </div>
              <div class="receipt-info-item">
                <span class="info-label">Data de emissão</span>
                <span class="info-value">${todayBR()}</span>
              </div>
            </div>
            <table class="receipt-table">
              <thead>
                <tr>
                  <th>Prioridade</th>
                  <th>Distrito</th>
                  <th>Lotação</th>
                  <th>Horário</th>
                  <th>Regime</th>
                  <th>Credenciamento</th>
                </tr>
              </thead>
              <tbody>${prefsRows}</tbody>
            </table>
            <div class="receipt-footer">Documento gerado automaticamente pelo Portal do Servidor - Prefeitura do Recife.</div>
          </div>
        `;
      }

      function openAlertModal(errors) {
        const list = document.getElementById('alertList');
        list.innerHTML = '';
        errors.forEach((err) => {
          const li = document.createElement('li');
          li.textContent = err.message;
          list.appendChild(li);
        });
        state.pendingFocusId = resolveFirstInvalidFieldId(errors);
        modalAlerta.show();
      }

      function openSuccessModal(payload) {
        fillResumo(payload);
        state.lastPayload = payload;
        modalSucesso.show();
      }

      function collectPayload() {
        const cpf = safeValue(BIND?.dadosComuns?.cpf);
        return {
          matricula: document.getElementById('matricula').value || null,
          dadosPessoais: {
            nome: document.getElementById('nome').value || null,
            nascimento: document.getElementById('nascimento').value || null,
            admissao: document.getElementById('admissao').value || null,
            cargo: document.getElementById('cargo').value || null,
            grupo: document.getElementById('grupo').value || null,
            vinculo: document.getElementById('vinculo').value || null,
            carga: document.getElementById('carga').value || null,
            cpf: cpf || null
          },
          endereco: {
            cep: document.getElementById('cep').value || null,
            logradouro: document.getElementById('logradouro').value || null,
            numero: document.getElementById('numero').value || null,
            complemento: document.getElementById('complemento').value || null,
            bairro: document.getElementById('bairro').value || null,
            cidade: document.getElementById('cidade').value || null,
            uf: document.getElementById('uf').value || null,
            whatsapp: document.getElementById('whatsapp').value || null,
            telalternativo: document.getElementById('telalt').value || null,
            email: document.getElementById('email').value || null
          },
          lotacaoAtual: {
            ds: document.getElementById('dsSelect').value || null,
            unidade: document.getElementById('unidadeSelect').value || null,
            turno: document.getElementById('turnoSelect').value || null,
            regime: document.getElementById('regimeSelect').value || null
          },
          preferencias: state.prefs.map((p) => ({
            prioridade: Number(p.prioridade) || null,
            distrito: p.distrito || null,
            unidade: p.unidade || null,
            turno: p.turno || null,
            regime: p.regime || null,
            data_solicitacao: p.data_solicitacao || null,
            data_credenciamento: p.data_credenciamento || null,
            imported: !!p.imported
          }))
        };
      }

      function resetModalUnidade() {
        ['mDs', 'mUnidade', 'mTurno', 'mRegime'].forEach((id) => {
          const el = document.getElementById(id);
          el.value = '';
          if (id !== 'mDs') {
            el.innerHTML = `<option>${id === 'mUnidade' ? 'Selecione o distrito...' : 'Selecione a unidade...'}</option>`;
            el.disabled = true;
          }
          el.disabled = id !== 'mDs';
        });
        document.getElementById('btnModalConfirmar').classList.remove('d-none');
        document.getElementById('btnModalCancelar').textContent = 'Cancelar';
      }

      async function openModalUnidade(mode, index = null) {
        state.modalMode = mode;
        state.editingIndex = index;
        const title = document.getElementById('modalUnidadeTitulo');
        const confirmBtn = document.getElementById('btnModalConfirmar');
        const cancelBtn = document.getElementById('btnModalCancelar');
        resetModalUnidade();

        if (mode === 'create') {
          title.textContent = 'Adicionar unidade';
          confirmBtn.textContent = 'Adicionar';
          confirmBtn.disabled = false;
        } else {
          const pref = state.prefs[index];
          title.textContent = mode === 'edit' ? 'Editar unidade' : 'Visualizar unidade';
          confirmBtn.textContent = mode === 'edit' ? 'Atualizar' : 'Fechar';
          confirmBtn.disabled = mode === 'view';
          if (mode === 'view') confirmBtn.classList.add('d-none');
          if (mode === 'view') cancelBtn.textContent = 'Fechar';

          const ds = pref?.distrito || '';
          const unidade = pref?.unidade || '';
          const turno = pref?.turno || '';
          const regime = pref?.regime || '';
          const dsSelect = document.getElementById('mDs');
          dsSelect.value = ds;

          if (ds) {
            await loadUnidades(ds, 'mUnidade', unidade);
            if (unidade) {
              await loadTurnos(unidade, 'mTurno', ds, turno);
              await loadRegimes(unidade, 'mRegime', ds, regime);
            }
          }

          ['mDs', 'mUnidade', 'mTurno', 'mRegime'].forEach((id) => {
            const el = document.getElementById(id);
            el.disabled = mode === 'view';
          });
        }

        modalUnidade.show();
      }

      function closeModalUnidade() {
        modalUnidade.hide();
      }

      function buildPreferenceFromModal() {
        const ds = document.getElementById('mDs').value;
        const unidade = document.getElementById('mUnidade').value;
        const turno = document.getElementById('mTurno').value;
        const regime = document.getElementById('mRegime').value;
        if (!ds || !unidade || !turno || !regime) return null;
        const nextPriority = state.prefs.reduce((mx, r) => Math.max(mx, Number(r.prioridade) || 0), 0) + 1;
        return {
          prioridade: nextPriority,
          distrito: ds,
          unidade,
          turno,
          regime,
          data_solicitacao: new Date(),
          data_credenciamento: new Date(),
          imported: false
        };
      }

      function updatePreferenceFromModal(index) {
        const ds = document.getElementById('mDs').value;
        const unidade = document.getElementById('mUnidade').value;
        const turno = document.getElementById('mTurno').value;
        const regime = document.getElementById('mRegime').value;
        if (!ds || !unidade || !turno || !regime) return false;
        const pref = state.prefs[index];
        pref.distrito = ds;
        pref.unidade = unidade;
        pref.turno = turno;
        pref.regime = regime;
        if (!pref.data_solicitacao) pref.data_solicitacao = new Date();
        if (!pref.data_credenciamento) pref.data_credenciamento = new Date();
        return true;
      }

      function preparePrintArea() {
        state.printMode = 'print';
        document.body.dataset.printMode = 'print';
        const wrapper = document.getElementById('printWrapper');
        wrapper.classList.remove('d-none');
        setTimeout(() => {
          window.print();
        }, 100);
      }

      function afterPrintCleanup() {
        document.getElementById('printWrapper').classList.add('d-none');
        delete document.body.dataset.printMode;
        state.printMode = 'print';
      }

      async function gerarPdfModal() {
        const triggerButton = document.getElementById('btnSalvarPDF');
        const resumoContainer = document.getElementById('resumoSolicitacao');
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert('Não foi possível gerar o PDF no momento. Tente novamente mais tarde.');
          return;
        }

        try {
          if (triggerButton) triggerButton.setAttribute('aria-busy', 'true');

          const doc = new jsPDF({ unit: 'pt', format: 'a4' });
          if (typeof doc.autoTable !== 'function') {
            alert('Recurso de tabela indisponível para gerar o PDF.');
            return;
          }

          const numero = sanitizeValue(state.protocolo) || '—';
          const table = resumoContainer ? resumoContainer.querySelector('table') : null;

          const headers = table
            ? Array.from(table.querySelectorAll('thead th')).map((th) => th.textContent.trim())
            : [];
          const rows = table
            ? Array.from(table.querySelectorAll('tbody tr')).map((tr) =>
                Array.from(tr.children).map((td) => td.textContent.trim())
              )
            : [];

          const matriculaColIndex = headers.findIndex((label) => /matr[íi]cula/i.test(label));
          const cargoColIndex = headers.findIndex((label) => /cargo/i.test(label));
          const firstRow = rows[0] || [];
          const rawMatriculaFromTable = matriculaColIndex >= 0 ? firstRow[matriculaColIndex] : '';
          const rawCargoFromTable = cargoColIndex >= 0 ? firstRow[cargoColIndex] : '';

          const payload = state.lastPayload || {};
          const matriculaFromPayload = sanitizeValue(payload.matricula);
          const cargoFromPayload = sanitizeValue(payload?.dadosPessoais?.cargo);
          const nomeServidor = sanitizeValue(payload?.dadosPessoais?.nome);
          const cpfServidor = formatCPF(payload?.dadosPessoais?.cpf);
          const cargoServidor = sanitizeValue(rawCargoFromTable) || cargoFromPayload;
          const matricula = sanitizeValue(rawMatriculaFromTable) || matriculaFromPayload;
          const subtitleText = matricula
            ? `Solicitação registrada em banco de dados para a matrícula ${matricula}`
            : 'Solicitação registrada em banco de dados.';
          const dataEmissao = new Date().toLocaleDateString('pt-BR');

          const logoDataUrl = await getComprovanteLogoDataUrl();

          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 36;
          const cardWidth = pageWidth - margin * 2;
          const cardHeight = pageHeight - margin * 2;
          const cardPaddingX = 36;
          const cardPaddingY = 30;
          const headerBandHeight = 120;
          const badgeWidth = 200;
          const badgeHeight = 64;

          const drawCardBase = () => {
            doc.setDrawColor(214, 222, 234);
            doc.setLineWidth(1.2);
            doc.setFillColor(244, 247, 254);
            doc.roundedRect(margin, margin, cardWidth, cardHeight, 18, 18, 'F');
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(margin, margin, cardWidth, cardHeight, 18, 18);
            doc.rect(margin, margin + headerBandHeight, cardWidth, Math.max(cardHeight - headerBandHeight, 0), 'F');
            doc.setFillColor(0, 74, 173);
            doc.roundedRect(margin, margin, cardWidth, headerBandHeight, 18, 18, 'F');

            const contentX = margin + cardPaddingX;
            const contentY = margin + cardPaddingY;

            if (logoDataUrl) {
              doc.addImage(logoDataUrl, 'PNG', contentX, contentY, 120, 38);
            }

            const headerTextX = contentX + (logoDataUrl ? 136 : 0);
            const headerTextY = contentY + 16;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(255, 255, 255);
            doc.text('PREFEITURA DO RECIFE', headerTextX, headerTextY);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Secretaria de Saúde (SESAU)', headerTextX, headerTextY + 20);
            doc.text('Portal do Servidor • Mobilidade Interna', headerTextX, headerTextY + 38);

            const badgeX = margin + cardWidth - cardPaddingX - badgeWidth;
            const badgeY = margin + cardPaddingY;
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 12, 12, 'F');
            doc.setDrawColor(0, 74, 173);
            doc.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 12, 12);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(0, 74, 173);
            doc.text('NÚMERO DA SOLICITAÇÃO', badgeX + 18, badgeY + 24);
            doc.setFontSize(22);
            doc.setTextColor(17, 24, 39);
            doc.text(numero || '—', badgeX + badgeWidth - 18, badgeY + 44, { align: 'right' });
          };

          drawCardBase();

          let currentY = margin + headerBandHeight + 38;
          const contentX = margin + cardPaddingX;
          const contentMaxX = margin + cardWidth - cardPaddingX;

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(20);
          doc.setTextColor(0, 74, 173);
          doc.text('Comprovante de solicitação', contentX, currentY);
          currentY += 28;

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(12);
          doc.setTextColor(55, 65, 81);
          const subtitleLines = doc.splitTextToSize(subtitleText, contentMaxX - contentX);
          subtitleLines.forEach((line) => {
            doc.text(line, contentX, currentY);
            currentY += 18;
          });

          currentY += 6;
          const infoRows = [
            [
              { label: 'Nome do servidor', value: nomeServidor || '—' },
              { label: 'CPF', value: cpfServidor || '—' }
            ],
            [
              { label: 'Matrícula', value: matricula || '—' },
              { label: 'Cargo', value: cargoServidor || '—' }
            ],
            [
              { label: 'Data de emissão', value: dataEmissao },
              null
            ]
          ];

          const columnGap = 16;
          const infoRowHeight = 34;
          const infoColumnWidth = (contentMaxX - contentX - columnGap) / 2;
          infoRows.forEach((rowItems, rowIndex) => {
            rowItems.forEach((item, columnIndex) => {
              if (!item) return;
              const x = contentX + columnIndex * (infoColumnWidth + columnGap);
              const y = currentY + rowIndex * infoRowHeight;
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(11);
              doc.setTextColor(0, 74, 173);
              doc.text(item.label.toUpperCase(), x, y);
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(11);
              doc.setTextColor(31, 41, 55);
              doc.text(item.value || '—', x, y + 16);
            });
          });

          currentY += infoRows.length * infoRowHeight + 18;
          doc.setDrawColor(226, 232, 240);
          doc.setLineWidth(1);
          doc.line(contentX, currentY, contentMaxX, currentY);
          currentY += 24;

          const indicesToRemove = [matriculaColIndex, cargoColIndex].filter((idx) => idx >= 0);
          const pdfHeaders = headers.filter((_, idx) => !indicesToRemove.includes(idx));
          const pdfRows = rows.map((row) => row.filter((_, idx) => !indicesToRemove.includes(idx)));

          let footerBaseY = currentY;
          if (pdfHeaders.length && pdfRows.length) {
            const columnStyles = {};
            pdfHeaders.forEach((header, index) => {
              const key = header.toLowerCase();
              if (key.includes('prioridade')) {
                columnStyles[index] = { halign: 'center', cellWidth: 55 };
              } else if (key.includes('distrito')) {
                columnStyles[index] = { cellWidth: 90 };
              } else if (key.includes('lotação')) {
                columnStyles[index] = { cellWidth: 150 };
              } else if (key.includes('credenciamento')) {
                columnStyles[index] = { halign: 'center', cellWidth: 75 };
              } else if (key.includes('solicitação')) {
                columnStyles[index] = { halign: 'center', cellWidth: 75 };
              }
            });
            doc.autoTable({
              head: [pdfHeaders],
              body: pdfRows,
              startY: currentY,
              theme: 'plain',
              margin: { left: contentX, right: pageWidth - contentMaxX },
              tableWidth: contentMaxX - contentX,
              styles: {
                font: 'helvetica',
                fontSize: 10,
                textColor: [31, 41, 55],
                cellPadding: { top: 6, right: 8, bottom: 6, left: 8 },
                lineWidth: 0.6,
                lineColor: [226, 232, 240],
                overflow: 'linebreak'
              },
              headStyles: {
                fontStyle: 'bold',
                fontSize: 10,
                fillColor: [226, 235, 255],
                textColor: [0, 74, 173],
                halign: 'left',
                cellPadding: { top: 8, right: 8, bottom: 8, left: 8 },
                lineWidth: 0
              },
              alternateRowStyles: {
                fillColor: [248, 250, 255]
              },
              columnStyles,
              pageBreak: 'avoid',
              rowPageBreak: 'avoid'
            });
            footerBaseY = (doc.lastAutoTable && doc.lastAutoTable.finalY) || currentY;
          } else {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(107, 114, 128);
            doc.text('Não há dados para exportar.', contentX, currentY + 12);
            footerBaseY = currentY + 12;
          }

          const footerY = Math.min(pageHeight - margin - 12, footerBaseY + 32);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(107, 114, 128);
          doc.text('Documento gerado automaticamente pelo Portal do Servidor - Prefeitura do Recife.', contentX, footerY);

          const safeNumero = numero && numero !== '—' ? numero.replace(/[^\w-]+/g, '-') : 'detalhes';
          doc.save(`solicitacao-${safeNumero}.pdf`);
        } catch (error) {
          console.error('Erro ao gerar PDF:', error);
          alert('Não foi possível gerar o PDF no momento. Tente novamente mais tarde.');
        } finally {
          if (triggerButton) triggerButton.removeAttribute('aria-busy');
        }
      }

      function initEvents() {
        document.getElementById('cep').addEventListener('change', (e) => fillByCEP(e.target.value));
        document.getElementById('uf').addEventListener('input', (e) => {
          e.target.value = sanitizeUF(e.target.value);
        });

        document.getElementById('dsSelect').addEventListener('change', async (e) => {
          const v = e.target.value;
          const unidadeSelect = document.getElementById('unidadeSelect');
          const turnoSelect = document.getElementById('turnoSelect');
          const regimeSelect = document.getElementById('regimeSelect');
          unidadeSelect.innerHTML = '<option>Selecione o distrito...</option>';
          unidadeSelect.value = '';
          unidadeSelect.disabled = true;
          turnoSelect.innerHTML = '<option>Selecione a unidade...</option>';
          turnoSelect.value = '';
          regimeSelect.innerHTML = '<option>Selecione a unidade...</option>';
          regimeSelect.value = '';
          turnoSelect.disabled = true;
          regimeSelect.disabled = true;
          if (v) {
            await loadUnidades(v, 'unidadeSelect');
            unidadeSelect.disabled = false;
          }
        });
        document.getElementById('unidadeSelect').addEventListener('change', async (e) => {
          const unidade = e.target.value;
          const ds = document.getElementById('dsSelect').value;
          const turnoSelect = document.getElementById('turnoSelect');
          const regimeSelect = document.getElementById('regimeSelect');
          turnoSelect.innerHTML = '<option>Carregando...</option>';
          regimeSelect.innerHTML = '<option>Carregando...</option>';
          if (unidade && ds) {
            await loadTurnos(unidade, 'turnoSelect', ds);
            await loadRegimes(unidade, 'regimeSelect', ds);
          }
        });

        document.getElementById('mDs').addEventListener('change', async (e) => {
          const v = e.target.value;
          const turnoSelect = document.getElementById('mTurno');
          const regimeSelect = document.getElementById('mRegime');
          const unidadeModal = document.getElementById('mUnidade');
          unidadeModal.innerHTML = '<option>Selecione o distrito...</option>';
          unidadeModal.value = '';
          unidadeModal.disabled = true;
          turnoSelect.innerHTML = '<option>Selecione a unidade...</option>';
          turnoSelect.value = '';
          regimeSelect.innerHTML = '<option>Selecione a unidade...</option>';
          regimeSelect.value = '';
          turnoSelect.disabled = true;
          regimeSelect.disabled = true;
          if (v) await loadUnidades(v, 'mUnidade');
        });
        document.getElementById('mUnidade').addEventListener('change', async (e) => {
          const unidade = e.target.value;
          const ds = document.getElementById('mDs').value;
          const turnoSelect = document.getElementById('mTurno');
          const regimeSelect = document.getElementById('mRegime');
          turnoSelect.innerHTML = '<option>Carregando...</option>';
          regimeSelect.innerHTML = '<option>Carregando...</option>';
          if (unidade && ds) {
            await loadTurnos(unidade, 'mTurno', ds);
            await loadRegimes(unidade, 'mRegime', ds);
          }
        });

        document.getElementById('btnAddLinha').addEventListener('click', () => {
          if (state.prefs.length < state.max) openModalUnidade('create');
        });

        document.getElementById('btnModalConfirmar').addEventListener('click', () => {
          if (state.modalMode === 'view') {
            closeModalUnidade();
            return;
          }
          if (state.modalMode === 'edit') {
            if (updatePreferenceFromModal(state.editingIndex)) {
              closeModalUnidade();
              renderPrefs();
            }
            return;
          }
          const pref = buildPreferenceFromModal();
          if (!pref) return;
          state.prefs.push(pref);
          closeModalUnidade();
          updateAddBtn();
          renderPrefs();
        });

        document.getElementById('matricula').addEventListener('change', async (e) => {
          const m = e.target.value;
          if (!m) return;
          fillIdentificacaoFromVinculo(m);
          await loadPreferenciasByMatricula(m);
        });

        document.getElementById('btnEnviar').addEventListener('click', () => {
          const validation = validateForm();
          if (!validation.isValid) {
            openAlertModal(validation.errors);
            return;
          }
          const payload = collectPayload();
          console.log('Payload formulário mobilidade:', payload);
          openSuccessModal(payload);
        });

        document.getElementById('btnSalvarPDF').addEventListener('click', gerarPdfModal);
        document.getElementById('btnImprimir').addEventListener('click', () => {
          preparePrintArea();
        });

        window.addEventListener('afterprint', afterPrintCleanup);

        document.getElementById('modalAlerta').addEventListener('hidden.bs.modal', () => {
          if (!state.pendingFocusId) return;
          const target = document.getElementById(state.pendingFocusId);
          state.pendingFocusId = null;
          if (!target) return;
          if (typeof target.focus === 'function') {
            try {
              target.focus({ preventScroll: true });
            } catch (err) {
              target.focus();
            }
          }
          if (typeof target.scrollIntoView === 'function') {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      }

      function init() {
        populateMatriculas();
        populateEnderecoContato();
        const dc = BIND.dadosComuns || {};
        document.getElementById('nome').value = safeValue(dc.nome);
        document.getElementById('nascimento').value = toBRDate(dc.nascimento);
        applyUppercaseBehaviour();
        applyNumericBehaviour();
        updateAddBtn();
        initEvents();
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
