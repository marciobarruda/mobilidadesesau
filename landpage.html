<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria de Sa√∫de ‚Äî SESAU ‚Ä¢ Portal do Servidor ‚Äî Mobilidade Interna</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #004aad;
        --brand-secondary: #003579;
        --brand-highlight: #00a3ff;
        --surface: #ffffff;
        --surface-strong: #ffffff;
        --border-color: #d6deea;
        --text-strong: #1f2937;
        --text-muted: #4b5563;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", "Roboto", "Open Sans", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.9);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 500;
        margin-bottom: 2.5rem;
        padding: 1.2rem 1.6rem;
        border-radius: 18px;
        background: var(--surface-strong);
        color: var(--text-strong);
        border: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .user-greeting strong {
        color: var(--brand-secondary);
      }

      .card {
        border-radius: 16px;
        overflow: hidden;
        border: none;
      }

      .rounded-4 {
        border-radius: 16px !important;
      }

      .card-programa {
        border: 1px solid rgba(0, 74, 173, 0.08);
        border-radius: 16px;
        background: var(--surface-strong);
        box-shadow: 0 12px 32px rgba(15, 37, 78, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .card-programa:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(15, 37, 78, 0.12);
      }

      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 74, 173, 0.1);
        background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
        padding: 1.5rem 1.5rem 1.2rem;
      }

      .card-programa .card-body {
        padding: 1.5rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
        color: var(--brand-primary);
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 28px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .card-hero .card-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .card-hero .card-tag {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: #004aad;
        text-transform: uppercase;
      }

      .card-hero .card-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #004aad;
        margin: 0;
      }

      .card-hero .card-subtitle {
        font-size: 1rem;
        color: var(--text-muted);
        margin: 0;
      }

      .card-hero .card-list {
        padding-left: 1.1rem;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        color: var(--text-strong);
      }

      .card-hero .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .downloads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }

      .download-card {
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        border-radius: 4px;
        padding: 1.35rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 170px;
      }

      .collapsible-form {
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 16px;
        background: rgba(0, 83, 164, 0.06);
        padding: 1.25rem 1.5rem 0;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }

      .collapsible-form summary {
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        list-style: none;
        font-size: 1.05rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(0, 83, 164, 0.18);
        color: var(--brand-secondary);
      }

      .collapsible-form summary::marker,
      .collapsible-form summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-form summary::after {
        content: "";
        width: 12px;
        height: 12px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg);
        transition: transform 0.2s ease;
        margin-left: 1rem;
      }

      .collapsible-form[open] summary::after {
        transform: rotate(225deg);
      }

      .collapsible-form[open] {
        background: rgba(0, 83, 164, 0.08);
        padding-bottom: 1.5rem;
      }

      .collapsible-form[open] summary {
        margin-bottom: 1rem;
        border-bottom-color: rgba(0, 83, 164, 0.25);
      }

      .minhas-grid {
        margin-top: 1rem;
      }

      .minha-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 14px;
        background: #ffffff;
        box-shadow: 0 10px 24px rgba(0, 45, 98, 0.12);
        position: relative;
        padding: 1.1rem 1.25rem;
      }

      .minha-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        border: 2px solid transparent;
        transition: border-color 0.2s ease;
      }

      .minha-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 34px rgba(0, 45, 98, 0.16);
      }

      .minha-card:hover::after {
        border-color: rgba(0, 163, 255, 0.5);
      }

      .minhas-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .feedback-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(27, 38, 59, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1050;
      }
      .feedback-modal-backdrop.active { display: flex; }
      .feedback-modal {
        background: #ffffff;
        border-radius: 1.25rem;
        max-width: 980px;
        width: 100%;
        max-height: 88vh;
        box-shadow: 0 32px 68px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .feedback-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .modal-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .modal-logo {
        max-height: 52px;
        width: auto;
        flex-shrink: 0;
      }

      .feedback-modal-title {
        font-weight: 700;
        font-size: 1.35rem;
        margin-bottom: 0.35rem;
        color: var(--text-strong);
      }

      .feedback-modal-subtitle {
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .modal-meta {
        background: rgba(0, 83, 164, 0.08);
        border-radius: 14px;
        padding: 0.75rem 1.2rem;
        min-width: 220px;
        text-align: right;
      }

      .modal-meta-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--brand-secondary);
        font-weight: 700;
      }

      .modal-meta-value {
        display: block;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--brand-primary);
        margin-top: 0.25rem;
      }

      .feedback-modal-message {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-strong);
        overflow-y: auto;
        flex: 1;
      }

      .modal-table-wrapper {
        border-radius: 14px;
        border: 1px solid rgba(0, 83, 164, 0.12);
        background: #f8fbff;
        padding: 1rem;
      }

      .modal-table-wrapper table td:first-child {
        font-weight: 700;
        color: var(--brand-secondary);
      }

      .modal-actions {
        margin-top: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 0.75rem;
      }

      .form-feedback {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.45);
        padding: 1.5rem;
        z-index: 1200;
      }

      .form-feedback.active {
        display: flex;
      }

      .form-feedback-dialog {
        position: relative;
        max-width: 420px;
        width: 100%;
        background: #ffffff;
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 22px 50px rgba(15, 37, 78, 0.2);
        border: 1px solid rgba(0, 74, 173, 0.08);
      }

      .form-feedback-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
      }

      .form-feedback-title.alert {
        color: #d92d20;
      }

      .form-feedback-title.success {
        color: #047857;
      }

      .form-feedback-body {
        color: var(--text-strong);
        font-size: 0.98rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .form-feedback-body ul {
        padding-left: 1.2rem;
        margin: 0;
      }

      .form-feedback-body li {
        margin-bottom: 0.35rem;
      }

      .form-feedback-close {
        position: absolute;
        top: 0.6rem;
        right: 0.6rem;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 1.2rem;
        cursor: pointer;
      }

      .form-feedback-close:focus {
        outline: 2px solid var(--brand-primary);
        outline-offset: 2px;
      }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      .btn-primary {
        background-color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-primary:hover,
      .btn-primary:focus {
        background-color: #004bd6;
        border-color: #004bd6;
      }

      .btn-outline-primary {
        color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-outline-primary:hover,
      .btn-outline-primary:focus {
        background-color: rgba(0, 98, 255, 0.08);
        color: #004bd6;
        border-color: #004bd6;
      }

      .btn-soft {
        background-color: #f5f5f5;
        color: var(--text-strong);
        border: 1px solid #e5e7eb;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-soft:hover,
      .btn-soft:focus {
        background-color: #e7e7e7;
        border-color: #d1d5db;
        color: var(--text-strong);
      }

      @media (max-width: 768px) {
        header.site-header { padding: 2.5rem 0 2rem; }
        .badge-open { width: 100%; justify-content: center; }
        .feedback-modal {
          padding: 1.5rem;
          max-height: 90vh;
        }
        .feedback-modal-header {
          flex-direction: column;
          align-items: stretch;
        }
        .modal-header-left {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
        }
        .modal-logo {
          max-height: 42px;
        }
        .modal-meta {
          text-align: left;
        }
      }

      /* Impress√£o apenas do conte√∫do do modal */
      @media print {
        body * { visibility: hidden !important; }
        .feedback-modal, .feedback-modal * { visibility: visible !important; }
        .feedback-modal { position: absolute; inset: 0; box-shadow: none; }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div>
            <span class="badge-open">Portal do Servidor ‚Ä¢ SESAU</span>
            <h1 class="h3 mt-3 mb-2">Mobilidade Interna & Servi√ßos</h1>
            <p class="lead mb-0">Acompanhe solicita√ß√µes, atualize seus dados e acesse orienta√ß√µes. Tudo em um s√≥ lugar, com a cara de Recife.</p>
          </div>
        </div>
      </div>
    </header>

    <main class="container py-4">
      <div class="user-greeting" id="saudacao">Ol√°, <strong>{{ $json.data.dadosComuns.nome }}!</strong> Este √© o seu painel de mobilidade interna.</div>

      <div class="row g-4" id="heroCardsRow">
        <!-- Card 1: Mobilidade Interna -->
        <section class="col-12 col-lg-5 col-xl-4">
          <div class="card card-programa card-hero h-100">
            <div class="card-body">
              <span class="card-tag">MOBILIDADE INTERNA</span>
              <h2 class="card-title">Solicita√ß√£o de Mobilidade (SESAU)</h2>
              <p class="card-subtitle">Fluxo eletr√¥nico para cadastrar e acompanhar pedidos de mobilidade.</p>
              <ul class="card-list">
                <li>Mobilidade interna a pedido, com crit√©rios definidos pela Portaria n¬∫ 127/2023.</li>
                <li>Pedidos registrados exclusivamente no sistema eletr√¥nico oficial.</li>
                <li>Validade de 12 meses, com necessidade de renova√ß√£o antes do vencimento.</li>
              </ul>
              <div class="card-actions">
                <form
                  id="novaSolicitacaoForm"
                  action="https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/f188b0f4-f4c9-455b-8dd9-e800c44b46e2"
                  method="post"
                  target="_blank"
                  class="d-inline"
                >
                  <input type="hidden" name="ds" id="novaSolicitacaoDs" />
                  <input type="hidden" name="grupo" id="novaSolicitacaoGrupo" />
                  <input type="hidden" name="cpf" id="novaSolicitacaoCpf" />
                  <input type="hidden" name="matricula" id="novaSolicitacaoMatricula" value="{{ $json.data.vinculos[0].matricula }}" />
                  <button type="button" class="btn btn-primary" id="btnNovaSolicitacao">Nova solicita√ß√£o</button>
                </form>
                <a class="btn btn-outline-primary" href="#orientacoesContainer">Orienta√ß√µes</a>
              </div>
            </div>
          </div>
        </section>

        <!-- Card 2: Atualiza√ß√£o Cadastral -->
        <section class="col-12 col-lg-7 col-xl-8">
          <div class="card card-programa card-hero h-100">
            <div class="card-body">
              <span class="card-tag">ATUALIZA√á√ÉO CADASTRAL</span>
              <h2 class="card-title">Dados para contato e lota√ß√£o</h2>
              <p class="card-subtitle">Mantenha seus dados atualizados para agilizar an√°lises de mobilidade.</p>
              <details class="collapsible-form" data-default-collapsed="true">
                <summary>Atualizar cadastro</summary>
                <form id="form-cadastro" class="pt-3" novalidate>
                  <div class="row g-3">
                    <!-- Matr√≠cula -->
                    <div class="col-12">
                      <label for="matriculaSelect" class="form-label">Matr√≠cula</label>
                      <select id="matriculaSelect" class="form-select" required></select>
                      <input type="hidden" id="grupoHidden" value="{{ $json.data.vinculos[0].grupo }}" />
                      <input type="hidden" id="cpfHidden" value="{{ $json.data.dadosComuns.cpf }}" />
                      <input type="hidden" id="dsHidden" value="{{ $json.data.vinculos[0].ds }}" />
                      <input type="hidden" id="servidorHidden" value="{{ $json.data.dadosComuns.servidor }}" />
                      <div class="invalid-feedback">Selecione uma matr√≠cula v√°lida.</div>
                    </div>

                    <!-- Contatos -->
                    <div class="col-12 col-md-6">
                      <label for="email" class="form-label">E-mail</label>
                      <input
                        id="email"
                        type="email"
                        class="form-control"
                        placeholder="seu.email@recife.pe.gov.br"
                        autocomplete="email"
                      />
                      <div class="invalid-feedback">Informe um e-mail v√°lido.</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="whatsapp" class="form-label">WhatsApp</label>
                      <input
                        id="whatsapp"
                        class="form-control"
                        placeholder="81999999999"
                        inputmode="numeric"
                        pattern="\d{11}"
                        maxlength="11"
                      />
                      <div class="invalid-feedback">Informe um WhatsApp com 11 d√≠gitos num√©ricos.</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label for="telefonealternativo" class="form-label">Telefone alternativo</label>
                      <input id="telefonealternativo" class="form-control" placeholder="(81) 3333-3333" />
                    </div>

                    <!-- Endere√ßo -->
                    <div class="col-12 col-sm-4">
                      <label for="cep" class="form-label">CEP</label>
                      <input id="cep" class="form-control" placeholder="00000-000" />
                      <div class="invalid-feedback">Informe um CEP v√°lido.</div>
                    </div>
                    <div class="col-12 col-sm-8">
                      <label for="logradouro" class="form-label">Logradouro</label>
                      <input id="logradouro" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-4">
                      <label for="numero" class="form-label">N√∫mero</label>
                      <input id="numero" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-8">
                      <label for="complemento" class="form-label">Complemento</label>
                      <input id="complemento" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-6">
                      <label for="bairro" class="form-label">Bairro</label>
                      <input id="bairro" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-4">
                      <label for="cidade" class="form-label">Cidade</label>
                      <input id="cidade" class="form-control" />
                    </div>
                    <div class="col-12 col-sm-2">
                      <label for="uf" class="form-label">UF</label>
                      <input id="uf" class="form-control" maxlength="2" placeholder="PE" />
                      <div class="invalid-feedback">UF deve ter 2 letras.</div>
                    </div>

                    <!-- DS/Executiva -->
                    <div class="col-12 col-md-4 col-lg-3">
                      <label for="dsSelect" class="form-label">DS/Executiva atual</label>
                      <select id="dsSelect" class="form-select" required>
                        <option value="" selected disabled>Selecione...</option>
                        <option>SEAA - JURIDICO</option>
                        <option>SEAB</option>
                        <option>DS II</option>
                        <option>DS I</option>
                        <option>DS IV</option>
                        <option>SECOGE</option>
                        <option>SEGTES</option>
                        <option>SEAF</option>
                        <option>SEINFRA</option>
                        <option>SEVS</option>
                        <option>DS III</option>
                        <option>DS VII</option>
                        <option>DS VI</option>
                        <option>DS VIII</option>
                        <option>DS V</option>
                        <option>GABINETE SESAU</option>
                        <option>SERMAC</option>
                      </select>
                      <div class="invalid-feedback">Selecione a DS/Executiva.</div>
                    </div>

                    <!-- Unidade/Turno/Regime (din√¢micos) -->
                    <div class="col-12 col-md-8 col-lg-9">
                      <label for="unidadeSelect" class="form-label">Unidade atual</label>
                      <select id="unidadeSelect" class="form-select" disabled>
                        <option>Selecione a DS/Executiva...</option>
                      </select>
                      <div class="invalid-feedback">Selecione a Unidade.</div>
                    </div>
                    <div class="col-12 col-md-8 col-lg-9">
                      <label for="turnoSelect" class="form-label">Turno atual</label>
                      <select id="turnoSelect" class="form-select" disabled>
                        <option>Selecione a Unidade...</option>
                      </select>
                      <div class="invalid-feedback">Selecione o Turno.</div>
                    </div>
                    <div class="col-12 col-md-4 col-lg-3">
                      <label for="regimeSelect" class="form-label">Regime atual</label>
                      <select id="regimeSelect" class="form-select" disabled>
                        <option>Selecione a Unidade...</option>
                      </select>
                      <div class="invalid-feedback">Selecione o Regime.</div>
                    </div>

                    <div class="col-12">
                      <button type="submit" class="btn btn-primary">Enviar atualiza√ß√£o</button>
                      <span class="text-muted ms-2" id="formStatus" aria-live="polite"></span>
                    </div>
                  </div>
                </form>
              </details>
            </div>
          </div>
        </section>

        <!-- Card 3: Minhas Solicita√ß√µes -->
        <section class="col-12">
          <div class="card card-programa">
            <div class="card-header">
              <div class="section-title">Minhas solicita√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="minhasSolicitacoes" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 minhas-grid">
                <!-- Mini cards renderizados via JS -->
              </div>
              <div id="minhasPlaceholder" class="minhas-placeholder mt-3 d-none">Nenhum v√≠nculo encontrado.</div>
            </div>
          </div>
        </section>

        <!-- Card 4: Orienta√ß√µes -->
        <section class="col-12 col-lg-6">
          <div class="card card-programa h-100">
            <div class="card-header">
              <div class="section-title">Orienta√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="orientacoesContainer" class="small text-justify"></div>
            </div>
          </div>
        </section>

        <!-- Card 5: Publica√ß√µes -->
        <section class="col-12 col-lg-6">
          <div class="card card-programa h-100">
            <div class="card-header">
              <div class="section-title">Publica√ß√µes</div>
            </div>
            <div class="card-body">
              <div id="publicacoesLista" class="downloads-grid"></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <footer class="container">
      <div class="d-flex justify-content-between flex-wrap gap-2">
        <div>¬© Prefeitura do Recife ‚Äî Secretaria de Sa√∫de</div>
        <div class="text-end">Portal do Servidor ‚Ä¢ Automa√ß√£o e Servi√ßos</div>
      </div>
    </footer>

    <!-- Modal custom (feedback) -->
    <div id="modalBackdrop" class="feedback-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="feedback-modal">
        <div class="feedback-modal-header">
          <div class="modal-header-left">
            <img
              src="https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200"
              alt="Logo Gest√£o PCR"
              class="modal-logo"
            />
            <div>
              <div class="feedback-modal-title">Comprovante de solicita√ß√£o</div>
              <div class="feedback-modal-subtitle">Solicita√ß√£o registrada em banco de dados para a matr√≠cula <strong>{{ $json.data.vinculos[0].matricula }}</strong></div>
            </div>
          </div>
          <div class="modal-meta">
            <span class="modal-meta-label">N√∫mero da Solicita√ß√£o</span>
            <span class="modal-meta-value" id="modalNumeroSolicitacao">‚Äî</span>
          </div>
        </div>
        <div id="modalBody" class="feedback-modal-message"></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-success" id="btnSalvarPDF">Salvar em PDF</button>
          <button type="button" class="btn btn-primary" id="btnImprimir">Imprimir</button>
          <button type="button" class="btn btn-danger" id="btnFecharModal">Fechar</button>
        </div>
      </div>
    </div>

    <div id="formFeedback" class="form-feedback" aria-hidden="true">
      <div class="form-feedback-dialog" role="alertdialog" aria-modal="true" aria-labelledby="formFeedbackTitle" aria-describedby="formFeedbackBody">
        <button type="button" class="form-feedback-close" id="formFeedbackClose" aria-label="Fechar aviso">√ó</button>
        <div id="formFeedbackTitle" class="form-feedback-title"></div>
        <div id="formFeedbackBody" class="form-feedback-body"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      // ===== Helpers =====
      const postJSON = async (url, body) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        if (!res.ok) throw new Error('Erro de rede');
        return res.json();
      };

      const toBRDate = (iso) => {
        if (!iso) return '';
        const d = new Date(iso);
        if (isNaN(d)) return '';
        return d.toLocaleDateString('pt-BR');
      };

      const setStatus = (msg, ok = true) => {
        const el = document.getElementById('formStatus');
        el.textContent = msg || '';
        el.className = ok ? 'text-success ms-2' : 'text-danger ms-2';
      };

      const sanitizeValue = (val) => {
        if (val === null || val === undefined) return '';
        const str = String(val).trim();
        return str === 'undefined' || str === 'null' ? '' : str;
      };

      const sanitizeUF = (val) => (val || '').toUpperCase().slice(0,2);
      const isUF = (val) => /^[A-Za-z]{2}$/.test(val || '');
      const isCEP = (val) => /^(\d{5}-?\d{3})$/.test(val || '');
      const onlyDigits = (val) => (val || '').replace(/\D+/g, '');
      const normalizeWhats = (val) => onlyDigits(val).slice(0, 11);
      const isWhats = (val) => /^\d{11}$/.test(String(val || '').trim());
      const isEmail = (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(val || '').trim());

      const formatCPF = (value) => {
        const digits = (value || '').replace(/\D+/g, '');
        if (digits.length !== 11) return sanitizeValue(value);
        return digits.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      };

      const markInvalid = (el) => {
        if (!el) return;
        el.classList.add('is-invalid');
        el.classList.remove('is-valid');
      };

      const markValid = (el) => {
        if (!el) return;
        el.classList.remove('is-invalid');
        el.classList.add('is-valid');
      };

      const closeFormFeedback = () => {
        const overlay = document.getElementById('formFeedback');
        if (!overlay) return;
        overlay.classList.remove('active');
        overlay.setAttribute('aria-hidden', 'true');
      };

      const showFormFeedbackPopup = (type, details = {}) => {
        const overlay = document.getElementById('formFeedback');
        const titleEl = document.getElementById('formFeedbackTitle');
        const bodyEl = document.getElementById('formFeedbackBody');
        const missing = Array.isArray(details.missing) ? details.missing : [];
        const invalid = Array.isArray(details.invalid) ? details.invalid : [];
        if (!overlay || !titleEl || !bodyEl) return;
        overlay.classList.add('active');
        overlay.setAttribute('aria-hidden', 'false');

        titleEl.classList.remove('alert', 'success');
        if (type === 'error') {
          titleEl.classList.add('alert');
          titleEl.textContent = '‚ùó Alerta';
          let html = '';
          if (missing.length) {
            html += '<div>Preencha os campos a seguir:</div><ul>';
            missing.forEach((field) => {
              html += `<li>${field}</li>`;
            });
            html += '</ul>';
          }
          if (invalid.length) {
            html += '<div>Corrija os campos com formato inv√°lido:</div><ul>';
            invalid.forEach((field) => {
              html += `<li>${field}</li>`;
            });
            html += '</ul>';
          }
          if (!html) {
            html = '<div>Revise os dados informados antes de enviar novamente.</div>';
          }
          bodyEl.innerHTML = html;
        } else {
          titleEl.classList.add('success');
          titleEl.textContent = '‚úÖ Sucesso';
          bodyEl.innerHTML = `
            <div>Os dados de atualiza√ß√£o foram enviados com sucesso.</div>
            <div>Este registro n√£o configura um pedido de mobilidade: trata-se exclusivamente de uma atualiza√ß√£o cadastral.</div>
          `;
        }

        const closeBtn = document.getElementById('formFeedbackClose');
        if (closeBtn) closeBtn.focus();
      };

      const COMPROVANTE_LOGO_URL = 'https://statics.recife.pe.gov.br/images/dynamics/logo_gestao_pcr.png?w=200';
      let comprovanteLogoDataUrlPromise = null;

      const getComprovanteLogoDataUrl = async () => {
        if (!comprovanteLogoDataUrlPromise) {
          comprovanteLogoDataUrlPromise = fetch(COMPROVANTE_LOGO_URL)
            .then((response) => {
              if (!response.ok) throw new Error('Erro ao carregar logotipo');
              return response.blob();
            })
            .then((blob) => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.onerror = () => reject(new Error('Falha ao converter logotipo'));
              reader.readAsDataURL(blob);
            }))
            .catch(() => null);
        }
        return comprovanteLogoDataUrlPromise;
      };

      // Dados vindos do template (quando presentes)
      const nomeServidorTemplate = sanitizeValue(`{{ $json.data.dadosComuns.servidor }}`);
      const nomeExibicaoTemplate = sanitizeValue(`{{ $json.data.dadosComuns.nome }}`);
      const dadosComunsTemplate = {
        cpf: sanitizeValue(`{{ $json.data.dadosComuns.cpf }}`),
        nome: nomeExibicaoTemplate,
        servidor: nomeServidorTemplate,
        nascimento: sanitizeValue(`{{ $json.data.dadosComuns.nascimento }}`),
        email: sanitizeValue(`{{ $json.data.dadosComuns.email }}`).toLowerCase(),
        whatsapp: sanitizeValue(`{{ $json.data.dadosComuns.whatsapp }}`),
        telalternativo: sanitizeValue(`{{ $json.data.dadosComuns.telalternativo }}`),
        endereco: {
          cep: sanitizeValue(`{{ $json.data.dadosComuns.endereco.cep }}`),
          logradouro: sanitizeValue(`{{ $json.data.dadosComuns.endereco.logradouro }}`),
          numero: sanitizeValue(`{{ $json.data.dadosComuns.endereco.numero }}`),
          complemento: sanitizeValue(`{{ $json.data.dadosComuns.endereco.complemento }}`),
          bairro: sanitizeValue(`{{ $json.data.dadosComuns.endereco.bairro }}`),
          cidade: sanitizeValue(`{{ $json.data.dadosComuns.endereco.cidade }}`),
          uf: sanitizeValue(`{{ $json.data.dadosComuns.endereco.uf }}`)
        }
      };

      const buildVinculoTemplate = (index) => ({
        matricula: sanitizeValue(`{{ $json.data.vinculos[${index}].matricula }}`),
        cargo: sanitizeValue(`{{ $json.data.vinculos[${index}].cargo }}`),
        distrito: sanitizeValue(`{{ $json.data.vinculos[${index}].distrito }}`),
        lotacao: sanitizeValue(`{{ $json.data.vinculos[${index}].lotacao }}`),
        turno: sanitizeValue(`{{ $json.data.vinculos[${index}].turno }}`),
        regime: sanitizeValue(`{{ $json.data.vinculos[${index}].regime }}`),
        admissao: sanitizeValue(`{{ $json.data.vinculos[${index}].admissao }}`),
        carga_horaria: sanitizeValue(`{{ $json.data.vinculos[${index}].carga_horaria }}`),
        grupo: sanitizeValue(`{{ $json.data.vinculos[${index}].grupo }}`),
        vinculo: sanitizeValue(`{{ $json.data.vinculos[${index}].vinculo }}`),
        ds: sanitizeValue(`{{ $json.data.vinculos[${index}].ds }}`)
      });

      const rawVinculosTemplate = [buildVinculoTemplate(0), buildVinculoTemplate(1)];
      const vinculosTemplate = rawVinculosTemplate.filter((vinculo) => {
        const relevante = {
          matricula: vinculo.matricula,
          cargo: vinculo.cargo,
          distrito: vinculo.distrito,
          lotacao: vinculo.lotacao,
          turno: vinculo.turno,
          regime: vinculo.regime,
          admissao: vinculo.admissao,
          carga_horaria: vinculo.carga_horaria,
          grupo: vinculo.grupo,
          vinculo: vinculo.vinculo,
          ds: vinculo.ds
        };
        return Object.values(relevante).some((value) => Boolean(value));
      });

      const DATA = {
        nome: nomeServidorTemplate || nomeExibicaoTemplate,
        servidor: nomeServidorTemplate,
        nomeExibicao: nomeExibicaoTemplate,
        cpf: dadosComunsTemplate.cpf,
        nascimento: dadosComunsTemplate.nascimento,
        dadosComuns: dadosComunsTemplate,
        vinculos: vinculosTemplate,
        contatos: {
          email: dadosComunsTemplate.email,
          whatsapp: dadosComunsTemplate.whatsapp,
          telalternativo: dadosComunsTemplate.telalternativo
        },
        endereco: dadosComunsTemplate.endereco
      };

      const buildNovaSolicitacaoPayload = () => {
        const endereco = dadosComunsTemplate.endereco || {};
        const vinculos = (vinculosTemplate || [])
          .map((v) => ({
            matricula: v.matricula,
            cargo: v.cargo,
            distrito: v.distrito,
            lotacao: v.lotacao,
            turno: v.turno,
            regime: v.regime,
            admissao: v.admissao,
            carga_horaria: v.carga_horaria,
            grupo: v.grupo,
            vinculo: v.vinculo
          }))
          .filter((vinculo) => Object.values(vinculo).some((value) => Boolean(value)));

        return {
          data: {
            dadosComuns: {
              cpf: dadosComunsTemplate.cpf || '',
              nome: dadosComunsTemplate.nome || dadosComunsTemplate.servidor || '',
              servidor: dadosComunsTemplate.servidor || dadosComunsTemplate.nome || '',
              nascimento: dadosComunsTemplate.nascimento || '',
              email: dadosComunsTemplate.email || '',
              whatsapp: dadosComunsTemplate.whatsapp || '',
              endereco: {
                cep: endereco.cep || '',
                logradouro: endereco.logradouro || '',
                numero: endereco.numero || '',
                complemento: endereco.complemento || '',
                bairro: endereco.bairro || '',
                cidade: endereco.cidade || '',
                uf: endereco.uf || ''
              }
            },
            vinculos
          }
        };
      };

      // ===== Inicializa√ß√£o dos campos =====
      function populateMatriculas() {
        const sel = document.getElementById('matriculaSelect');
        sel.innerHTML = '';
        const opts = [];
        const pushVinculoOption = (vinculo) => {
          if (!vinculo) return;
          const value = sanitizeValue(vinculo.matricula);
          if (!value) return;
          opts.push({
            value,
            text: value,
            grupo: sanitizeValue(vinculo.grupo),
            ds: sanitizeValue(vinculo.ds)
          });
        };
        (DATA.vinculos || []).forEach(pushVinculoOption);
        if (opts.length === 0) {
          sel.innerHTML = '<option value="" disabled selected>Sem matr√≠culas dispon√≠veis</option>';
          sel.setAttribute('disabled', 'disabled');
        } else {
          sel.removeAttribute('disabled');
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Selecione...';
          placeholder.disabled = true;
          placeholder.selected = true;
          sel.appendChild(placeholder);
          opts.forEach((optionData) => {
            const option = document.createElement('option');
            option.value = optionData.value;
            option.textContent = optionData.text;
            if (optionData.grupo) option.dataset.grupo = optionData.grupo;
            if (optionData.ds) option.dataset.ds = optionData.ds;
            sel.appendChild(option);
          });
        }
        const hiddenGrupo = document.getElementById('grupoHidden');
        if (hiddenGrupo) {
          const normalizedGrupo = sanitizeValue(hiddenGrupo.value) || (opts[0]?.grupo || '');
          hiddenGrupo.value = normalizedGrupo;
        }
        const hiddenCpf = document.getElementById('cpfHidden');
        if (hiddenCpf) hiddenCpf.value = DATA.cpf;
        const hiddenDs = document.getElementById('dsHidden');
        if (hiddenDs) {
          const normalizedDs = sanitizeValue(hiddenDs.value) || (opts[0]?.ds || '');
          hiddenDs.value = normalizedDs;
        }
        const hiddenMatricula = document.getElementById('novaSolicitacaoMatricula');
        if (hiddenMatricula) {
          const normalizedMatricula = sanitizeValue(hiddenMatricula.value) || (opts[0]?.value || '');
          hiddenMatricula.value = normalizedMatricula;
        }
      }

      function populateContatosEndereco() {
        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v && v !== 'undefined' && v !== 'null') ? v : ''; };
        setVal('email', sanitizeValue(DATA.contatos.email).toLowerCase());
        setVal('whatsapp', normalizeWhats(DATA.contatos.whatsapp));
        setVal('telefonealternativo', DATA.contatos.telalternativo);
        setVal('cep', DATA.endereco.cep);
        setVal('logradouro', DATA.endereco.logradouro);
        setVal('numero', DATA.endereco.numero);
        setVal('complemento', DATA.endereco.complemento);
        setVal('bairro', DATA.endereco.bairro);
        setVal('cidade', DATA.endereco.cidade);
        setVal('uf', sanitizeUF(DATA.endereco.uf));
      }

      function renderMinhasSolicitacoesCards() {
        const wrap = document.getElementById('minhasSolicitacoes');
        const placeholder = document.getElementById('minhasPlaceholder');
        wrap.innerHTML = '';
        const entries = DATA.vinculos.filter(v => v && v.matricula && v.matricula !== 'undefined' && v.matricula.trim() !== '');
        if (entries.length === 0) {
          placeholder.classList.remove('d-none');
          return;
        }
        placeholder.classList.add('d-none');
        entries.forEach((v, idx) => {
          const cargo = (v.cargo && v.cargo !== 'undefined') ? v.cargo : '';
          const card = document.createElement('div');
          card.className = 'col';
          card.innerHTML = `
            <div class="minha-card h-100">
              <div class="fw-bold mb-1">${v.matricula}</div>
              <div class="text-muted small">${cargo}</div>
            </div>
          `;
          card.querySelector('.minha-card').addEventListener('click', () => abrirRevisaoSolicitacao(v.matricula));
          wrap.appendChild(card);
        });
      }

      // ===== Encadeamento DS -> Unidade -> Turno/Regime =====
      async function loadUnidades(ds, grupoFromParam) {
        const sel = document.getElementById('unidadeSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        document.getElementById('turnoSelect').innerHTML = '<option>Selecione a Unidade...</option>';
        document.getElementById('turnoSelect').setAttribute('disabled', 'disabled');
        document.getElementById('regimeSelect').innerHTML = '<option>Selecione a Unidade...</option>';
        document.getElementById('regimeSelect').setAttribute('disabled', 'disabled');
        try {
          const hiddenGrupoInput = document.getElementById('grupoHidden');
          const resolvedGrupo = sanitizeValue(grupoFromParam ?? (hiddenGrupoInput ? hiddenGrupoInput.value : ''));
          const payload = { ds, grupo: resolvedGrupo || null };
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/unidades', payload);
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach(u => {
            if (u && u.unidade) sel.insertAdjacentHTML('beforeend', `<option value="${u.unidade}">${u.unidade}</option>`);
          });
          sel.removeAttribute('disabled');
        } catch (e) {
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadTurnos(unidade) {
        const sel = document.getElementById('turnoSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turnos', { unidade });
          sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          (data || []).forEach(t => { if (t && t.turno) sel.insertAdjacentHTML('beforeend', `<option>${t.turno}</option>`); });
          sel.removeAttribute('disabled');
        } catch (e) {
          sel.innerHTML = '<option>Falha ao carregar</option>';
        }
      }

      async function loadRegimes(unidade) {
        const sel = document.getElementById('regimeSelect');
        sel.innerHTML = '<option>Carregando...</option>';
        sel.setAttribute('disabled', 'disabled');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/regimes', { unidade });
          const regimes = [];
          const pushRegime = (value) => {
            if (!value || value === 'undefined') return;
            regimes.push(value);
          };
          if (Array.isArray(data)) {
            data.forEach(item => {
              if (typeof item === 'string') pushRegime(item);
              else if (item && typeof item === 'object') pushRegime(item.regime || item.nome || item.Regime);
            });
          } else if (data && typeof data === 'object') {
            if (Array.isArray(data.regimes)) data.regimes.forEach(pushRegime);
            if (Array.isArray(data.Regimes)) data.Regimes.forEach(pushRegime);
            if (Array.isArray(data.data)) data.data.forEach(pushRegime);
          }
          if (regimes.length) {
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            regimes.forEach(reg => sel.insertAdjacentHTML('beforeend', `<option>${reg}</option>`));
            sel.removeAttribute('disabled');
          } else {
            sel.innerHTML = '<option>Nenhum regime dispon√≠vel</option>';
          }
        } catch (e) {
          sel.innerHTML = '<option>N√£o foi poss√≠vel carregar os regimes</option>';
        }
      }

      // ===== Minhas Solicita√ß√µes -> Modal =====
      async function abrirRevisaoSolicitacao(matricula) {
        const backdrop = document.getElementById('modalBackdrop');
        const modalBody = document.getElementById('modalBody');
        document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
        modalBody.innerHTML = '<div class="text-muted">Carregando...</div>';
        backdrop.classList.add('active');
        backdrop.setAttribute('aria-hidden', 'false');
        try {
          const data = await postJSON('https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/76b1b27c-408b-4717-b6c8-faed4f07c0a2', { matricula });
          if (!Array.isArray(data) || data.length === 0) {
            modalBody.innerHTML = '<div class="text-danger">Nenhum registro encontrado.</div>';
            return;
          }
          const numeroSolicitacao = data[0]?.protocolo || '';
          document.getElementById('modalNumeroSolicitacao').textContent = numeroSolicitacao || '‚Äî';
          const rows = data.map((it) => `
            <tr>
              <td class="text-center fw-semibold">${it.prioridade ?? ''}</td>
              <td>${it.matricula || ''}</td>
              <td>${it.cargo || ''}</td>
              <td>${it.distrito || ''}</td>
              <td>${it.lotacao || ''}</td>
              <td>${toBRDate(it.data_credenciamento)}</td>
              <td>${toBRDate(it.data_solicitacao)}</td>
            </tr>
          `).join('');
          modalBody.innerHTML = `
            <div class="table-responsive modal-table-wrapper">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th class="text-center">Prioridade</th>
                    <th>Matr√≠cula</th>
                    <th>Cargo</th>
                    <th>Distrito</th>
                    <th>Lota√ß√£o</th>
                    <th>Credenciamento</th>
                    <th>Solicita√ß√£o</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        } catch (e) {
          document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
          modalBody.innerHTML = '<div class="text-danger">Falha ao carregar dados da solicita√ß√£o.</div>';
        }
      }

      async function gerarPdfModal() {
        const triggerButton = document.getElementById('btnSalvarPDF');
        const modalBody = document.getElementById('modalBody');
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) {
          alert('N√£o foi poss√≠vel gerar o PDF no momento. Tente novamente mais tarde.');
          return;
        }

        try {
          if (triggerButton) triggerButton.setAttribute('aria-busy', 'true');

          const doc = new jsPDF({ unit: 'pt', format: 'a4' });
          if (typeof doc.autoTable !== 'function') {
            alert('Recurso de tabela indispon√≠vel para gerar o PDF.');
            return;
          }

          const numero = (document.getElementById('modalNumeroSolicitacao').textContent || '').trim();
          const table = modalBody.querySelector('table');

          const headers = table
            ? Array.from(table.querySelectorAll('thead th')).map((th) => th.textContent.trim())
            : [];
          const rows = table
            ? Array.from(table.querySelectorAll('tbody tr')).map((tr) =>
                Array.from(tr.children).map((td) => td.textContent.trim())
              )
            : [];

          const matriculaColIndex = headers.findIndex((label) => /matr[√≠i]cula/i.test(label));
          const cargoColIndex = headers.findIndex((label) => /cargo/i.test(label));
          const firstRow = rows[0] || [];
          const rawMatriculaFromTable = matriculaColIndex >= 0 ? firstRow[matriculaColIndex] : '';
          const rawCargoFromTable = cargoColIndex >= 0 ? firstRow[cargoColIndex] : '';

          const matriculaHidden = document.getElementById('novaSolicitacaoMatricula');
          const matriculaFromHidden = sanitizeValue(matriculaHidden ? matriculaHidden.value : '');
          const matriculaFromTable = sanitizeValue(rawMatriculaFromTable);
          const matricula = matriculaFromTable || matriculaFromHidden;
          const subtitleText = matricula
            ? `Solicita√ß√£o registrada em banco de dados para a matr√≠cula ${matricula}`
            : 'Solicita√ß√£o registrada em banco de dados.';
          const nomeServidorHiddenEl = document.getElementById('servidorHidden');
          const nomeServidor = sanitizeValue(
            (nomeServidorHiddenEl && nomeServidorHiddenEl.value) || DATA.servidor || DATA.nome
          );
          const cpfServidor = formatCPF(DATA.cpf);
          const cargoFromTable = sanitizeValue(rawCargoFromTable);
          const cargoFromVinculo = (() => {
            const vinculos = Array.isArray(DATA.vinculos) ? DATA.vinculos : [];
            if (matricula) {
              const vinculoEncontrado = vinculos.find(
                (item) => sanitizeValue(item.matricula) === matricula
              );
              if (vinculoEncontrado) return sanitizeValue(vinculoEncontrado.cargo);
            }
            return sanitizeValue(vinculos[0]?.cargo);
          })();
          const cargoServidor = cargoFromTable || cargoFromVinculo;
          const dataEmissao = new Date().toLocaleDateString('pt-BR');

          const logoDataUrl = await getComprovanteLogoDataUrl();

          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 36;
          const cardWidth = pageWidth - margin * 2;
          const cardHeight = pageHeight - margin * 2;
          const cardPaddingX = 36;
          const cardPaddingY = 30;
          const headerBandHeight = 120;
          const badgeWidth = 200;
          const badgeHeight = 64;

          const drawCardBase = () => {
            doc.setDrawColor(214, 222, 234);
            doc.setLineWidth(1.2);
            doc.setFillColor(244, 247, 254);
            doc.roundedRect(margin, margin, cardWidth, cardHeight, 18, 18, 'F');
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(margin, margin, cardWidth, cardHeight, 18, 18);
            doc.rect(margin, margin + headerBandHeight, cardWidth, Math.max(cardHeight - headerBandHeight, 0), 'F');
            doc.setFillColor(0, 74, 173);
            doc.roundedRect(margin, margin, cardWidth, headerBandHeight, 18, 18, 'F');

            const contentX = margin + cardPaddingX;
            const contentY = margin + cardPaddingY;

            if (logoDataUrl) {
              doc.addImage(logoDataUrl, 'PNG', contentX, contentY, 120, 38);
            }

            const headerTextX = contentX + (logoDataUrl ? 136 : 0);
            const headerTextY = contentY + 16;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(13);
            doc.setTextColor(255, 255, 255);
            doc.text('PREFEITURA DO RECIFE', headerTextX, headerTextY);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);
            doc.text('Secretaria de Sa√∫de (SESAU)', headerTextX, headerTextY + 20);
            doc.text('Portal do Servidor ‚Ä¢ Mobilidade Interna', headerTextX, headerTextY + 38);

            const badgeX = margin + cardWidth - cardPaddingX - badgeWidth;
            const badgeY = margin + cardPaddingY;
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 12, 12, 'F');
            doc.setDrawColor(0, 74, 173);
            doc.roundedRect(badgeX, badgeY, badgeWidth, badgeHeight, 12, 12);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(10);
            doc.setTextColor(0, 74, 173);
            doc.text('N√öMERO DA SOLICITA√á√ÉO', badgeX + 18, badgeY + 24);
            doc.setFontSize(22);
            doc.setTextColor(17, 24, 39);
            doc.text(numero || '‚Äî', badgeX + badgeWidth - 18, badgeY + 44, { align: 'right' });
          };

          drawCardBase();

          let currentY = margin + headerBandHeight + 38;
          const contentX = margin + cardPaddingX;
          const contentMaxX = margin + cardWidth - cardPaddingX;

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(20);
          doc.setTextColor(0, 74, 173);
          doc.text('Comprovante de solicita√ß√£o', contentX, currentY);
          currentY += 28;

          doc.setFont('helvetica', 'normal');
          doc.setFontSize(12);
          doc.setTextColor(55, 65, 81);
          const subtitleLines = doc.splitTextToSize(subtitleText, contentMaxX - contentX);
          subtitleLines.forEach((line) => {
            doc.text(line, contentX, currentY);
            currentY += 18;
          });

          currentY += 6;
          const infoRows = [
            [
              { label: 'Nome do servidor', value: nomeServidor || '‚Äî' },
              { label: 'CPF', value: cpfServidor || '‚Äî' }
            ],
            [
              { label: 'Matr√≠cula', value: matricula || '‚Äî' },
              { label: 'Cargo', value: cargoServidor || '‚Äî' }
            ],
            [
              { label: 'Data de emiss√£o', value: dataEmissao },
              null
            ]
          ];

          const columnGap = 16;
          const infoRowHeight = 34;
          const infoColumnWidth = (contentMaxX - contentX - columnGap) / 2;
          infoRows.forEach((rowItems, rowIndex) => {
            rowItems.forEach((item, columnIndex) => {
              if (!item) return;
              const x = contentX + columnIndex * (infoColumnWidth + columnGap);
              const y = currentY + rowIndex * infoRowHeight;
              doc.setFont('helvetica', 'bold');
              doc.setFontSize(11);
              doc.setTextColor(0, 74, 173);
              doc.text(item.label.toUpperCase(), x, y);
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(11);
              doc.setTextColor(31, 41, 55);
              doc.text(item.value || '‚Äî', x, y + 16);
            });
          });

          currentY += infoRows.length * infoRowHeight + 18;
          doc.setDrawColor(226, 232, 240);
          doc.setLineWidth(1);
          doc.line(contentX, currentY, contentMaxX, currentY);
          currentY += 24;

          const indicesToRemove = [matriculaColIndex, cargoColIndex].filter((idx) => idx >= 0);
          const pdfHeaders = headers.filter((_, idx) => !indicesToRemove.includes(idx));
          const pdfRows = rows.map((row) => row.filter((_, idx) => !indicesToRemove.includes(idx)));

          let footerBaseY = currentY;
          if (pdfHeaders.length && pdfRows.length) {
            const columnStyles = {};
            pdfHeaders.forEach((header, index) => {
              const key = header.toLowerCase();
              if (key.includes('prioridade')) {
                columnStyles[index] = { halign: 'center', cellWidth: 55 };
              } else if (key.includes('distrito')) {
                columnStyles[index] = { cellWidth: 90 };
              } else if (key.includes('lota√ß√£o')) {
                columnStyles[index] = { cellWidth: 150 };
              } else if (key.includes('credenciamento')) {
                columnStyles[index] = { halign: 'center', cellWidth: 75 };
              } else if (key.includes('solicita√ß√£o')) {
                columnStyles[index] = { halign: 'center', cellWidth: 75 };
              }
            });
            doc.autoTable({
              head: [pdfHeaders],
              body: pdfRows,
              startY: currentY,
              theme: 'plain',
              margin: { left: contentX, right: pageWidth - contentMaxX },
              tableWidth: contentMaxX - contentX,
              styles: {
                font: 'helvetica',
                fontSize: 10,
                textColor: [31, 41, 55],
                cellPadding: { top: 6, right: 8, bottom: 6, left: 8 },
                lineWidth: 0.6,
                lineColor: [226, 232, 240],
                overflow: 'linebreak'
              },
              headStyles: {
                fontStyle: 'bold',
                fontSize: 10,
                fillColor: [226, 235, 255],
                textColor: [0, 74, 173],
                halign: 'left',
                cellPadding: { top: 8, right: 8, bottom: 8, left: 8 },
                lineWidth: 0,
              },
              alternateRowStyles: {
                fillColor: [248, 250, 255],
              },
              columnStyles,
              pageBreak: 'avoid',
              rowPageBreak: 'avoid',
            });
            footerBaseY = (doc.lastAutoTable && doc.lastAutoTable.finalY) || currentY;
          } else {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.setTextColor(107, 114, 128);
            doc.text('N√£o h√° dados para exportar.', contentX, currentY + 12);
            footerBaseY = currentY + 12;
          }

          const footerY = Math.min(pageHeight - margin - 12, footerBaseY + 32);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(107, 114, 128);
          doc.text('Documento gerado automaticamente pelo Portal do Servidor - Prefeitura do Recife.', contentX, footerY);

          const safeNumero = numero && numero !== '‚Äî' ? numero.replace(/[^\w-]+/g, '-') : 'detalhes';
          doc.save(`solicitacao-${safeNumero}.pdf`);
        } catch (error) {
          console.error('Erro ao gerar PDF:', error);
          alert('N√£o foi poss√≠vel gerar o PDF no momento. Tente novamente mais tarde.');
        } finally {
          if (triggerButton) triggerButton.removeAttribute('aria-busy');
        }
      }

      function fecharModal() {
        const backdrop = document.getElementById('modalBackdrop');
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = '';
        backdrop.classList.remove('active');
        backdrop.setAttribute('aria-hidden', 'true');
        document.getElementById('modalNumeroSolicitacao').textContent = '‚Äî';
      }

      // ===== Orienta√ß√µes (TXT) =====
      function renderOrientacoes(texto) {
        const el = document.getElementById('orientacoesContainer');
        if (!texto) { el.textContent = 'Conte√∫do indispon√≠vel.'; return; }
        const parts = String(texto).split(/\n\n+/).map(p => `<p class="mb-2">${p.replace(/\n/g, '<br>')}</p>`);
        el.innerHTML = parts.join('');
      }

      // ===== Publica√ß√µes =====
      function renderPublicacoes(list) {
        const wrap = document.getElementById('publicacoesLista');
        wrap.innerHTML = '';
        (list || []).forEach((pub) => {
          const titulo = pub.titulo || 'Sem t√≠tulo';
          const descricao = pub.descricao || '';
          const url = pub.url || '#';
          const item = document.createElement('div');
          item.className = 'download-card';
          item.innerHTML = `
            <div class="fw-semibold"><a href="${url}" target="_blank" rel="noopener">${titulo}</a></div>
            <div class="text-muted small">${descricao}</div>
          `;
          wrap.appendChild(item);
        });
        if (!wrap.children.length) {
          wrap.innerHTML = '<div class="text-muted">Nenhuma publica√ß√£o dispon√≠vel.</div>';
        }
      }

      // ===== Valida√ß√£o simples do formul√°rio =====
      function validarFormulario() {
        const requiredFields = [
          { id: 'matriculaSelect', label: 'Matr√≠cula' },
          { id: 'email', label: 'E-mail' },
          { id: 'whatsapp', label: 'WhatsApp' },
          { id: 'cep', label: 'CEP' },
          { id: 'logradouro', label: 'Logradouro' },
          { id: 'numero', label: 'N√∫mero' },
          { id: 'complemento', label: 'Complemento' },
          { id: 'bairro', label: 'Bairro' },
          { id: 'cidade', label: 'Cidade' },
          { id: 'uf', label: 'UF' },
          { id: 'dsSelect', label: 'DS/Executiva atual' },
          { id: 'unidadeSelect', label: 'Unidade atual' },
          { id: 'turnoSelect', label: 'Turno atual' },
          { id: 'regimeSelect', label: 'Regime atual' }
        ];

        const missing = [];
        const invalid = [];

        requiredFields.forEach((field) => {
          const el = document.getElementById(field.id);
          if (!el) return;
          const rawValue = el.value != null ? String(el.value).trim() : '';
          let hasValue = rawValue !== '';
          if (el.tagName === 'SELECT') {
            const selectedOption = el.selectedOptions[0];
            hasValue = Boolean(selectedOption && !selectedOption.disabled && sanitizeValue(selectedOption.value));
          }
          if (!hasValue) {
            missing.push(field.label);
            markInvalid(el);
          } else {
            markValid(el);
          }
        });

        const emailEl = document.getElementById('email');
        if (emailEl) {
          const emailVal = sanitizeValue(emailEl.value);
          emailEl.value = emailVal;
          if (emailVal && !isEmail(emailVal)) {
            invalid.push('E-mail (formato inv√°lido)');
            markInvalid(emailEl);
          } else if (emailVal) {
            markValid(emailEl);
          }
        }

        const whatsappEl = document.getElementById('whatsapp');
        if (whatsappEl) {
          const trimmed = sanitizeValue(whatsappEl.value);
          const normalized = normalizeWhats(trimmed);
          whatsappEl.value = normalized;
          if (trimmed && !normalized) {
            invalid.push('WhatsApp (utilize apenas n√∫meros)');
            markInvalid(whatsappEl);
          } else if (normalized && !isWhats(normalized)) {
            invalid.push('WhatsApp (informe 11 d√≠gitos num√©ricos)');
            markInvalid(whatsappEl);
          } else if (normalized) {
            markValid(whatsappEl);
          }
        }

        const cepEl = document.getElementById('cep');
        if (cepEl && sanitizeValue(cepEl.value) && !isCEP(cepEl.value)) {
          invalid.push('CEP (formato inv√°lido)');
          markInvalid(cepEl);
        }

        const ufEl = document.getElementById('uf');
        if (ufEl) {
          ufEl.value = sanitizeUF(ufEl.value);
          if (sanitizeValue(ufEl.value) && !isUF(ufEl.value)) {
            invalid.push('UF (utilize duas letras)');
            markInvalid(ufEl);
          }
        }

        const ok = missing.length === 0 && invalid.length === 0;
        return { ok, missing, invalid };
      }

      // ===== Eventos =====
      const whatsappInput = document.getElementById('whatsapp');
      if (whatsappInput) {
        whatsappInput.addEventListener('input', (event) => {
          const digits = normalizeWhats(event.target.value);
          event.target.value = digits;
        });
      }

      document.getElementById('dsSelect').addEventListener('change', (e) => {
        const v = e.target.value;
        if (v) {
          const grupoAtual = sanitizeValue(document.getElementById('grupoHidden')?.value || '');
          loadUnidades(v, grupoAtual);
        }
        const hiddenDs = document.getElementById('dsHidden');
        if (hiddenDs) hiddenDs.value = sanitizeValue(v);
      });

      document.getElementById('matriculaSelect').addEventListener('change', (e) => {
        const selected = e.target.selectedOptions[0];
        const grupoSelecionado = selected ? sanitizeValue(selected.dataset.grupo || '') : '';
        const hiddenGrupo = document.getElementById('grupoHidden');
        if (hiddenGrupo) hiddenGrupo.value = grupoSelecionado;
        const hiddenDs = document.getElementById('dsHidden');
        if (hiddenDs && selected) hiddenDs.value = sanitizeValue(selected.dataset.ds || hiddenDs.value || '');
        const hiddenMatricula = document.getElementById('novaSolicitacaoMatricula');
        if (hiddenMatricula && selected) hiddenMatricula.value = sanitizeValue(selected.value || hiddenMatricula.value || '');
        const dsAtual = document.getElementById('dsSelect').value;
        if (dsAtual) loadUnidades(dsAtual, grupoSelecionado);
      });

      document.getElementById('unidadeSelect').addEventListener('change', (e) => {
        const unidade = e.target.value;
        if (unidade) {
          loadTurnos(unidade);
          loadRegimes(unidade);
        }
      });

      document.getElementById('form-cadastro').addEventListener('submit', (e) => {
        e.preventDefault();
        const validation = validarFormulario();
        if (!validation.ok) {
          setStatus('Revise os campos destacados.', false);
          showFormFeedbackPopup('error', validation);
          return;
        }
        const grupoAtual = sanitizeValue(document.getElementById('grupoHidden')?.value || '');
        const payload = {
          matricula: document.getElementById('matriculaSelect').value || null,
          email: (sanitizeValue(document.getElementById('email')?.value || '').toLowerCase()) || null,
          whatsapp: normalizeWhats(document.getElementById('whatsapp').value || '') || null,
          telefonealternativo: sanitizeValue(document.getElementById('telefonealternativo')?.value || '') || null,
          endereco: {
            cep: document.getElementById('cep').value || null,
            logradouro: document.getElementById('logradouro').value || null,
            numero: document.getElementById('numero').value || null,
            complemento: document.getElementById('complemento').value || null,
            bairro: document.getElementById('bairro').value || null,
            cidade: document.getElementById('cidade').value || null,
            uf: document.getElementById('uf').value || null,
          },
          ds: document.getElementById('dsSelect').value || null,
          unidade: document.getElementById('unidadeSelect').value || null,
          turno: document.getElementById('turnoSelect').value || null,
          regime: document.getElementById('regimeSelect').value || null,
          grupo: grupoAtual || null,
        };
        console.log('Payload atualiza√ß√£o cadastral:', payload);
        setStatus('Dados de atualiza√ß√£o enviados.', true);
        showFormFeedbackPopup('success');
      });

      async function enviarNovaSolicitacao() {
        const form = document.getElementById('novaSolicitacaoForm');
        const button = document.getElementById('btnNovaSolicitacao');
        if (!form || !button) return;
        button.setAttribute('disabled', 'disabled');
        button.setAttribute('aria-busy', 'true');
        setStatus('Enviando nova solicita√ß√£o...', true);
        try {
          const payload = buildNovaSolicitacaoPayload();
          console.log('Payload nova solicita√ß√£o:', payload);
          const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          setStatus('Nova solicita√ß√£o enviada com sucesso.', true);
          const responseText = await response.text();
          if (responseText) console.log('Resposta nova solicita√ß√£o:', responseText);
        } catch (error) {
          console.error('Erro ao enviar nova solicita√ß√£o:', error);
          setStatus('N√£o foi poss√≠vel enviar a nova solicita√ß√£o.', false);
        } finally {
          button.removeAttribute('disabled');
          button.removeAttribute('aria-busy');
        }
      }

      document.getElementById('btnNovaSolicitacao').addEventListener('click', enviarNovaSolicitacao);

      document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
      document.getElementById('btnImprimir').addEventListener('click', () => window.print());
      document.getElementById('btnSalvarPDF').addEventListener('click', gerarPdfModal);
      document.getElementById('modalBackdrop').addEventListener('click', (e) => { if (e.target.id === 'modalBackdrop') fecharModal(); });
      document.getElementById('formFeedbackClose').addEventListener('click', closeFormFeedback);
      document.getElementById('formFeedback').addEventListener('click', (e) => {
        if (e.target && e.target.id === 'formFeedback') closeFormFeedback();
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeFormFeedback();
      });

      // ===== Bootstrap inicial =====
      (function init() {
        populateMatriculas();
        populateContatosEndereco();
        renderMinhasSolicitacoesCards();
        document.querySelectorAll('.collapsible-form').forEach((details) => {
          details.open = false;
        });
        // Orienta√ß√µes: use window.ORIENTACOES_TXT = '...'; em produ√ß√£o
        if (window.ORIENTACOES_TXT) renderOrientacoes(window.ORIENTACOES_TXT);
        else renderOrientacoes('Carregaremos aqui as orienta√ß√µes do processo.');
        // Publica√ß√µes: use window.PUBLICACOES = [{titulo, descricao, url}, ...]; em produ√ß√£o
        renderPublicacoes(window.PUBLICACOES || []);
      })();
    </script>
  </body>
</html>
